<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CogniNote Pro - 智能记事本</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 紧急修复脚本 - 必须在其他脚本之前加载 -->
    <script src="config/emergency-fix.js?v=1"></script>
    <!-- Supabase 配置 -->
    <script src="config/supabase.js?v=8"></script>
    <!-- Supabase 优化配置 -->
    <script src="config/supabase-optimized.js?v=1"></script>
    <!-- 数据库操作 -->
    <script src="utils/database.js?v=1"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #6366F1;
            --secondary-color: #8B5CF6;
            --accent-color: #EC4899;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            
            --bg-primary: #FAFBFC;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F8FAFC;
            --bg-card: #FFFFFF;
            --bg-hover: #F1F5F9;
            
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-tertiary: #94A3B8;
            --text-inverse: #FFFFFF;
            
            --border-light: #E2E8F0;
            --border-medium: #CBD5E1;
            --border-dark: #94A3B8;
            
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --gradient: linear-gradient(135deg, #6366F1 0%, #8B5CF6 50%, #EC4899 100%);
            --success-gradient: linear-gradient(135deg, #10B981 0%, #34D399 100%);
            --warning-gradient: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
            --error-gradient: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }
        
        /* 深色模式 */
        [data-theme="dark"] {
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --bg-card: #1E293B;
            --bg-hover: #334155;
            
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-tertiary: #64748B;
            
            --border-light: #334155;
            --border-medium: #475569;
            --border-dark: #64748B;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            overflow-x: hidden;
        }
        
        /* 应用容器 */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 页面切换 */
        .page {
            display: none;
            flex: 1;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 顶部导航栏 */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-light);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .navbar {
            background: rgba(30, 41, 59, 0.8);
        }
        
        .navbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            gap: var(--space-sm);
            text-decoration: none;
            cursor: pointer;
        }
        
        .logo i {
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.75rem;
        }
        
        .nav-menu {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .nav-item.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            box-shadow: var(--shadow-md);
        }
        
        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
            margin: 0 var(--space-xl);
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-md) var(--space-md) 3rem;
            border: 1.5px solid var(--border-light);
            border-radius: var(--radius-xl);
            font-size: 0.95rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }
        
        .navbar-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-hover);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: var(--primary-color);
            color: var(--text-inverse);
            transform: translateY(-2px);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* 用户菜单样式 */
        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }
        
        .user-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .user-menu-item:hover {
            background: var(--bg-hover);
        }
        
        .user-menu-item i {
            width: 16px;
            color: var(--text-secondary);
        }
        
        .user-menu-divider {
            height: 1px;
            background: var(--border-light);
            margin: 4px 0;
        }
        
        .theme-toggle {
            background: var(--bg-hover);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-xs);
            display: flex;
        }
        
        .theme-btn {
            padding: var(--space-xs) var(--space-sm);
            border: none;
            background: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        
        .theme-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-xl);
            width: 100%;
        }
        
        .page-header {
            padding: var(--space-xl) 0 var(--space-lg) 0;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: var(--space-xl);
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-color);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .card-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }
        
        .grid {
            display: grid;
            gap: var(--space-xl);
        }
        
        .grid-auto { 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
        }

        /* 首页新布局样式 */
        .dashboard-tabs {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--space-md);
        }

        .dashboard-tab {
            background: none;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
        }

        .dashboard-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .dashboard-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .dashboard-content {
            min-height: 400px;
        }

        .dashboard-view {
            display: none;
        }

        .dashboard-view.active {
            display: block;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
        }

        .note-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .note-card:hover::before {
            opacity: 1;
        }

        /* 演示笔记样式 */
        .note-card.demo-note {
            border: 1px dashed var(--border-light);
            opacity: 0.8;
        }

        .note-card.demo-note::before {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
        }

        .note-card.demo-note:hover {
            opacity: 1;
        }

        .demo-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* 演示数据提示条 */
        .demo-notice {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border: 1px solid #bbdefb;
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            animation: slideDown 0.3s ease-out;
        }

        .demo-notice-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            color: #1565c0;
        }

        .demo-notice-content i {
            font-size: 1.2rem;
            color: #1976d2;
        }

        .demo-notice-content span {
            flex: 1;
            font-size: 0.95rem;
        }

        .demo-notice-content .btn {
            margin-left: auto;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 内容概览区域的卡片样式统一 */
        #dashboard .note-card {
            border: 1px solid var(--border-light);
        }

        #dashboard .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #dashboard .note-card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
        }

        #dashboard .note-card:hover::before {
            opacity: 1;
        }

        /* 卡片按钮样式 */
        .card-action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.8rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        /* 优先级样式 */
        .priority-high {
            color: #ef4444 !important;
            font-weight: 600;
        }

        .priority-medium {
            color: #f59e0b !important;
            font-weight: 600;
        }

        .priority-low {
            color: #10b981 !important;
            font-weight: 600;
        }

        .note-card-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .note-card-preview {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: var(--space-sm);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .note-card-tags {
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
        }

        .note-tag {
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background: var(--gradient);
            color: var(--text-inverse);
            border-color: transparent;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-light);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--primary-color);
        }
        
        .btn-sm {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.875rem;
        }
        
        /* 编辑器样式 */
        .editor-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .editor-sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
        }
        
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
        }
        
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }
        
        .sidebar-section {
            margin-bottom: var(--space-xl);
        }
        
        .sidebar-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-md);
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: var(--space-xs);
            cursor: pointer;
        }
        
        .sidebar-item:hover {
            background: var(--bg-hover);
            color: var(--primary-color);
        }
        
        .sidebar-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .sidebar-item-icon {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-item-count {
            margin-left: auto;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
        }
        
        .sidebar-item.active .sidebar-item-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        /* 笔记编辑器样式优化 */
        .note-editor {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .note-editor.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        
        .editor-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .editor-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .editor-header .btn {
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .editor-header .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-light);
        }
        
        .editor-header .btn-secondary:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        .editor-header .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .editor-header .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }
        
        .editor-header .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }
        
        .editor-header .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .editor-header .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        .editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .editor-title {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.2;
            padding: 0.5rem 0;
            transition: all 0.2s ease;
        }
        
        .editor-title:focus {
            outline: none;
            color: var(--primary-color);
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }
        
        .editor-title::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }
        
        .editor-textarea {
            flex: 1;
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.125rem;
            line-height: 1.75;
            color: var(--text-primary);
            resize: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 0;
            overflow-y: auto;
            transition: all 0.2s ease;
        }
        
        .editor-textarea:focus {
            outline: none;
            color: var(--text-primary);
        }
        
        .editor-textarea::placeholder {
            color: var(--text-tertiary);
            font-style: italic;
        }
        
        .editor-footer {
            padding: 1rem 2rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-status {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }
        
        .editor-status span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        #save-status {
            color: var(--success-color);
            font-weight: 500;
        }
        
        #word-count {
             color: var(--text-secondary);
         }
         
         .editor-tools {
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }
         
         .editor-tools .btn {
             padding: 0.375rem 0.75rem;
             border-radius: var(--radius-sm);
             font-size: 0.8rem;
             background: var(--bg-tertiary);
             color: var(--text-secondary);
             border: 1px solid var(--border-light);
             transition: all 0.2s ease;
         }
         
         .editor-tools .btn:hover {
             background: var(--primary-color);
             color: white;
             border-color: var(--primary-color);
             transform: translateY(-1px);
         }
         
         .editor-header .btn span {
             margin-left: 0.5rem;
         }
         
         .editor-header .btn-secondary:hover {
             background: var(--bg-secondary);
             color: var(--text-primary);
             transform: translateY(-1px);
         }
         
         /* 删除按钮特殊样式 */
         #delete-btn:hover {
             background: #ef4444 !important;
             color: white !important;
             border-color: #ef4444 !important;
         }
         
         /* 收藏按钮激活状态 */
         #favorite-btn.active {
             background: #fbbf24;
             color: white;
             border-color: #fbbf24;
         }
         
         #favorite-btn.active:hover {
             background: #f59e0b;
             border-color: #f59e0b;
         }
         
         /* 响应式设计 */
         @media (max-width: 768px) {
             .note-editor {
                 margin: 0;
                 border-radius: 0;
                 height: 100vh;
                 max-height: 100vh;
             }
             
             .editor-header {
                 padding: 12px 16px;
                 flex-wrap: wrap;
                 gap: 8px;
             }
             
             .editor-header h3 {
                 font-size: 16px;
                 margin: 0;
                 flex: 1;
                 min-width: 120px;
             }
             
             .editor-header .btn {
                 padding: 6px 12px;
                 font-size: 12px;
                 min-width: auto;
             }
             
             .editor-content {
                 padding: 16px;
             }
             
             .editor-title {
                 font-size: 18px;
                 padding: 12px 16px;
             }
             
             .editor-textarea {
                 font-size: 16px;
                 line-height: 1.5;
                 padding: 16px;
                 min-height: calc(100vh - 200px);
             }
             
             .editor-footer {
                 padding: 12px 16px;
                 flex-direction: column;
                 gap: 8px;
                 align-items: stretch;
             }
             
             .editor-status {
                 justify-content: space-between;
                 margin-bottom: 8px;
             }
             
             .editor-tools {
                 justify-content: center;
             }
             
             .editor-tools .btn {
                 padding: 8px 12px;
                 font-size: 12px;
                 flex: 1;
                 max-width: 80px;
             }
         }
         
         @media (max-width: 480px) {
             .editor-header {
                 padding: 10px 12px;
             }
             
             .editor-header .btn {
                 padding: 4px 8px;
                 font-size: 11px;
             }
             
             .editor-content {
                 padding: 12px;
             }
             
             .editor-title {
                 font-size: 16px;
                 padding: 10px 12px;
             }
             
             .editor-textarea {
                 font-size: 15px;
                 padding: 12px;
                 min-height: calc(100vh - 180px);
             }
             
             .editor-footer {
                 padding: 10px 12px;
             }
             
             .editor-tools .btn {
                 padding: 6px 8px;
                 font-size: 11px;
                 min-width: 60px;
             }
         }
        
        .editor-toolbar {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            padding: var(--space-md) var(--space-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-tools {
            display: flex;
            gap: var(--space-sm);
        }
        
        .editor-tool {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .editor-tool:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .editor-status {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }
        
        /* 项目卡片 */
        .project-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .project-card:hover::before {
            opacity: 1;
        }
        
        .project-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
        }
        
        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .project-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .project-progress {
            margin: var(--space-lg) 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-xl);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: var(--radius-xl);
            transition: width 0.3s ease;
        }
        
        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            min-width: 300px;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
        }
        
        .notification-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
        }
        
        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .notification-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1.25rem;
        }
        
        .notification-content {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        .notification.success .notification-icon {
            background: var(--success-color);
        }
        
        .notification.warning .notification-icon {
            background: var(--warning-color);
        }
        
        .notification.error .notification-icon {
            background: var(--error-color);
        }
        
        .notification.info .notification-icon {
            background: var(--info-color);
        }
        
        /* 登录成功特殊样式 */
        .notification.login-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border: 1px solid #10B981;
            color: white;
            animation: loginSuccessSlide 0.5s ease-out;
        }
        
        .notification.login-success .notification-title,
        .notification.login-success .notification-content {
            color: white;
        }
        
        .notification.login-success .notification-icon {
            background: rgba(255, 255, 255, 0.2);
            animation: loginSuccessPulse 1s ease-in-out;
        }
        
        .notification.login-success .notification-close {
            color: rgba(255, 255, 255, 0.8);
        }
        
        @keyframes loginSuccessSlide {
            0% {
                transform: translateX(400px) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translateX(-20px) scale(1.05);
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes loginSuccessPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        /* 笔记列表 */
        .note-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .note-item {
            padding: var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .note-item:hover {
            background: var(--bg-hover);
            border-color: var(--primary-color);
        }
        
        .note-item.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .note-item-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }
        
        .note-item-preview {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .note-item.active .note-item-preview {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .note-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-sm);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .note-item.active .note-item-meta {
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 项目看板 */
        .kanban-board {
            display: flex;
            gap: var(--space-lg);
            overflow-x: auto;
            padding: var(--space-lg);
            min-height: 500px;
        }
        
        .kanban-column {
            min-width: 300px;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid var(--border-light);
        }
        
        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-lg);
        }
        
        .column-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .column-count {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
        }
        
        .task-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .task-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .task-title {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--text-primary);
        }
        
        .task-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
            line-height: 1.4;
        }
        
        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .add-task-btn {
            width: 100%;
            padding: var(--space-md);
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: var(--space-md);
        }
        
        .add-task-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }
        
        /* 项目管理页面样式 */
        .project-content {
            position: relative;
        }
        
        .project-view {
            display: none;
        }
        
        .project-view.active {
            display: block;
        }
        
        .project-section {
            margin-bottom: var(--space-xl);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .featured-projects {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .featured-project-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .featured-project-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .featured-project-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .featured-project-card:hover::before {
            opacity: 1;
        }
        
        .featured-project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }
        
        .featured-project-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .featured-project-description {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: var(--space-lg);
        }
        
        .featured-project-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            align-items: center;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
        }
        
        .priority-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            gap: 4px;
        }
        
        .team-info {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            gap: 4px;
        }
        
        .deadline-info {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            color: var(--text-secondary);
            gap: 4px;
        }
        
        .deadline-info.urgent {
            background: #fff3cd;
            color: #856404;
        }
        
        .deadline-info.overdue {
            background: #f8d7da;
            color: #721c24;
        }
        
        .featured-project-stats {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
        }
        
        .featured-stat {
            text-align: center;
        }
        
        .featured-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }
        
        .featured-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
        }
        
        .project-small-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .project-small-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .project-small-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .project-small-card:hover::before {
            opacity: 1;
        }
        
        .project-small-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .project-small-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: var(--space-md);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .project-small-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        
        .project-status-badge {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .project-status-badge.planning {
            background: rgba(251, 191, 36, 0.1);
            color: #f59e0b;
        }
        
        .project-status-badge.active {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        
        .project-status-badge.completed {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }
        
        /* 小卡片增强信息样式 */
        .project-small-enhanced-meta {
            margin-bottom: var(--space-md);
        }
        
        .small-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xs);
        }
        
        .small-priority-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            gap: 2px;
        }
        
        .small-team-info {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            color: var(--text-secondary);
            gap: 2px;
        }
        
        .small-deadline-info {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            color: var(--text-secondary);
            gap: 2px;
        }
        
        .small-deadline-info.urgent {
            background: #fff3cd;
            color: #856404;
        }
        
        .small-deadline-info.overdue {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* 项目卡片按钮样式 */
        .project-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-color);
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .project-small-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
            border-top: 1px solid var(--border-color);
        }
        
        .small-action-btn {
            flex: 1;
            padding: var(--space-xs);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .small-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .tab-count {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: var(--space-xs);
        }
        
        .dashboard-tab.active .tab-count {
            background: white;
            color: var(--primary-color);
        }

        /* 项目快速操作区域样式 */
        .project-quick-actions {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        /* 主要操作卡片 */
        .main-action-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .main-action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .main-action-card:hover::before {
            opacity: 1;
        }

        .main-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .main-action-content {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
        }

        .main-action-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .main-action-text h3 {
            margin: 0 0 var(--space-xs) 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .main-action-text p {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .main-action-arrow {
            font-size: 1.2rem;
            opacity: 0.8;
            transition: transform 0.3s ease;
        }

        .main-action-card:hover .main-action-arrow {
            transform: translateX(4px);
        }

        /* 次要操作卡片 */
        .secondary-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .secondary-action-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            flex: 1;
        }

        .secondary-action-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
            background: var(--bg-card);
        }

        .secondary-action-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .secondary-action-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* 笔记页面快速操作样式 */
        .notes-quick-actions {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .project-quick-actions,
            .notes-quick-actions {
                grid-template-columns: 1fr;
            }
            
            .secondary-actions {
                flex-direction: row;
            }
            
            .main-action-content {
                gap: var(--space-md);
            }
            
            .main-action-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .main-action-text h3 {
                font-size: 1.1rem;
            }
        }

        /* 项目概览样式 */
        .dashboard-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .dashboard-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            transition: all 0.3s ease;
        }

        .dashboard-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .dashboard-item-icon {
            width: 48px;
            height: 48px;
            background: var(--gradient);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin: 0 auto var(--space-md);
        }

        .dashboard-item-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--space-xs);
        }

        .dashboard-item-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 内容概览样式 */
        /* 项目详情样式 */
        .project-details-section {
            margin-bottom: var(--space-lg);
        }

        .project-details-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-lg);
        }

        .project-title {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .project-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .project-meta {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-light);
        }

        .project-status .status-badge {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .project-status .status-badge.planning {
            background: var(--warning-bg);
            color: var(--warning-color);
        }

        .project-status .status-badge.active {
            background: var(--primary-bg);
            color: var(--primary-color);
        }

        .project-status .status-badge.completed {
            background: var(--success-bg);
            color: var(--success-color);
        }

        .project-progress {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            flex: 1;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .project-description {
            margin-bottom: var(--space-lg);
        }

        .project-description h3 {
            margin: 0 0 var(--space-sm) 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .project-description p {
            margin: 0;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .project-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .project-info-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .project-info-item label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .project-info-item span {
            color: var(--text-primary);
        }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .project-tags .tag {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .content-overview {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .overview-search {
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .overview-search .search-container {
            max-width: none;
            margin: 0;
        }

        .overview-search .search-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            font-size: 0.9rem;
            padding: var(--space-sm) var(--space-sm) var(--space-sm) 2.5rem;
        }

        .overview-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-light);
        }

        .overview-tab {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
        }

        .overview-tab.active {
            color: var(--primary-color);
            background: var(--bg-primary);
        }

        .overview-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .overview-content {
            padding: var(--space-lg);
        }

        .overview-tab-content {
            display: none;
        }

        .overview-tab-content.active {
            display: block;
        }

        .recent-project-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .recent-project-item:hover {
            background: var(--bg-tertiary);
        }

        .recent-project-icon {
            width: 32px;
            height: 32px;
            background: var(--gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
        }

        /* 项目概览面板样式 */
        .overview-panel {
            display: none;
        }

        .overview-panel.active {
            display: block;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-lg);
            padding: var(--space-sm) 0;
        }

        .project-overview-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .project-overview-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .project-overview-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }

        .project-overview-card:hover::before {
            opacity: 1;
        }

        .project-overview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .project-overview-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .project-overview-status {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .project-overview-status.planning {
            background: rgba(156, 163, 175, 0.1);
            color: #6B7280;
        }

        .project-overview-status.active {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .project-overview-status.completed {
            background: rgba(34, 197, 94, 0.1);
            color: #22C55E;
        }

        .project-overview-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: var(--space-md);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-overview-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .project-overview-date {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .project-overview-tasks {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .overview-empty {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .overview-empty i {
            font-size: 3rem;
            margin-bottom: var(--space-md);
            opacity: 0.5;
        }

        .overview-empty p {
            margin: 0;
            font-size: 1rem;
        }
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }

        .recent-project-info {
            flex: 1;
        }

        .recent-project-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .recent-project-date {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-md);
        }

        .stat-item {
            text-align: center;
            padding: var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--space-xs);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .navbar-left {
                gap: var(--space-md);
            }
            
            .search-container {
                display: none;
            }
            
            .editor-sidebar {
                width: 250px;
            }
            
            .kanban-board {
                padding: var(--space-md);
            }
            
            .kanban-column {
                min-width: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .navbar {
                padding: 0.5rem 1rem;
            }
            
            .navbar-left {
                gap: var(--space-sm);
            }
            
            .nav-menu {
                display: none;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-sidebar {
                width: 100%;
                height: 200px;
            }
        }
        
        /* 自定义模态对话框样式 */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .custom-modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: scale(0.9);
            transition: transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .custom-modal.show .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            position: relative;
            margin-bottom: var(--space-lg);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .modal-input {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-md);
            justify-content: flex-end;
            margin-top: var(--space-lg);
        }
        
        .modal-btn {
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .modal-btn-cancel:hover {
            background: var(--bg-hover);
        }
        
        .modal-btn-confirm {
            background: var(--primary-color);
            color: var(--text-inverse);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .modal-btn-confirm:hover {
            background: #5B5FE8;
        }
        
        .modal-btn-confirm.loading {
            background: #9CA3AF;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .modal-btn-confirm.loading::after {
            content: '';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .modal-btn-confirm.success {
            background: #10B981;
            cursor: default;
            pointer-events: none;
        }
        
        .modal-btn-confirm.success::after {
            content: '✓';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: bold;
        }
        
        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        /* 项目编辑器模态框样式 */
        .project-editor-content {
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* 认证表单样式 */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .auth-form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .auth-form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .auth-form-input {
            padding: var(--space-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .auth-form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .auth-form-button {
            padding: var(--space-sm) var(--space-md);
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-form-button:hover {
            background: var(--primary-hover);
        }

        .auth-form-button:disabled {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .auth-form-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.875rem;
            text-align: center;
            margin-top: var(--space-sm);
        }

        .auth-form-link:hover {
            text-decoration: underline;
        }

        .auth-error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: var(--space-xs);
        }

        .project-editor-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: var(--space-sm);
        }

        .editor-section {
            margin-bottom: var(--space-lg);
        }

        .editor-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .editor-input, .editor-textarea, .editor-select {
            width: 100%;
            padding: var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .editor-input:focus, .editor-textarea:focus, .editor-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .editor-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .progress-input-container {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .progress-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
        }

        .progress-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid var(--bg-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: 2px solid var(--bg-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-value {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            min-width: 40px;
            text-align: right;
        }

        .tags-input-container, .members-input-container {
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            background: var(--bg-primary);
        }

        .current-tags, .current-members {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
            min-height: 32px;
        }

        .tag-item, .member-item {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            background: var(--primary-color);
            color: var(--text-inverse);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tag-remove, .member-remove {
            background: none;
            border: none;
            color: var(--text-inverse);
            cursor: pointer;
            padding: 0;
            font-size: 0.875rem;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .tag-remove:hover, .member-remove:hover {
            opacity: 1;
        }

        .tag-input-row, .member-input-row {
            display: flex;
            gap: var(--space-sm);
        }

        .tag-input-row .editor-input, .member-input-row .editor-input {
            flex: 1;
            margin: 0;
        }

        .add-tag-btn, .add-member-btn {
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .add-tag-btn:hover, .add-member-btn:hover {
            background: var(--bg-hover);
            border-color: var(--primary-color);
        }

        /* 项目编辑器样式 */
        .project-editor {
            margin-top: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .editor-tab {
            padding: var(--space-md) var(--space-lg);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .editor-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .editor-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: var(--bg-secondary);
        }

        .editor-content {
            padding: var(--space-lg);
        }

        .editor-tab-content {
            display: none;
        }

        .editor-tab-content.active {
            display: block;
        }

        /* 富文本编辑器工具栏 */
        .editor-toolbar {
            display: flex;
            gap: var(--space-xs);
            padding: var(--space-sm);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--radius-md) var(--radius-md) 0 0;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: var(--space-xs) var(--space-sm);
            background: none;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .toolbar-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            border-color: var(--primary-color);
        }

        .toolbar-separator {
            width: 1px;
            background: var(--border-color);
            margin: 0 var(--space-xs);
        }

        /* 编辑器文本区域 */
        .editor-textarea {
            width: 100%;
            min-height: 300px;
            padding: var(--space-md);
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease;
        }

        .editor-textarea:focus {
            border-color: var(--primary-color);
        }

        /* 任务管理样式 */
        .task-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-top: var(--space-md);
        }

        .task-column {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border-color);
        }

        .task-column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .task-column-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .task-count {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .task-list {
            min-height: 200px;
            margin-bottom: var(--space-md);
        }

        .task-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            margin-bottom: var(--space-sm);
            cursor: move;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .task-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .task-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            font-size: 0.875rem;
        }

        .task-description {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
            margin-bottom: var(--space-xs);
        }

        .task-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .task-priority {
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .task-priority.high {
            background: #FEE2E2;
            color: #DC2626;
        }

        .task-priority.medium {
            background: #FEF3C7;
            color: #D97706;
        }

        .task-priority.low {
            background: #DCFCE7;
            color: #16A34A;
        }

        .add-task-btn {
            width: 100%;
            padding: var(--space-sm);
            background: none;
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .add-task-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.05);
        }

        /* 项目笔记样式 */
        .notes-section {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            border: 1px solid var(--border-color);
        }

        .notes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .notes-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .add-note-btn {
            padding: var(--space-xs) var(--space-sm);
            background: var(--primary-color);
            color: var(--text-inverse);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .add-note-btn:hover {
            background: #5B5FE8;
        }

        .notes-list {
            display: grid;
            gap: var(--space-md);
        }

        .note-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition: all 0.2s ease;
        }

        .note-item:hover {
            border-color: var(--primary-color);
        }

        .note-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-sm);
        }

        .note-title {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .note-date {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .note-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* 笔记概览页面样式 */
        .notes-overview {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .notes-overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .notes-overview-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notes-overview-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .notes-search-box {
            position: relative;
            width: 300px;
        }

        .notes-search-box input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .notes-search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .notes-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .notes-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            position: relative;
            transition: all 0.2s ease;
        }

        .notes-tab:hover {
            color: var(--text-primary);
        }

        .notes-tab.active {
            color: var(--primary-color);
        }

        .notes-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        .notes-tab-count {
            margin-left: 6px;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .notes-tab.active .notes-tab-count {
            background: var(--primary-color);
            color: white;
        }

        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .note-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .note-card:hover {
            border-color: var(--border-light);
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
        }

        .note-card:hover::before {
            opacity: 1;
        }

        .note-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .note-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.4;
            flex: 1;
            margin-right: 10px;
        }

        .note-card-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .note-card:hover .note-card-actions {
            opacity: 1;
        }

        .note-card-action {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .note-card-action:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .note-card-action.favorite.active {
            color: #f59e0b;
        }

        .note-card-content {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .note-card-date {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .note-card-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .note-card-tag {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .notes-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .notes-empty i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--text-tertiary);
        }

        .notes-empty h3 {
            margin: 0 0 8px 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .notes-empty p {
            margin: 0;
            font-size: 0.875rem;
        }

        /* 笔记编辑器覆盖层 */
        .note-editor-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .note-editor-modal {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
        }

        .note-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .note-editor-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .note-editor-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .note-editor-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .note-editor-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .notes-overview {
                padding: 15px;
            }

            .notes-overview-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .notes-search-box {
                width: 100%;
            }

            .notes-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .note-editor-modal {
                margin: 10px;
                max-height: calc(100vh - 20px);
            }
        }

        /* ==================== 设置页面样式 ==================== */
        
        .settings-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-header {
            margin-bottom: 30px;
        }

        .settings-header h1 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 600;
        }

        .settings-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .settings-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .settings-tab:hover {
            color: var(--primary-color);
            background-color: var(--hover-bg);
        }

        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        /* AI 助手设置面板布局与排版优化 */
        .settings-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .setting-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-card);
        }
        .setting-label {
            flex: 0 0 240px;
            max-width: 240px;
        }
        .setting-label label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: block;
        }
        .setting-description {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }
        .setting-control {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .setting-control input[type="password"],
        .setting-control select {
            min-width: 280px;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
        }
        .settings-subgroup {
            margin-top: 8px;
            padding-left: 12px;
            border-left: 3px solid var(--border-color);
        }

        /* 小屏适配 */
        @media (max-width: 768px) {
            .setting-item { flex-direction: column; }
            .setting-label { flex: 1 1 auto; max-width: none; }
            .setting-control { width: 100%; }
            .setting-control input[type="password"], .setting-control select { width: 100%; min-width: 0; }
        }

        .settings-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .settings-section h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section h3 i {
            color: var(--primary-color);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            color: var(--text-primary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .settings-item-description {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .settings-item-control {
            margin-left: 20px;
        }

        .settings-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            min-width: 120px;
        }

        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .settings-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }

        .settings-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .settings-toggle input:checked + .settings-toggle-slider {
            background-color: var(--primary-color);
        }

        .settings-toggle input:checked + .settings-toggle-slider:before {
            transform: translateX(26px);
        }

        /* 账户信息样式 */
        .account-info-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .account-avatar {
            font-size: 48px;
            color: var(--primary-color);
        }

        .account-details {
            flex: 1;
        }

        .account-email {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .account-id {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .account-created {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .account-info-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .account-info-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 使用统计样式 */
        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: var(--hover-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        /* 备份历史样式 */
        .backup-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .backup-history-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .backup-history-empty i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--hover-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 12px;
        }

        .backup-item-info {
            flex: 1;
        }

        .backup-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .backup-item-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .backup-item-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .backup-item-actions {
            display: flex;
            gap: 8px;
        }

        /* 危险操作样式 */
        .danger-zone {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }

        .danger-zone h3 {
            color: #dc3545;
        }

        .danger-zone h3 i {
            color: #dc3545;
        }

        .danger-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .settings-container {
                padding: 15px;
            }

            .settings-tabs {
                margin-bottom: 20px;
            }

            .settings-tab {
                padding: 10px 16px;
                font-size: 14px;
            }

            .settings-section {
                padding: 20px;
            }

            .settings-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .settings-item-control {
                margin-left: 0;
                width: 100%;
            }

            .settings-select {
                width: 100%;
            }

            .account-info-content {
                flex-direction: column;
                text-align: center;
            }

            .usage-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .backup-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .backup-item-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .backup-actions,
            .danger-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .usage-stats {
                grid-template-columns: 1fr;
            }

            .settings-header h1 {
                font-size: 24px;
            }

            .backup-item-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 顶部导航栏 -->
        <nav class="navbar">
            <div class="navbar-left">
                <div class="logo" onclick="navigateTo('dashboard')">
                    <i class="fas fa-brain"></i>
                    CogniNote Pro
                </div>
                
                <div class="nav-menu">
                    <div class="nav-item active" onclick="navigateTo('dashboard')" data-page="dashboard">
                        <i class="fas fa-home"></i>
                        首页
                    </div>
                    <div class="nav-item" onclick="navigateTo('notes')" data-page="notes">
                        <i class="fas fa-edit"></i>
                        笔记
                    </div>
                    <div class="nav-item" onclick="navigateTo('projects')" data-page="projects">
                        <i class="fas fa-tasks"></i>
                        项目
                    </div>
                </div>
            </div>
            
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="搜索笔记、项目..." onkeyup="performSearch(this.value)">
            </div>
            
            <div class="navbar-right">
                <div class="theme-toggle">
                    <button class="theme-btn active" onclick="setTheme('light')">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button class="theme-btn" onclick="setTheme('dark')">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
                
                <button class="nav-btn" onclick="showNotification('通知功能开发中...', 'info')" title="通知">
                    <i class="fas fa-bell"></i>
                </button>
                
                <button class="nav-btn" onclick="showSettings()" title="设置">
                        <i class="fas fa-cog"></i>
                </button>
                
                <!-- 认证相关UI -->
                <div id="auth-container">
                    <!-- 未登录状态 -->
                    <div id="unauthenticated-ui" style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="handleLoginButtonClick();" style="padding: 8px 16px; font-size: 14px;">
                            登录
                        </button>
                        <button class="btn btn-primary" onclick="showRegisterModal()" style="padding: 8px 16px; font-size: 14px;">
                            注册
                        </button>
                    </div>
                    
                    <!-- 已登录状态 -->
                    <div id="authenticated-ui" style="display: none; align-items: center; gap: 12px;">
                        <span id="user-email" style="color: var(--text-secondary); font-size: 14px;"></span>
                        <div class="user-avatar" onclick="toggleUserMenu()" title="用户菜单" style="position: relative;">
                            <span id="user-initial">U</span>
                            <!-- 用户菜单下拉 -->
                            <div id="user-menu" class="user-menu" style="display: none;">
                                <div class="user-menu-item" onclick="showProfile()">
                                    <i class="fas fa-user"></i>
                                    个人资料
                                </div>
                                <div class="user-menu-item" onclick="showSettings()">
                                    <i class="fas fa-cog"></i>
                                    设置
                                </div>
                                <!-- 管理入口，仅 owner/admin 显示 -->
                                <div class="user-menu-item" id="adminMenuBtn" onclick="openAdminPanel()" style="display: none;">
                                    <i class="fas fa-shield-alt"></i>
                                    管理
                                </div>
                                <div class="user-menu-divider" id="adminDivider" style="display: none;"></div>
                                <div class="user-menu-item" onclick="handleLogout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    退出登录
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 首页 Dashboard -->
            <div class="page active" id="dashboard">
                <div class="container">
                    <!-- 演示数据提示条 -->
                    <div id="demo-notice" class="demo-notice" style="display: none;">
                        <div class="demo-notice-content">
                            <i class="fas fa-info-circle"></i>
                            <span>您正在查看演示数据。<strong>登录后</strong>即可创建和管理您的真实笔记。</span>
                            <button class="btn btn-sm btn-primary" onclick="showLoginModal()">立即登录</button>
                        </div>
                    </div>

                    <div class="page-header">
                        <h1 class="page-title">智能工作台</h1>
                        <p class="page-subtitle">您的生产力中心，让创意与效率完美结合</p>
                    </div>

                    <!-- 快速操作 - 单栏布局 -->
                    <div class="card" style="margin-bottom: var(--space-lg);">
                        <div class="card-header">
                            <div class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                快速操作
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: var(--space-md); margin-bottom: var(--space-lg);">
                            <button class="btn btn-primary" onclick="createNewNoteAndNavigate()" style="flex: 1;">
                                <i class="fas fa-plus"></i>
                                新建笔记
                            </button>
                            <button class="btn btn-secondary" onclick="createNewProjectAndNavigate()" style="flex: 1;">
                                <i class="fas fa-project-diagram"></i>
                                新建项目
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md);">
                            <div style="text-align: center; padding: var(--space-md); background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); box-shadow: var(--shadow-xs);">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary-color);" id="notes-count">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">笔记总数</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-md); background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); box-shadow: var(--shadow-xs);">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--success-color);" id="projects-count">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">项目总数</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-md); background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); box-shadow: var(--shadow-xs);">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--info-color);" id="today-notes">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">今日笔记</div>
                            </div>
                            <div style="text-align: center; padding: var(--space-md); background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: var(--radius-lg); box-shadow: var(--shadow-xs);">
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--warning-color);" id="today-tasks">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.875rem;">今日任务</div>
                            </div>
                        </div>
                    </div>

                    <!-- 主显示区域 -->
                    <div class="card" style="min-height: 500px;">
                        <div class="card-header">
                            <div class="card-title">
                                <div class="card-icon">
                                    <i class="fas fa-th-large"></i>
                                </div>
                                内容概览
                            </div>
                        </div>
                        
                        <!-- 导航标签 -->
                        <div class="dashboard-tabs" style="display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); border-bottom: 1px solid var(--border-color); padding-bottom: var(--space-md);">
                            <button class="dashboard-tab active" onclick="switchDashboardView('recent-notes')" data-view="recent-notes">
                                <i class="fas fa-history"></i>
                                最近笔记
                            </button>
                            <button class="dashboard-tab" onclick="switchDashboardView('project-overview')" data-view="project-overview">
                                <i class="fas fa-project-diagram"></i>
                                项目概览
                            </button>
                        </div>
                        
                        <!-- 内容区域 -->
                        <div class="dashboard-content">
                            <!-- 最近笔记视图 -->
                            <div class="dashboard-view active" id="dashboard-recent-notes">
                                <div id="recent-notes-grid" class="notes-grid">
                                    <div style="text-align: center; color: var(--text-secondary); padding: var(--space-xl);">
                                        暂无笔记，<span style="color: var(--primary-color); cursor: pointer;" onclick="navigateTo('notes')">立即创建</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 项目概览视图 -->
                            <div class="dashboard-view" id="dashboard-project-overview">
                                <div id="project-overview-grid" class="projects-grid">
                                    <div style="text-align: center; color: var(--text-secondary); padding: var(--space-xl);">
                                        暂无项目，<span style="color: var(--primary-color); cursor: pointer;" onclick="navigateTo('projects')">立即创建</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 笔记页面 -->
            <div class="page" id="notes">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">我的笔记</h1>
                        <p class="page-subtitle">记录想法和灵感，整理知识和经验</p>
                    </div>

                    <!-- 快速操作 - 新设计 -->
                    <div class="notes-quick-actions">
                        <!-- 主要操作卡片 -->
                        <div class="main-action-card" onclick="createNewNote().catch(console.error)">
                            <div class="main-action-content">
                                <div class="main-action-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="main-action-text">
                                    <h3>创建新笔记</h3>
                                    <p>记录新的想法、灵感或重要信息</p>
                                </div>
                            </div>
                            <div class="main-action-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>

                        <!-- 次要操作卡片 -->
                        <div class="secondary-actions">
                            <div class="secondary-action-card" onclick="showNotesSearch()">
                                <div class="secondary-action-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="secondary-action-text">
                                    <span>搜索笔记</span>
                                </div>
                            </div>
                            
                            <div class="secondary-action-card" onclick="showNotesStats()">
                                <div class="secondary-action-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="secondary-action-text">
                                    <span>笔记统计</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 笔记概览 -->
                    <div class="content-overview" id="notes-overview-section">
                        <!-- 搜索区域 -->
                        <div class="overview-search">
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="搜索笔记..." oninput="searchNotesInOverview(this.value)">
                            </div>
                        </div>
                        
                        <div class="overview-tabs">
                            <button class="overview-tab active" onclick="switchNotesOverviewTab('all-notes')">
                                <i class="fas fa-file-alt"></i>
                                全部笔记
                                <span class="tab-count" id="all-notes-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchNotesOverviewTab('favorites')">
                                <i class="fas fa-star"></i>
                                收藏夹
                                <span class="tab-count" id="favorites-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchNotesOverviewTab('recent')">
                                <i class="fas fa-clock"></i>
                                最近编辑
                                <span class="tab-count" id="recent-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchNotesOverviewTab('today-notes')">
                                <i class="fas fa-calendar-day"></i>
                                今日笔记
                                <span class="tab-count" id="today-notes-count">0</span>
                            </button>
                        </div>
                        <div class="overview-content">
                            <div class="overview-panel active" id="all-notes">
                                <div class="notes-grid" id="all-notes-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-file-alt"></i>
                                        <p>暂无笔记</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="favorites">
                                <div class="notes-grid" id="favorites-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-star"></i>
                                        <p>暂无收藏笔记</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="recent">
                                <div class="notes-grid" id="recent-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-clock"></i>
                                        <p>暂无最近编辑的笔记</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="today-notes">
                                <div class="notes-grid" id="today-notes-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-calendar-day"></i>
                                        <p>今日暂无笔记</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 笔记编辑器 -->
                    <div class="note-editor" id="note-editor" style="display: none;">
                        <div class="editor-header">
                            <div class="editor-header-left">
                                <button class="btn btn-secondary" onclick="closeNoteEditor()">
                                    <i class="fas fa-arrow-left"></i>
                                    <span>返回</span>
                                </button>
                            </div>
                            <div class="editor-header-right">
                                <button class="btn btn-secondary" onclick="toggleNoteFavorite()" id="favorite-btn" title="收藏">
                                    <i class="far fa-star"></i>
                                </button>
                                <button class="btn btn-secondary" onclick="deleteNoteFromEditor()" id="delete-btn" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-primary" onclick="saveNote().catch(console.error)">
                                    <i class="fas fa-save"></i>
                                    <span>保存</span>
                                </button>
                            </div>
                        </div>

                        <div class="editor-content">
                            <input type="text" class="editor-title" placeholder="无标题笔记" id="note-title">
                            <textarea class="editor-textarea" placeholder="开始记录你的想法..." id="note-content"></textarea>
                        </div>

                        <div class="editor-footer">
                            <div class="editor-status">
                                <span id="word-count">
                                    <i class="fas fa-font"></i>
                                    0 字
                                </span>
                                <span id="save-status">
                                    <i class="fas fa-check-circle"></i>
                                    已保存
                                </span>
                            </div>
                            <div class="editor-tools">
                                <button class="btn btn-secondary btn-sm" onclick="formatText('bold')" title="加粗">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="formatText('italic')" title="斜体">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="insertTimestamp()" title="插入时间戳">
                                    <i class="fas fa-clock"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目页面 -->
            <div class="page" id="projects">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">项目管理</h1>
                        <p class="page-subtitle">管理您的项目和任务，提升工作效率</p>
                    </div>

                    <!-- 快速操作 - 新设计 -->
                    <div class="project-quick-actions">
                        <!-- 主要操作卡片 -->
                        <div class="main-action-card" onclick="createNewProject().catch(console.error)">
                            <div class="main-action-content">
                                <div class="main-action-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <div class="main-action-text">
                                    <h3>创建新项目</h3>
                                    <p>开始一个新的项目，管理任务和进度</p>
                                </div>
                            </div>
                            <div class="main-action-arrow">
                                <i class="fas fa-arrow-right"></i>
                            </div>
                        </div>

                        <!-- 次要操作卡片 -->
                        <div class="secondary-actions">
                            <div class="secondary-action-card" onclick="toggleProjectView()">
                                <div class="secondary-action-icon">
                                    <i class="fas fa-th" id="project-view-icon"></i>
                                </div>
                                <div class="secondary-action-text">
                                    <span id="project-view-text">切换视图</span>
                                </div>
                            </div>
                            
                            <div class="secondary-action-card" onclick="showProjectStats()">
                                <div class="secondary-action-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="secondary-action-text">
                                    <span>项目统计</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 项目详情区域 -->
                    <div class="project-details-section" id="project-details-section" style="display: none;">
                        <div class="project-details-header">
                            <button class="btn btn-secondary btn-sm" onclick="backToProjectList()" style="margin-bottom: var(--space-md);">
                                <i class="fas fa-arrow-left"></i>
                                返回项目列表
                            </button>
                        </div>
                        <div class="project-details-card">
                            <div class="project-details-main">
                                <div class="project-header">
                                    <h2 class="project-title" id="project-detail-title">项目标题</h2>
                                    <div class="project-actions">
                                        <button class="btn btn-primary btn-sm" onclick="editCurrentProject()">
                                            <i class="fas fa-edit"></i>
                                            编辑项目
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="deleteCurrentProject()">
                                            <i class="fas fa-trash"></i>
                                            删除项目
                                        </button>
                                    </div>
                                </div>
                                <div class="project-meta">
                                    <div class="project-status" id="project-detail-status">
                                        <span class="status-badge">待办</span>
                                    </div>
                                    <div class="project-progress">
                                        <span>进度：</span>
                                        <div class="progress-bar">
                                            <div class="progress-fill" id="project-detail-progress" style="width: 0%"></div>
                                        </div>
                                        <span id="project-detail-progress-text">0%</span>
                                    </div>
                                </div>
                                <div class="project-description" id="project-detail-description">
                                    <h3>项目描述</h3>
                                    <p>暂无描述</p>
                                </div>
                                <div class="project-info-grid">
                                    <div class="project-info-item">
                                        <label>创建时间：</label>
                                        <span id="project-detail-created">-</span>
                                    </div>
                                    <div class="project-info-item">
                                        <label>更新时间：</label>
                                        <span id="project-detail-updated">-</span>
                                    </div>
                                    <div class="project-info-item">
                                        <label>截止时间：</label>
                                        <span id="project-detail-deadline">-</span>
                                    </div>
                                    <div class="project-info-item">
                                        <label>标签：</label>
                                        <div class="project-tags" id="project-detail-tags">
                                            <span class="tag">无标签</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 项目概览 -->
                    <div class="content-overview" id="project-overview-section">
                        <div class="overview-tabs">
                            <button class="overview-tab active" onclick="switchProjectOverviewTab('total-projects')">
                                <i class="fas fa-folder"></i>
                                总项目
                                <span class="tab-count" id="total-projects-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchProjectOverviewTab('active-projects')">
                                <i class="fas fa-play-circle"></i>
                                进行中
                                <span class="tab-count" id="active-projects-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchProjectOverviewTab('completed-projects')">
                                <i class="fas fa-check-circle"></i>
                                已完成
                                <span class="tab-count" id="completed-projects-count">0</span>
                            </button>
                            <button class="overview-tab" onclick="switchProjectOverviewTab('today-tasks')">
                                <i class="fas fa-calendar-day"></i>
                                今日任务
                                <span class="tab-count" id="today-tasks-count">0</span>
                            </button>
                        </div>
                        <div class="overview-content">
                            <div class="overview-panel active" id="total-projects">
                                <div class="projects-grid" id="total-projects-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-folder-open"></i>
                                        <p>暂无项目</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="active-projects">
                                <div class="projects-grid" id="active-projects-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-play-circle"></i>
                                        <p>暂无进行中的项目</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="completed-projects">
                                <div class="projects-grid" id="completed-projects-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-check-circle"></i>
                                        <p>暂无已完成的项目</p>
                                    </div>
                                </div>
                            </div>
                            <div class="overview-panel" id="today-tasks">
                                <div class="projects-grid" id="today-tasks-grid">
                                    <div class="overview-empty">
                                        <i class="fas fa-calendar-day"></i>
                                        <p>今日暂无任务</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>






                </div>
            </div>

            <!-- 设置页面 -->
            <div class="page" id="settings">
                <div class="container">
                    <div class="page-header">
                        <h1 class="page-title">系统设置</h1>
                        <p class="page-subtitle">管理您的账户设置、数据备份和应用偏好</p>
                    </div>

                    <!-- 设置选项卡 -->
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="showSettingsTab('general')">
                            <i class="fas fa-cog"></i>
                            常规设置
                        </button>
                        <button class="settings-tab" onclick="showSettingsTab('ai')">
                            <i class="fas fa-robot"></i>
                            AI 助手
                        </button>
                        <button class="settings-tab" onclick="showSettingsTab('backup')">
                            <i class="fas fa-database"></i>
                            数据备份
                        </button>
                        <button class="settings-tab" onclick="showSettingsTab('account')">
                            <i class="fas fa-user"></i>
                            账户管理
                        </button>
                    </div>

                    <!-- 常规设置 -->
                    <div class="settings-panel active" id="general-settings">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                    外观设置
                                </div>
                            </div>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>主题模式</label>
                                        <p class="setting-description">选择您喜欢的界面主题</p>
                                    </div>
                                    <div class="setting-control">
                                        <select id="theme-select" onchange="changeTheme(this.value)">
                                            <option value="light">浅色主题</option>
                                            <option value="dark">深色主题</option>
                                            <option value="auto">跟随系统</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>项目视图</label>
                                        <p class="setting-description">选择项目的默认显示方式</p>
                                    </div>
                                    <div class="setting-control">
                                        <select id="project-view-select" onchange="changeProjectView(this.value)">
                                            <option value="grid">网格视图</option>
                                            <option value="kanban">看板视图</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-bell"></i>
                                    </div>
                                    通知设置
                                </div>
                            </div>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>桌面通知</label>
                                        <p class="setting-description">允许应用发送桌面通知</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="desktop-notifications" onchange="toggleDesktopNotifications(this.checked)">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>任务提醒</label>
                                        <p class="setting-description">在任务截止前提醒您</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="task-reminders" onchange="toggleTaskReminders(this.checked)">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI 助手 -->
                    <div class="settings-panel" id="ai-settings">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-robot"></i>
                                    </div>
                                    AI 助手（OpenRouter）
                                </div>
                            </div>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>API Key</label>
                                        <p class="setting-description">用于访问 OpenRouter API；保存在本地浏览器，仅本机可见。</p>
                                    </div>
                                    <div class="setting-control">
                                        <input type="password" id="ai-global-key" placeholder="sk-or-..." />
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>默认模型</label>
                                        <p class="setting-description">从 OpenRouter /models 动态拉取；保存为全局默认模型。</p>
                                    </div>
                                    <div class="setting-control">
                                        <select id="ai-global-model">
                                            <option value="google/gemini-2.5-flash-image-preview">Gemini 2.5 Flash</option>
                                            <option value="openai/gpt-4o-mini">OpenAI gpt-4o-mini</option>
                                            <option value="anthropic/claude-3.5-haiku">Claude 3.5 Haiku</option>
                                            <option value="black-forest-labs/flux-1.1-pro">Flux 1.1 Pro（生图）</option>
                                            <option value="stability-ai/stable-diffusion-3.5-large">Stable Diffusion 3.5 Large（生图）</option>
                                        </select>
                                        <button class="btn btn-outline" id="ai-global-refresh-models">刷新模型列表</button>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>高级设置</label>
                                        <p class="setting-description">“请求类型”默认采用自动智能路由；需要时可在此处调整。</p>
                                    </div>
                                    <div class="setting-control">
                                        <button class="btn btn-secondary" id="ai-global-advanced-toggle">展开高级设置</button>
                                    </div>
                                </div>
                                <div class="settings-subgroup" id="ai-global-advanced" style="display:none">
                                    <div class="setting-item">
                                        <div class="setting-label">
                                            <label>请求类型</label>
                                            <p class="setting-description">选择聊天或生图，默认自动智能路由</p>
                                        </div>
                                        <div class="setting-control">
                                            <select id="ai-global-mode">
                                                <option value="auto">自动</option>
                                                <option value="chat">聊天</option>
                                                <option value="images">生图</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-control">
                                        <button class="btn btn-primary" id="ai-global-save">保存</button>
                                        <span class="setting-description" id="ai-global-tip"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <script>
                    (function(){
                      const STORAGE = { KEY: 'CN_OPENROUTER_KEY', MODEL: 'CN_OPENROUTER_MODEL', MODE: 'CN_OPENROUTER_MODE' };
                      function get(k){ return localStorage.getItem(k)||''; }
                      function set(k,v){ localStorage.setItem(k, v || ''); }
                      const keyEl = document.getElementById('ai-global-key');
                      const modelEl = document.getElementById('ai-global-model');
                      const modeEl = document.getElementById('ai-global-mode');
                      const tipEl = document.getElementById('ai-global-tip');
                      const advBtn = document.getElementById('ai-global-advanced-toggle');
                      const advPanel = document.getElementById('ai-global-advanced');
                      const refreshBtn = document.getElementById('ai-global-refresh-models');
                      const saveBtn = document.getElementById('ai-global-save');
                      if (keyEl) keyEl.value = get(STORAGE.KEY);
                      if (modelEl) modelEl.value = get(STORAGE.MODEL) || modelEl.value;
                      if (modeEl) modeEl.value = get(STORAGE.MODE) || 'auto';
                      function refreshModels(){
                        try {
                          const apiKey = get(STORAGE.KEY);
                          const headers = { 'Accept': 'application/json' };
                          if (apiKey) headers['Authorization'] = 'Bearer ' + apiKey;
                          fetch('https://openrouter.ai/api/v1/models', { headers }).then(r=>r.json()).then(data=>{
                            if (!data || !Array.isArray(data.data)) return;
                            const options = [];
                            data.data.forEach(m => {
                              const id = m.id || m.slug || m.name;
                              if (!id) return;
                              const label = (m.name || id) + (m.capabilities && m.capabilities.vision ? ' · 视觉' : '');
                              options.push({ id, label });
                            });
                            if (options.length && modelEl) {
                              modelEl.innerHTML = options.map(o => `<option value="${o.id}">${o.label}</option>`).join('');
                              const cur = get(STORAGE.MODEL);
                              if (cur) modelEl.value = cur;
                            }
                            tipEl && (tipEl.textContent = '模型列表已更新');
                            setTimeout(()=>{ if(tipEl) tipEl.textContent=''; }, 1000);
                          }).catch(err=>{ tipEl && (tipEl.textContent = '拉取模型失败'); console.error(err); setTimeout(()=>{ if(tipEl) tipEl.textContent=''; }, 1200); });
                        } catch(e){ console.error(e); }
                      }
                      refreshBtn && refreshBtn.addEventListener('click', refreshModels);
                      advBtn && (advBtn.textContent = (advPanel.style.display === 'block' ? '收起高级设置' : '展开高级设置'));
                      advBtn && advBtn.addEventListener('click', () => {
                        const isClosed = (advPanel.style.display==='none' || !advPanel.style.display);
                        advPanel.style.display = isClosed ? 'block' : 'none';
                        advBtn.textContent = isClosed ? '收起高级设置' : '展开高级设置';
                      });
                      saveBtn && saveBtn.addEventListener('click', () => {
                        if (keyEl && keyEl.value) set(STORAGE.KEY, keyEl.value.trim());
                        if (modelEl && modelEl.value) set(STORAGE.MODEL, modelEl.value.trim());
                        if (modeEl && modeEl.value) set(STORAGE.MODE, modeEl.value.trim());
                        tipEl && (tipEl.textContent = '已保存');
                        setTimeout(()=>{ if(tipEl) tipEl.textContent=''; }, 800);
                      });
                    })();
                    </script>

                    <!-- 数据备份 -->
                    <div class="settings-panel" id="backup-settings">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    数据备份与恢复
                                </div>
                            </div>
                            <div class="settings-group">
                                <div class="backup-actions">
                                    <div class="backup-action-card">
                                        <div class="backup-action-content">
                                            <div class="backup-action-icon">
                                                <i class="fas fa-download"></i>
                                            </div>
                                            <div class="backup-action-text">
                                                <h4>创建备份</h4>
                                                <p>将您的所有数据备份到本地文件</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" onclick="createManualBackup()">
                                            立即备份
                                        </button>
                                    </div>
                                    
                                    <div class="backup-action-card">
                                        <div class="backup-action-content">
                                            <div class="backup-action-icon">
                                                <i class="fas fa-upload"></i>
                                            </div>
                                            <div class="backup-action-text">
                                                <h4>恢复数据</h4>
                                                <p>从备份文件恢复您的数据</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-secondary" onclick="showRestoreDialog()">
                                            恢复数据
                                        </button>
                                    </div>
                                    
                                    <div class="backup-action-card">
                                        <div class="backup-action-content">
                                            <div class="backup-action-icon">
                                                <i class="fas fa-file-export"></i>
                                            </div>
                                            <div class="backup-action-text">
                                                <h4>导出数据</h4>
                                                <p>将数据导出为JSON文件</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline" onclick="exportDataToFile()">
                                            导出数据
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-history"></i>
                                    </div>
                                    备份历史
                                </div>
                            </div>
                            <div class="backup-history" id="backup-history">
                                <div class="backup-history-empty">
                                    <i class="fas fa-archive"></i>
                                    <p>暂无备份记录</p>
                                    <small>创建您的第一个备份以保护数据安全</small>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-cogs"></i>
                                    </div>
                                    自动备份设置
                                </div>
                            </div>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>启用自动备份</label>
                                        <p class="setting-description">定期自动创建数据备份</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="switch">
                                            <input type="checkbox" id="auto-backup" onchange="toggleAutoBackup(this.checked)">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>备份频率</label>
                                        <p class="setting-description">设置自动备份的时间间隔</p>
                                    </div>
                                    <div class="setting-control">
                                        <select id="backup-frequency">
                                            <option value="daily">每日</option>
                                            <option value="weekly">每周</option>
                                            <option value="monthly">每月</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <label>保留备份数量</label>
                                        <p class="setting-description">最多保留的备份文件数量</p>
                                    </div>
                                    <div class="setting-control">
                                        <select id="backup-retention">
                                            <option value="5">5个</option>
                                            <option value="10" selected>10个</option>
                                            <option value="20">20个</option>
                                            <option value="50">50个</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 账户管理 -->
                    <div class="settings-panel" id="account-settings">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-user-circle"></i>
                                    </div>
                                    账户信息
                                </div>
                            </div>
                            <div class="account-info" id="account-info">
                                <div class="account-info-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>加载账户信息...</p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    使用统计
                                </div>
                            </div>
                            <div class="usage-stats" id="usage-stats">
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="fas fa-sticky-note"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="notes-count">-</div>
                                        <div class="stat-label">笔记总数</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="fas fa-project-diagram"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="projects-count">-</div>
                                        <div class="stat-label">项目总数</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="tasks-count">-</div>
                                        <div class="stat-label">任务总数</div>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-icon">
                                        <i class="fas fa-tags"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-value" id="tags-count">-</div>
                                        <div class="stat-label">标签总数</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <div class="card-icon">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                    危险操作
                                </div>
                            </div>
                            <div class="danger-zone">
                                <div class="danger-action">
                                    <div class="danger-action-content">
                                        <h4>清空所有数据</h4>
                                        <p>永久删除您的所有笔记、项目和设置。此操作不可恢复！</p>
                                    </div>
                                    <button class="btn btn-danger" onclick="showClearDataDialog()">
                                        清空数据
                                    </button>
                                </div>
                                <div class="danger-action">
                                    <div class="danger-action-content">
                                        <h4>删除账户</h4>
                                        <p>永久删除您的账户和所有相关数据。此操作不可恢复！</p>
                                    </div>
                                    <button class="btn btn-danger" onclick="showDeleteAccountDialog()">
                                        删除账户
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 通知容器 -->
    <div id="notification-container"></div>

    <script>
        // 等待 Supabase 配置加载完成
        let supabase = null;
        
        // 全局状态管理
        let currentUser = null;
        let isAuthenticated = false;
        
        // 检查用户认证状态
        async function checkAuthStatus() {
            console.log('🔵 checkAuthStatus 开始执行...');
            
            try {
                // 确保 Supabase 已初始化
                const supabaseClient = getSupabaseClientOptimized();
                if (!supabaseClient) {
                    console.log('🔵 Supabase 未初始化，正在初始化...');
                    const initialized = initSupabaseOptimized(); // 使用优化版本的初始化函数
                    if (!initialized) {
                        console.error('❌ Supabase 初始化失败');
                        return;
                    }
                }
                
                console.log('🔵 获取当前用户...');
                const user = await getCurrentUserOptimized();
                
                if (user) {
                    console.log('✅ 检测到已登录用户:', user.email);
                    currentUser = user;
                    isAuthenticated = true;
                    
                    // ⏸️ 暂时禁用UI更新，防止循环
                    console.log('⏸️ 跳过UI更新，防止循环');
                    
                    console.log('✅ 用户认证状态更新完成');
                } else {
                    console.log('ℹ️ 未检测到登录用户');
                    currentUser = null;
                    isAuthenticated = false;
                    // ⏸️ 暂时禁用UI更新，防止循环
                    console.log('⏸️ 跳过UI更新，防止循环');
                }
            } catch (error) {
                console.error('❌ 检查认证状态失败:', error);
                currentUser = null;
                isAuthenticated = false;
                // ⏸️ 暂时禁用UI更新，防止循环
                console.log('⏸️ 跳过UI更新，防止循环');
            }
            
            console.log('✅ checkAuthStatus 执行完成');
        }

        // 获取当前登录账户信息
        function getCurrentUserInfo() {
            if (isAuthenticated && currentUser) {
                return {
                    email: currentUser.email,
                    id: currentUser.id,
                    created_at: currentUser.created_at,
                    last_sign_in_at: currentUser.last_sign_in_at,
                    email_confirmed_at: currentUser.email_confirmed_at
                };
            } else {
                return null;
            }
        }

        // 在控制台显示当前用户信息（调试用）
        function showCurrentUser() {
            const userInfo = getCurrentUserInfo();
            if (userInfo) {
                console.log('当前登录账户信息:', userInfo);
                console.log('邮箱:', userInfo.email);
                console.log('用户ID:', userInfo.id);
                console.log('注册时间:', new Date(userInfo.created_at).toLocaleString());
                console.log('最后登录时间:', userInfo.last_sign_in_at ? new Date(userInfo.last_sign_in_at).toLocaleString() : '未知');
            } else {
                console.log('当前没有用户登录');
            }
            return userInfo;
        }
        
        // 更新已认证用户的UI
        async function updateUIForAuthenticatedUser(user = null) {
            console.log('=== 更新UI为已认证状态 ===');
            
            // 关闭登录和注册模态框
            closeLoginModal();
            closeRegisterModal();
            console.log('已关闭登录和注册模态框');
            
            // 如果没有传入用户信息，尝试获取当前用户
            if (!user) {
                try {
                    user = await getCurrentUserOptimized();
                    console.log('获取到当前用户:', user);
                } catch (error) {
                    console.error('获取当前用户失败:', error);
                    // 如果获取用户失败，直接返回，不继续执行UI更新
                    console.warn('无法获取用户信息，跳过UI更新');
                    return;
                }
            }
            
            console.log('使用用户信息更新UI:', user ? user.email : '无用户信息');
            
            // 更新全局 currentUser 变量，并加载配置文件与角色
            if (user) {
                currentUser = user;
                console.log('已更新 currentUser:', currentUser.email);

                // 加载用户配置文件并保存到 AppState（包含角色）
                try {
                    const profile = typeof ensureUserProfileOptimized === 'function'
                        ? await ensureUserProfileOptimized(user)
                        : null;
                    AppState.user = {
                        id: user.id,
                        email: user.email,
                        display_name: profile?.display_name || (user.user_metadata?.display_name || user.email.split('@')[0]),
                        avatar_url: profile?.avatar_url || user.user_metadata?.avatar_url || null,
                        role: profile?.role || 'member'
                    };
                    AppState.userRole = AppState.user.role;
                    window.currentUserRole = AppState.user.role;
                    if (typeof applyRoleBasedUI === 'function') {
                        applyRoleBasedUI(AppState.user.role);
                    }
                    console.log('已更新 AppState.user 与角色:', AppState.user);
                } catch (e) {
                    console.warn('获取用户配置文件失败，使用默认角色 member:', e?.message || e);
                    AppState.user = { id: user.id, email: user.email, role: 'member' };
                    AppState.userRole = 'member';
                    window.currentUserRole = 'member';
                    if (typeof applyRoleBasedUI === 'function') {
                        applyRoleBasedUI('member');
                    }
                }
            }
            
            // 隐藏登录/注册按钮
            const unauthenticatedUI = document.getElementById('unauthenticated-ui');
            if (unauthenticatedUI) {
                unauthenticatedUI.style.display = 'none';
                console.log('已隐藏未认证UI');
            }
            
            // 显示用户信息
            const authenticatedUI = document.getElementById('authenticated-ui');
            if (authenticatedUI) {
                authenticatedUI.style.display = 'flex';
                console.log('已显示已认证UI');
                
                // 更新用户邮箱显示
                const userEmail = document.getElementById('user-email');
                if (userEmail && user) {
                    userEmail.textContent = user.email;
                    console.log('已更新用户邮箱显示:', user.email);
                }
                
                // 更新用户头像显示
                const userInitial = document.getElementById('user-initial');
                if (userInitial && user) {
                    userInitial.textContent = user.email.charAt(0).toUpperCase();
                    console.log('已更新用户头像显示:', user.email.charAt(0).toUpperCase());
                }
            }
            
            console.log('用户已登录:', currentUser.email);
            if (typeof updateAdminMenuVisibility === 'function') {
                updateAdminMenuVisibility();
            }
        }
        
        // 更新未认证用户的UI
        function updateUIForUnauthenticatedUser() {
            // 重置用户与角色状态并应用权限控制
            AppState.user = null;
            AppState.userRole = 'guest';
            window.currentUserRole = 'guest';
            if (typeof applyRoleBasedUI === 'function') {
                applyRoleBasedUI('guest');
            }
            
            // 显示登录/注册按钮
            const unauthenticatedUI = document.getElementById('unauthenticated-ui');
            if (unauthenticatedUI) {
                unauthenticatedUI.style.display = 'flex';
            }
            
            // 隐藏用户信息
            const authenticatedUI = document.getElementById('authenticated-ui');
            if (authenticatedUI) {
                authenticatedUI.style.display = 'none';
            }
            
            console.log('用户未登录');
        }
        
        // 显示个人资料
        function showProfile() {
            showNotification('个人资料功能开发中...', 'info');
            toggleUserMenu(); // 关闭菜单
        }
        
        // 显示设置页面
        function showSettings() {
            navigateTo('settings');
            toggleUserMenu(); // 关闭菜单
            loadSettingsData(); // 加载设置数据
        }

        // ==================== 设置页面功能 ====================
        
        // 显示设置选项卡
        function showSettingsTab(tabName) {
            // 移除所有选项卡的活动状态
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 激活选中的选项卡
            event.target.classList.add('active');
            document.getElementById(tabName + '-settings').classList.add('active');
        }

        // 加载设置数据
        function loadSettingsData() {
            loadGeneralSettings();
            loadAccountInfo();
            loadUsageStats();
            loadBackupHistory();
        }

        // 加载常规设置
        function loadGeneralSettings() {
            const theme = localStorage.getItem('theme') || 'light';
            const projectView = localStorage.getItem('projectView') || 'grid';
            const desktopNotifications = localStorage.getItem('desktopNotifications') === 'true';
            const taskReminders = localStorage.getItem('taskReminders') === 'true';
            
            document.getElementById('theme-select').value = theme;
            document.getElementById('project-view-select').value = projectView;
            document.getElementById('desktop-notifications').checked = desktopNotifications;
            document.getElementById('task-reminders').checked = taskReminders;
        }

        // 更改主题
        function changeTheme(theme) {
            localStorage.setItem('theme', theme);
            applyTheme(theme);
            showNotification('主题已更新', 'success');
        }

        // 应用主题
        function applyTheme(theme) {
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                theme = prefersDark ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
        }

        // 更改项目视图
        function changeProjectView(view) {
            localStorage.setItem('projectView', view);
            showNotification('项目视图已更新', 'success');
            // 如果当前在项目页面，刷新视图
            if (document.getElementById('projects').classList.contains('active')) {
                loadProjects();
            }
        }

        // 切换桌面通知
        function toggleDesktopNotifications(enabled) {
            localStorage.setItem('desktopNotifications', enabled);
            if (enabled) {
                requestNotificationPermission();
            }
            showNotification(enabled ? '桌面通知已启用' : '桌面通知已禁用', 'success');
        }

        // 切换任务提醒
        function toggleTaskReminders(enabled) {
            localStorage.setItem('taskReminders', enabled);
            showNotification(enabled ? '任务提醒已启用' : '任务提醒已禁用', 'success');
        }

        // 请求通知权限
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('通知权限已授予', 'success');
                    } else {
                        showNotification('通知权限被拒绝', 'warning');
                    }
                });
            }
        }

        // 加载账户信息
        function loadAccountInfo() {
            const accountInfoDiv = document.getElementById('account-info');
            
            if (currentUser) {
                accountInfoDiv.innerHTML = `
                    <div class="account-info-content">
                        <div class="account-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div class="account-details">
                            <div class="account-email">${currentUser.email}</div>
                            <div class="account-id">用户ID: ${currentUser.id.substring(0, 8)}...</div>
                            <div class="account-created">注册时间: ${new Date(currentUser.created_at).toLocaleDateString('zh-CN')}</div>
                        </div>
                    </div>
                `;
            } else {
                accountInfoDiv.innerHTML = `
                    <div class="account-info-empty">
                        <i class="fas fa-user-slash"></i>
                        <p>未登录</p>
                        <button class="btn btn-primary" onclick="showLoginModal()">立即登录</button>
                    </div>
                `;
            }
        }

        // 加载使用统计
        async function loadUsageStats() {
            try {
                const stats = await getUsageStats();
                document.getElementById('notes-count').textContent = stats.notes || 0;
                document.getElementById('projects-count').textContent = stats.projects || 0;
                document.getElementById('tasks-count').textContent = stats.tasks || 0;
                document.getElementById('tags-count').textContent = stats.tags || 0;
            } catch (error) {
                console.error('加载使用统计失败:', error);
                document.querySelectorAll('.stat-value').forEach(el => {
                    el.textContent = '-';
                });
            }
        }

        // 获取使用统计
        async function getUsageStats() {
            if (!isAuthenticated) {
                return { notes: 0, projects: 0, tasks: 0, tags: 0 };
            }

            try {
                const supabaseClient = getSupabaseClientOptimized();
                if (!supabaseClient) {
                    console.error('Supabase 客户端未初始化');
                    return { notes: 0, projects: 0, tasks: 0, tags: 0 };
                }

                const [notesResult, projectsResult, tagsResult] = await Promise.all([
                    supabaseClient.from('notes').select('id', { count: 'exact' }).eq('user_id', currentUser.id),
                    supabaseClient.from('projects').select('id', { count: 'exact' }).eq('user_id', currentUser.id),
                    supabaseClient.from('tags').select('id', { count: 'exact' }).eq('user_id', currentUser.id)
                ]);

                // 计算任务总数（来自所有项目）
                const tasksResult = await supabaseClient
                    .from('projects')
                    .select('tasks')
                    .eq('user_id', currentUser.id);

                let totalTasks = 0;
                if (tasksResult.data) {
                    tasksResult.data.forEach(project => {
                        if (project.tasks && Array.isArray(project.tasks)) {
                            totalTasks += project.tasks.length;
                        }
                    });
                }

                return {
                    notes: notesResult.count || 0,
                    projects: projectsResult.count || 0,
                    tasks: totalTasks,
                    tags: tagsResult.count || 0
                };
            } catch (error) {
                console.error('获取使用统计失败:', error);
                return { notes: 0, projects: 0, tasks: 0, tags: 0 };
            }
        }

        // ==================== 备份恢复功能 ====================
        
        // 创建手动备份
        async function createManualBackup() {
            if (!window.backupRestoreTool) {
                showNotification('备份工具未初始化', 'error');
                return;
            }

            try {
                showNotification('正在创建备份...', 'info');
                await window.backupRestoreTool.createBackup();
                showNotification('备份创建成功', 'success');
                loadBackupHistory();
            } catch (error) {
                console.error('创建备份失败:', error);
                showNotification('备份创建失败: ' + error.message, 'error');
            }
        }

        // 显示恢复对话框
        function showRestoreDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        showNotification('正在恢复数据...', 'info');
                        await window.backupRestoreTool.importFromFile(file);
                        showNotification('数据恢复成功', 'success');
                        // 刷新页面数据
                        location.reload();
                    } catch (error) {
                        console.error('数据恢复失败:', error);
                        showNotification('数据恢复失败: ' + error.message, 'error');
                    }
                }
            };
            input.click();
        }

        // 导出数据到文件
        async function exportDataToFile() {
            if (!window.backupRestoreTool) {
                showNotification('备份工具未初始化', 'error');
                return;
            }

            try {
                showNotification('正在导出数据...', 'info');
                await window.backupRestoreTool.exportToFile();
                showNotification('数据导出成功', 'success');
            } catch (error) {
                console.error('数据导出失败:', error);
                showNotification('数据导出失败: ' + error.message, 'error');
            }
        }

        // 加载备份历史
        function loadBackupHistory() {
            const historyDiv = document.getElementById('backup-history');
            const backups = JSON.parse(localStorage.getItem('backup_history') || '[]');
            
            if (backups.length === 0) {
                historyDiv.innerHTML = `
                    <div class="backup-history-empty">
                        <i class="fas fa-archive"></i>
                        <p>暂无备份记录</p>
                        <small>创建您的第一个备份以保护数据安全</small>
                    </div>
                `;
                return;
            }

            historyDiv.innerHTML = backups.map(backup => `
                <div class="backup-item">
                    <div class="backup-item-info">
                        <div class="backup-item-name">${backup.name}</div>
                        <div class="backup-item-date">${new Date(backup.timestamp).toLocaleString('zh-CN')}</div>
                        <div class="backup-item-size">${formatFileSize(backup.size)}</div>
                    </div>
                    <div class="backup-item-actions">
                        <button class="btn btn-sm btn-outline" onclick="restoreFromBackup('${backup.id}')">
                            <i class="fas fa-undo"></i>
                            恢复
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBackup('${backup.id}')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 从备份恢复
        async function restoreFromBackup(backupId) {
            if (!confirm('确定要从此备份恢复数据吗？这将覆盖当前所有数据！')) {
                return;
            }

            try {
                showNotification('正在恢复数据...', 'info');
                await window.backupRestoreTool.restoreFromBackup(backupId);
                showNotification('数据恢复成功', 'success');
                location.reload();
            } catch (error) {
                console.error('数据恢复失败:', error);
                showNotification('数据恢复失败: ' + error.message, 'error');
            }
        }

        // 删除备份
        function deleteBackup(backupId) {
            if (!confirm('确定要删除此备份吗？')) {
                return;
            }

            try {
                window.backupRestoreTool.deleteBackup(backupId);
                showNotification('备份已删除', 'success');
                loadBackupHistory();
            } catch (error) {
                console.error('删除备份失败:', error);
                showNotification('删除备份失败: ' + error.message, 'error');
            }
        }

        // 切换自动备份
        function toggleAutoBackup(enabled) {
            localStorage.setItem('autoBackup', enabled);
            showNotification(enabled ? '自动备份已启用' : '自动备份已禁用', 'success');
        }

        // ==================== 危险操作 ====================
        
        // 显示清空数据对话框
        function showClearDataDialog() {
            // 权限校验：仅管理员或所有者可执行
            if (!isAdmin()) {
                showNotification('权限不足：仅管理员可清空数据', 'warning');
                return;
            }
            if (!confirm('⚠️ 警告：此操作将永久删除您的所有数据！\n\n包括：\n- 所有笔记\n- 所有项目\n- 所有标签\n- 所有设置\n\n此操作不可恢复！确定要继续吗？')) {
                return;
            }

            if (!confirm('请再次确认：您真的要清空所有数据吗？\n\n建议在清空前先创建备份。')) {
                return;
            }

            clearAllData();
        }

        // 清空所有数据
        async function clearAllData() {
            // 双重校验防止绕过对话框
            if (!isAdmin()) {
                showNotification('权限不足：仅管理员可清空数据', 'warning');
                return;
            }
            try {
                showNotification('正在清空数据...', 'info');
                
                if (window.backupRestoreTool) {
                    await window.backupRestoreTool.clearUserData();
                }
                
                showNotification('所有数据已清空', 'success');
                
                // 延迟刷新页面
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('清空数据失败:', error);
                showNotification('清空数据失败: ' + error.message, 'error');
            }
        }

        // 显示删除账户对话框
        function showDeleteAccountDialog() {
            // 权限校验：仅管理员或所有者可执行
            if (!isAdmin()) {
                showNotification('权限不足：仅管理员可删除账户', 'warning');
                return;
            }
            if (!confirm('⚠️ 警告：此操作将永久删除您的账户和所有相关数据！\n\n此操作不可恢复！确定要继续吗？')) {
                return;
            }

            const email = prompt('请输入您的邮箱地址以确认删除账户：');
            if (!email || email !== currentUser.email) {
                showNotification('邮箱地址不匹配，操作已取消', 'warning');
                return;
            }

            deleteAccount();
        }

        // 删除账户
        async function deleteAccount() {
            // 双重校验防止绕过入口
            if (!isAdmin()) {
                showNotification('权限不足：仅管理员可删除账户', 'warning');
                return;
            }
            try {
                showNotification('正在删除账户...', 'info');
                
                // 首先清空用户数据
                if (window.backupRestoreTool) {
                    await window.backupRestoreTool.clearUserData();
                }
                
                // 注销用户
                const supabaseClient = getSupabaseClientOptimized();
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                
                showNotification('账户已删除', 'success');
                
                // 重定向到登录页面
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('删除账户失败:', error);
                showNotification('删除账户失败: ' + error.message, 'error');
            }
        }
        
        // 设置认证状态监听器
        async function setupAuthListener() {
            // 获取已初始化的 Supabase 客户端
            const supabaseClient = getSupabaseClientOptimized();
            
            if (!supabaseClient) {
                console.error('Supabase 客户端初始化失败，无法设置认证监听器');
                return;
            }
            
            // 注意：认证状态监听器已在 supabase.js 中设置，这里不再重复设置
            // 避免多个监听器同时触发导致无限循环
            console.log('🔵 认证状态监听器已在 supabase.js 中设置，跳过重复设置');
        }

        // 健壮的登录按钮处理函数
        function handleLoginButtonClick() {
            console.log('🔴 登录按钮被点击!');
            console.log('🔵 当前时间:', new Date().toLocaleTimeString());
            
            try {
                // 检查页面是否完全加载
                if (document.readyState !== 'complete') {
                    console.log('⚠️ 页面尚未完全加载，等待加载完成...');
                    setTimeout(handleLoginButtonClick, 100);
                    return;
                }
                
                // 检查必要的函数是否存在
                if (typeof showLoginModal !== 'function') {
                    console.error('❌ showLoginModal 函数不存在');
                    alert('错误：登录功能尚未加载完成，请稍后再试');
                    return;
                }
                
                // 检查模态框元素是否存在
                const modal = document.getElementById('loginModal');
                if (!modal) {
                    console.error('❌ 登录模态框元素不存在');
                    alert('错误：登录界面元素未找到，请刷新页面重试');
                    return;
                }
                
                console.log('✅ 所有检查通过，调用 showLoginModal');
                showLoginModal();
                
            } catch (error) {
                console.error('❌ 登录按钮处理出错:', error);
                alert('登录功能出现错误，请刷新页面重试');
            }
        }

        // 认证相关函数
        function showLoginModal() {
            console.log('🔵 showLoginModal 函数被调用');
            console.log('🔵 当前时间:', new Date().toLocaleTimeString());
            
            try {
                // 重置登录状态标志
                window.isLoggingIn = false;
                console.log('🔵 重置登录状态标志');
                
                const modal = document.getElementById('loginModal');
                console.log('🔵 登录模态框元素:', modal);
                
                if (!modal) {
                    console.error('❌ 找不到登录模态框元素 #loginModal');
                    alert('错误：找不到登录模态框元素，请刷新页面重试');
                    return false;
                }
                
                // 重置登录按钮状态
                const loginBtn = document.querySelector('#loginModal .modal-btn-confirm');
                if (loginBtn) {
                    resetLoginButton(loginBtn);
                    console.log('🔵 登录按钮状态已重置');
                }
                
                // 清空表单
                const emailInput = document.getElementById('loginEmail');
                const passwordInput = document.getElementById('loginPassword');
                if (emailInput) emailInput.value = '';
                if (passwordInput) passwordInput.value = '';
                console.log('🔵 表单已清空');
                
                // 确保模态框可见
                console.log('🔵 模态框当前类名:', modal.className);
                
                // 清除任何可能的内联样式，让CSS类完全控制
                modal.style.display = '';
                modal.style.visibility = '';
                modal.style.transform = '';
                modal.style.opacity = '';
                
                // 使用CSS类控制显示
                modal.classList.add('show');
                console.log('🔵 添加show类后的类名:', modal.className);
                
                // Hide resend confirmation link in the login modal if present (safety)
                const resendLinkInLogin = document.querySelector('#loginModal #resendConfirmLink');
                if (resendLinkInLogin) {
                    resendLinkInLogin.style.display = 'none';
                    console.log('🔒 已隐藏登录窗口中的“重新发送确认邮件”链接');
                }
                
                // 延迟设置焦点，确保模态框已显示
                setTimeout(() => {
                    if (emailInput) {
                        emailInput.focus();
                        console.log('🔵 邮箱输入框已获得焦点');
                    } else {
                        console.error('❌ 找不到邮箱输入框元素 #loginEmail');
                    }
                }, 100);
                
                console.log('✅ 登录模态框显示完成');
                
                // 添加一个可见的提示
                if (typeof showNotification === 'function') {
                    showNotification('登录窗口已打开', 'success');
                } else {
                    console.log('📢 登录窗口已成功打开');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ showLoginModal 执行出错:', error);
                alert('显示登录窗口时出现错误，请刷新页面重试');
                return false;
            }
        }

        function closeLoginModal() {
            console.log('🔴 === 开始关闭登录模态框 ===');
            
            const modal = document.getElementById('loginModal');
            if (modal) {
                console.log('🔴 找到模态框元素，当前状态:', {
                    className: modal.className,
                    display: modal.style.display,
                    visible: modal.offsetParent !== null
                });
                
                // 使用CSS类控制显示/隐藏，避免直接操作style属性
                modal.classList.remove('show');
                
                // 清除任何可能的内联样式，让CSS类完全控制
                modal.style.display = '';
                modal.style.visibility = '';
                modal.style.transform = '';
                modal.style.opacity = '';
                
                console.log('🔴 模态框已隐藏，新状态:', {
                    className: modal.className,
                    display: modal.style.display
                });
            } else {
                console.error('❌ 找不到登录模态框元素');
            }
            
            // 清空表单
            const emailInput = document.getElementById('loginEmail');
            const passwordInput = document.getElementById('loginPassword');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            console.log('🔴 表单已清空');
            
            // 重置登录按钮状态
            const loginBtn = document.querySelector('#loginModal .modal-btn-confirm');
            if (loginBtn) {
                resetLoginButton(loginBtn);
                console.log('🔴 登录按钮状态已重置');
            }
            
            // 重置登录状态标志
            if (window.isLoggingIn) {
                window.isLoggingIn = false;
                console.log('🔴 重置登录状态标志');
            }
            
            console.log('🔴 === 登录模态框关闭完成 ===');
            
            console.log('登录模态框已关闭');
        }

        // 强制关闭所有模态框的函数（用于登录成功后的保险措施）
        function forceCloseAllModals() {
            console.log('🔒 === 强制关闭所有模态框 ===');
            
            const modals = ['loginModal', 'registerModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                    modal.style.visibility = 'hidden';
                    console.log(`🔒 强制关闭模态框: ${modalId}`);
                    
                    // 延迟恢复visibility
                    setTimeout(() => {
                        modal.style.visibility = '';
                    }, 100);
                }
            });
            
            console.log('🔒 === 所有模态框强制关闭完成 ===');
        }

        function showRegisterModal() {
            const modal = document.getElementById('registerModal');
            modal.classList.add('show');
            document.getElementById('registerEmail').focus();
            // Ensure resend link is visible when register modal is open
            const resendLink = modal.querySelector('#resendConfirmLink');
            if (resendLink) {
                resendLink.style.display = 'inline-block';
            }
        }

        function closeRegisterModal() {
            const modal = document.getElementById('registerModal');
            modal.classList.remove('show');
            // 清空表单
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function switchToRegister() {
            closeLoginModal();
            showRegisterModal();
        }

        function switchToLogin() {
            closeRegisterModal();
            showLoginModal();
        }

        // 重新发送确认邮件
        async function resendConfirmation() {
            // 优先读取注册框的邮箱，其次读取登录框的邮箱
            const registerInput = document.getElementById('registerEmail');
            const loginInput = document.getElementById('loginEmail');
            const email = (registerInput && registerInput.value.trim()) || (loginInput && loginInput.value.trim()) || '';
            
            if (!email) {
                showNotification('请先输入邮箱地址', 'error');
                return;
            }

            try {
                const supabaseClient = getSupabaseClientOptimized();
                if (!supabaseClient) {
                    showNotification('Supabase 客户端未初始化', 'error');
                    return;
                }

                const { error } = await supabaseClient.auth.resend({
                    type: 'signup',
                    email: email
                });

                if (error) {
                    showNotification('发送失败：' + error.message, 'error');
                } else {
                    showNotification('确认邮件已重新发送，请检查您的邮箱', 'success');
                }
            } catch (error) {
                showNotification('发送过程中发生错误', 'error');
                console.error('Resend confirmation error:', error);
            }
        }

        // 添加登录状态标志，防止重复登录
        let isLoggingIn = false;

        async function handleLogin(event) {
            // ✅ 阻止表单默认提交行为
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                console.log('✅ 已阻止默认表单提交行为');
            }
            
            console.log('=== 开始登录流程 ===');
            console.log('handleLogin 函数被调用');
            console.log('⏱️ 登录开始时间:', new Date().toISOString());
            
            // 防止重复登录
            if (isLoggingIn) {
                console.log('登录正在进行中，忽略重复请求');
                return;
            }
            
            // 获取登录按钮
            const loginBtn = document.querySelector('#loginModal .modal-btn-confirm');
            if (!loginBtn) {
                console.error('❌ 找不到登录按钮');
                showNotification('界面错误：找不到登录按钮', 'error');
                return;
            }
            
            // 检查登录按钮状态
            console.log('登录按钮状态:', loginBtn.disabled ? '禁用' : '启用');
            
            // 设置登录状态标志
            isLoggingIn = true;
            
            // 更新按钮状态
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';
            loginBtn.classList.add('loading');
            
            // 添加超时保护，确保登录状态不会永久卡住
            const timeoutId = setTimeout(() => {
                console.error('⚠️ 登录流程超时（40秒），强制重置状态');
                resetLoginButton(loginBtn);
                isLoggingIn = false;
                showNotification('登录超时，请检查网络连接后重试', 'error');
            }, 40000); // 40秒超时保护
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            console.log('获取到的邮箱:', email);
            console.log('密码长度:', password ? password.length : 0);

            if (!email || !password) {
                console.log('登录信息不完整');
                showNotification('请填写完整的登录信息', 'error');
                clearTimeout(timeoutId);
                resetLoginButton(loginBtn);
                isLoggingIn = false;
                return;
            }

            // 验证邮箱格式
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                console.log('邮箱格式无效');
                showNotification('请输入有效的邮箱地址', 'error');
                clearTimeout(timeoutId);
                resetLoginButton(loginBtn);
                isLoggingIn = false;
                return;
            }

            try {
                console.log('🚀 开始调用优化版 signInUserOptimized 函数...');
                console.log('🔍 当前网络状态:', navigator.onLine ? '在线' : '离线');
                
                // 使用优化版的登录函数
                const result = await signInUserOptimized(email, password);
                
                console.log('⏱️ 登录结束时间:', new Date().toISOString());
                console.log('signInUserOptimized 返回结果:', result);
                console.log('result.success:', result.success);
                console.log('result.user:', result.user);
                console.log('result.error:', result.error);
                
                // 清除超时保护
                clearTimeout(timeoutId);
                
                if (result.success && result.user) {
                    console.log('✅ 登录成功，用户信息:', result.user);
                    
                    // 显示登录成功通知
                    showNotification('登录成功！正在为您准备工作空间...', 'success');
                    
                    // 更新按钮状态为成功
                    loginBtn.textContent = '登录成功！';
                    loginBtn.classList.remove('loading');
                    loginBtn.classList.add('success');
                    
                    try {
                        // 使用优化版的登录成功处理函数（并行处理）
                        console.log('🚀 准备调用优化版 onUserSignedInOptimized 函数...');
                        await onUserSignedInOptimized(result.user);
                        console.log('✅ onUserSignedInOptimized 调用完成');
                        
                        // 立即更新UI状态（包含关闭模态框）
                        console.log('🚀 准备更新UI状态...');
                        await updateUIForAuthenticatedUser(result.user);
                        console.log('✅ UI状态更新完成');
                        
                        // ⏸️ 暂时禁用自动数据加载，防止循环
                        console.log('⏸️ 跳过自动数据加载，防止循环');
                        // 原有的数据加载逻辑已禁用
                        
                        // 额外保险：延迟强制关闭所有模态框
                        setTimeout(() => {
                            console.log('🔒 执行延迟强制关闭模态框保险措施');
                            forceCloseAllModals();
                        }, 500);
                        
                        // 延迟重置登录按钮状态
                        setTimeout(() => {
                            resetLoginButton(loginBtn);
                            isLoggingIn = false;
                        }, 1500);
                        
                    } catch (postLoginError) {
                        console.error('❌ 登录后处理失败:', postLoginError);
                        console.error('❌ 错误堆栈:', postLoginError.stack);
                        
                        // 即使后续处理失败，也要关闭登录模态框
                        showNotification('登录成功，但初始化用户数据时出现问题', 'warning');
                        closeLoginModal();
                        resetLoginButton(loginBtn);
                        isLoggingIn = false;
                    }
                    
                } else {
                    console.log('❌ 登录失败，错误信息:', result.error);
                    
                    // 根据错误类型显示不同的通知
                    if (result.error && result.error.includes('Email not confirmed')) {
                        showNotification('邮箱未确认，请检查您的邮箱并点击确认链接，或联系管理员', 'error');
                    } else if (result.error && result.error.includes('Invalid login credentials')) {
                        showNotification('邮箱或密码错误，请检查后重试', 'error');
                    } else if (result.error && (result.error.includes('timeout') || result.error.includes('超时'))) {
                        showNotification('登录请求超时，请检查网络连接后重试', 'error');
                    } else if (result.error && (result.error.includes('network') || result.error.includes('网络'))) {
                        showNotification('网络连接失败，请检查网络后重试', 'error');
                    } else if (result.error && result.error.includes('Too many requests')) {
                        showNotification('请求过于频繁，请稍后再试', 'warning');
                    } else {
                        showNotification('登录失败：' + (result.error || '未知错误'), 'error');
                    }
                    
                    resetLoginButton(loginBtn);
                    isLoggingIn = false;
                }
            } catch (error) {
                console.error('❌ 登录过程中发生异常:', error);
                console.error('❌ 异常堆栈:', error.stack);
                console.error('❌ 异常类型:', error.constructor.name);
                
                // 清除超时保护
                clearTimeout(timeoutId);
                
                // 根据异常类型提供友好的错误信息
                let errorMessage = '登录过程中发生错误，请重试';
                if (error.message.includes('timeout') || error.message.includes('超时')) {
                    errorMessage = '登录请求超时，请检查网络连接后重试';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = '网络连接失败，请检查网络后重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = '无法连接到服务器，请检查网络连接';
                }
                
                showNotification(errorMessage, 'error');
                resetLoginButton(loginBtn);
                isLoggingIn = false;
            }
            
            console.log('=== 登录流程结束 ===');
        }

        // 重置登录按钮状态的辅助函数
        function resetLoginButton(loginBtn) {
            if (loginBtn) {
                console.log('重置登录按钮状态');
                loginBtn.disabled = false;
                loginBtn.textContent = '登录';
                loginBtn.classList.remove('loading', 'success');
                
                // 确保按钮可以正常点击
                loginBtn.style.pointerEvents = 'auto';
                loginBtn.style.opacity = '1';
                
                console.log('登录按钮状态已重置');
            } else {
                console.warn('⚠️ resetLoginButton: 按钮元素不存在');
            }
        }

        async function handleRegister() {
            console.log('=== 开始注册流程 ===');
            
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            console.log('注册邮箱:', email);
            console.log('密码长度:', password ? password.length : 0);

            if (!email || !password || !confirmPassword) {
                showNotification('请填写完整的注册信息', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showNotification('两次输入的密码不一致', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('密码长度至少为6位', 'error');
                return;
            }

            // 邮箱格式验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showNotification('请输入有效的邮箱地址', 'error');
                return;
            }

            try {
                console.log('开始调用 signUpUser 函数...');
                // 使用 Supabase 配置文件中的注册函数
                const result = await signUpUser(email, password);
                console.log('signUpUser 返回结果:', result);
                
                if (result.success) {
                    console.log('✅ 注册成功');
                    showNotification('注册成功！请检查邮箱验证邮件', 'success');
                    closeRegisterModal();
                    
                    // 清空表单
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                } else {
                    console.log('❌ 注册失败:', result.error);
                    if (result.error && result.error.includes('User already registered')) {
                        showNotification('该邮箱已被注册，请使用其他邮箱或直接登录', 'error');
                    } else {
                        showNotification('注册失败：' + (result.error || '未知错误'), 'error');
                    }
                }
            } catch (error) {
                console.error('❌ 注册过程中发生异常:', error);
                showNotification('注册过程中发生错误：' + error.message, 'error');
            }
            
            console.log('=== 注册流程结束 ===');
        }

        async function handleLogout() {
            console.log('=== 开始登出流程 ===');
            
            try {
                console.log('开始调用 signOutUserOptimized 函数...');
                // 使用 Supabase 优化配置文件中的登出函数
                const result = await signOutUserOptimized();
                console.log('signOutUser 返回结果:', result);
                
                if (result.success) {
                    console.log('✅ 登出成功');
                    showNotification('已成功登出', 'success');
                    
                    // 手动清理应用状态
                    try {
                        await clearAppState();
                        console.log('✅ 应用状态清理完成');
                    } catch (clearError) {
                        console.error('❌ 应用状态清理失败:', clearError);
                    }
                    
                    // 更新UI为未认证状态
                    try {
                        updateUIForUnauthenticatedUser();
                        console.log('✅ UI状态更新完成');
                    } catch (uiError) {
                        console.error('❌ UI状态更新失败:', uiError);
                    }
                } else {
                    console.log('❌ 登出失败:', result.error);
                    showNotification('登出失败：' + (result.error || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('❌ 登出过程中发生异常:', error);
                showNotification('登出过程中发生错误：' + error.message, 'error');
            }
            
            console.log('=== 登出流程结束 ===');
        }

        function toggleUserMenu() {
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.style.display = userMenu.style.display === 'none' ? 'block' : 'none';
            }
        }

        // 点击其他地方关闭用户菜单
        document.addEventListener('click', function(e) {
            const userMenu = document.querySelector('.user-menu');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (userMenu && userAvatar && !userAvatar.contains(e.target) && !userMenu.contains(e.target)) {
                userMenu.style.display = 'none';
            }
        });

        // 自定义模态对话框功能
        let modalResolve = null;
        
        function showCustomModal(title, placeholder = '', defaultValue = '') {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalInput = document.getElementById('modalInput');
                
                modalTitle.textContent = title;
                modalInput.placeholder = placeholder;
                modalInput.value = defaultValue;
                
                modal.classList.add('show');
                modalInput.focus();
                modalInput.select();
                
                // 支持回车键确认
                modalInput.onkeydown = function(e) {
                    if (e.key === 'Enter') {
                        confirmCustomModal();
                    } else if (e.key === 'Escape') {
                        closeCustomModal();
                    }
                };
            });
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.classList.remove('show');
            
            if (modalResolve) {
                modalResolve(null);
                modalResolve = null;
            }
        }
        
        function confirmCustomModal() {
            const modalInput = document.getElementById('modalInput');
            const value = modalInput.value.trim();
            
            const modal = document.getElementById('customModal');
            modal.classList.remove('show');
            
            if (modalResolve) {
                modalResolve(value || null);
                modalResolve = null;
            }
        }

        // 显示数据迁移确认对话框
        async function showMigrationConfirmDialog() {
            return new Promise((resolve) => {
                console.log('🔄 显示数据迁移确认对话框');
                
                const modal = document.getElementById('customModal');
                if (!modal) {
                    console.error('❌ 找不到模态框元素 #customModal');
                    // 如果找不到模态框，直接跳过迁移
                    localStorage.setItem('cogninote-migration-status', 'skipped');
                    resolve();
                    return;
                }
                
                const title = modal.querySelector('.modal-title');
                const input = modal.querySelector('#modalInput');
                
                title.textContent = '🔄 数据迁移确认';
                
                // 创建内容显示区域
                let contentDiv = modal.querySelector('.migration-content');
                if (!contentDiv) {
                    contentDiv = document.createElement('div');
                    contentDiv.className = 'migration-content';
                    contentDiv.style.cssText = 'padding: 20px; text-align: center; line-height: 1.6; font-size: 16px;';
                    
                    // 安全地插入内容区域
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        // 如果input存在且是modalContent的子元素，则在其前面插入
                        if (input && modalContent.contains(input)) {
                            modalContent.insertBefore(contentDiv, input);
                        } else {
                            // 否则直接添加到modalContent的开头
                            modalContent.insertBefore(contentDiv, modalContent.firstChild);
                        }
                    } else {
                        console.error('❌ 找不到 .modal-content 元素');
                        localStorage.setItem('cogninote-migration-status', 'skipped');
                        resolve();
                        return;
                    }
                }
                
                contentDiv.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin-bottom: 20px;">
                        <strong>⚠️ 检测到本地数据</strong><br>
                        是否要将其迁移到云端？
                    </div>
                    <p style="color: #666; font-size: 14px;">
                        点击"确定"迁移数据，点击"取消"跳过迁移。<br>
                        <strong>注意：如果不迁移，本地数据将保留但不会同步到云端。</strong>
                    </p>
                `;
                
                // 隐藏输入框
                if (input) {
                    input.style.display = 'none';
                }
                
                // 保存原始的确认和取消函数
                const originalConfirm = window.confirmCustomModal;
                const originalClose = window.closeCustomModal;
                
                // 设置确认回调
                window.confirmCustomModal = async () => {
                    console.log('✅ 用户选择迁移数据');
                    modal.classList.remove('show');
                    
                    try {
                        showNotification('正在迁移数据...', 'info');
                        
                        // 检查数据迁移工具是否存在
                        if (window.dataMigrationTool && typeof window.dataMigrationTool.migrate === 'function') {
                            await window.dataMigrationTool.migrate();
                            showNotification('数据迁移完成！', 'success');
                            console.log('✅ 数据迁移完成');
                        } else {
                            console.warn('⚠️ 数据迁移工具不可用，跳过迁移');
                            showNotification('数据迁移工具不可用，将继续使用云端数据', 'warning');
                        }
                        
                        localStorage.setItem('cogninote-migration-status', 'completed');
                    } catch (migrationError) {
                        console.error('❌ 数据迁移失败:', migrationError);
                        showNotification('数据迁移失败，将继续使用云端数据', 'warning');
                        localStorage.setItem('cogninote-migration-status', 'failed');
                    }
                    
                    await completeLoginProcess();
                    
                    // 恢复原始函数
                    window.confirmCustomModal = originalConfirm;
                    window.closeCustomModal = originalClose;
                    resolve();
                };
                
                // 设置取消回调
                window.closeCustomModal = async () => {
                    console.log('❌ 用户选择跳过数据迁移');
                    modal.classList.remove('show');
                    
                    // 用户选择跳过迁移，标记为已跳过避免重复提示
                    localStorage.setItem('cogninote-migration-status', 'skipped');
                    showNotification('已跳过数据迁移', 'info');
                    
                    await completeLoginProcess();
                    
                    // 恢复原始函数
                    window.confirmCustomModal = originalConfirm;
                    window.closeCustomModal = originalClose;
                    resolve();
                };
                
                // 强制显示模态框
                modal.style.display = 'flex';
                modal.classList.add('show');
                
                // 添加超时处理，30秒后自动跳过
                const timeoutId = setTimeout(() => {
                    console.warn('⏰ 数据迁移对话框超时，自动跳过迁移');
                    if (modal.classList.contains('show')) {
                        window.closeCustomModal();
                    }
                }, 30000);
                
                // 当对话框关闭时清除超时
                const originalResolve = resolve;
                resolve = (...args) => {
                    clearTimeout(timeoutId);
                    originalResolve(...args);
                };
                
                console.log('✅ 数据迁移对话框已显示，等待用户操作...');
                showNotification('请选择是否迁移本地数据到云端', 'info');
            });
        }

        // 完成登录流程
        async function completeLoginProcess() {
            try {
                await loadUserData();
                updateUIForAuthenticatedUser();
                console.log('用户登录成功，数据加载完成');
            } catch (error) {
                console.error('加载用户数据失败:', error);
                showNotification('加载用户数据失败', 'error');
            }
        }
        
        // 应用状态管理
        const AppState = {
            currentPage: 'dashboard',
            currentTheme: 'light',
            currentNote: null,
            notes: [], // 初始为空，登录后从服务器加载用户数据
            projects: [],
            tasks: [],
            isKanbanView: true,
            // 角色与用户信息（默认未登录为 guest）
            user: null,
            userRole: 'guest'
        };
        
        // 角色权限辅助函数
        window.ADMIN_EMAILS = window.ADMIN_EMAILS || ['15274410535@163.com'];
        function isAdmin(role = null) {
            const r = role || AppState.userRole;
            // 当未从后端拿到角色时，根据邮箱判断超级管理员（owner）
            const email = AppState?.user?.email || '';
            const emailIsAdmin = Array.isArray(window.ADMIN_EMAILS) && window.ADMIN_EMAILS.includes(email);
            return r === 'admin' || r === 'owner' || emailIsAdmin;
        }
        
        // 角色调试 banner（不遮挡导航栏）
        function updateRoleBanner(role) {
            try {
                const id = 'role-debug-banner';
                let banner = document.getElementById(id);
                const current = role || (typeof AppState !== 'undefined' ? AppState.userRole : 'guest') || 'guest';
                const text = `当前角色：${current}${current === 'owner' ? ' 🎉' : ''}`;

                const computeTopOffset = () => {
                    const nb = document.querySelector('.navbar');
                    // 读取导航栏高度，给一个合理的兜底值
                    return nb ? nb.offsetHeight : 60;
                };

                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = id;
                    banner.style.position = 'fixed';
                    banner.style.left = '0';
                    banner.style.right = '0';
                    banner.style.width = '100%';
                    banner.style.background = '#FFFBE6'; // 柔和的黄色
                    banner.style.color = '#000';
                    banner.style.padding = '6px 12px';
                    banner.style.fontWeight = 'bold';
                    banner.style.textAlign = 'center';
                    banner.style.zIndex = '900'; // 低于导航栏(1000)
                    banner.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
                    banner.style.pointerEvents = 'none'; // 不拦截点击
                    // 初始位置：紧贴导航栏下方
                    banner.style.top = computeTopOffset() + 'px';

                    // 插入到导航栏后面
                    const navbar = document.querySelector('.navbar');
                    if (navbar && navbar.parentNode) {
                        navbar.parentNode.insertBefore(banner, navbar.nextSibling);
                    } else {
                        document.body.insertBefore(banner, document.body.firstChild);
                    }

                    // 根据窗口变化动态更新位置
                    window.addEventListener('resize', () => {
                        banner.style.top = computeTopOffset() + 'px';
                    });
                }

                banner.textContent = text;
                banner.hidden = false;
            } catch (e) {
                console.warn('更新角色调试 banner 失败:', e);
            }
        }
        
        function applyRoleBasedUI(role = null) {
             try { updateRoleBanner(role || AppState.userRole); } catch (e) { /* no-op */ }
             const isAdminUser = isAdmin(role);
             // 危险操作区域整体隐藏/显示
             const dangerZone = document.querySelector('.danger-zone');
             if (dangerZone) {
                 dangerZone.style.display = isAdminUser ? '' : 'none';
             }
             // 单独确保按钮隐藏（防止结构变更）
             const clearBtn = document.querySelector('button.btn.btn-danger[onclick="showClearDataDialog()"]');
             if (clearBtn) {
                 clearBtn.style.display = isAdminUser ? '' : 'none';
             }
             const deleteAccountBtn = document.querySelector('button.btn.btn-danger[onclick="showDeleteAccountDialog()"]');
             if (deleteAccountBtn) {
                 deleteAccountBtn.style.display = isAdminUser ? '' : 'none';
             }
             // 其他需要管理员权限的入口可在此统一控制
             // 如：系统级数据迁移、调试入口等（当前未暴露额外入口）
         }
        
        // 演示数据（仅用于未登录状态展示）
        const DemoData = {
            notes: [
                {
                    id: 'demo-note-1',
                    title: '项目规划',
                    content: '这是一个关于项目规划的笔记。包含了项目的目标、时间线和关键里程碑。需要定期更新进度和调整计划。',
                    createdAt: new Date('2024-01-15').toISOString(),
                    updatedAt: new Date('2024-01-20').toISOString(),
                    isFavorite: true,
                    tags: ['工作', '规划']
                },
                {
                    id: 'demo-note-2',
                    title: '学习笔记',
                    content: 'JavaScript ES6新特性学习笔记：箭头函数、解构赋值、模板字符串、Promise等。这些特性大大提升了代码的可读性和开发效率。',
                    createdAt: new Date('2024-01-18').toISOString(),
                    updatedAt: new Date('2024-01-22').toISOString(),
                    isFavorite: false,
                    tags: ['学习', '技术']
                },
                {
                    id: 'demo-note-3',
                    title: '会议记录',
                    content: '团队周会记录：讨论了本周的工作进展，确定了下周的重点任务。需要跟进的事项包括代码审查和测试用例编写。',
                    createdAt: new Date('2024-01-19').toISOString(),
                    updatedAt: new Date('2024-01-19').toISOString(),
                    isFavorite: true,
                    tags: ['会议', '工作']
                },
                {
                    id: 'demo-note-4',
                    title: '读书笔记',
                    content: '《代码整洁之道》读书笔记：好的代码应该是自解释的，变量和函数命名要清晰明了，函数应该保持简短并只做一件事。',
                    createdAt: new Date('2024-01-16').toISOString(),
                    updatedAt: new Date('2024-01-21').toISOString(),
                    isFavorite: false,
                    tags: ['读书', '编程']
                },
                {
                    id: 'demo-note-5',
                    title: '想法记录',
                    content: '关于产品改进的一些想法：用户界面可以更加简洁，增加快捷键支持，优化搜索功能的响应速度。',
                    createdAt: new Date('2024-01-17').toISOString(),
                    updatedAt: new Date('2024-01-23').toISOString(),
                    isFavorite: true,
                    tags: ['想法', '产品']
                }
            ]
        };

        // 页面导航
        function navigateTo(page) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(page);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const navItem = document.querySelector(`[data-page="${page}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            AppState.currentPage = page;
            
            // 页面特定初始化
            if (page === 'notes') {
                initializeNotesPage();
            } else if (page === 'projects') {
                loadProjects();
            } else if (page === 'dashboard') {
                updateDashboard();
            }
            
            saveAppState();
        }

        // 快速操作函数
        async function createNewNoteAndNavigate() {
            await createNewNote();
            navigateTo('notes');
        }

        async function createNewProjectAndNavigate() {
            await createNewProject();
            navigateTo('projects');
        }

        // 主题切换
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            AppState.currentTheme = theme;
            
            // 更新主题按钮状态
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const themeBtn = document.querySelector(`[onclick="setTheme('${theme}')"]`);
            if (themeBtn) {
                themeBtn.classList.add('active');
            }
            
            saveAppState();
        }

        // 通知系统
        function showNotification(message, type = 'info', title = '提示') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'fas fa-check',
                warning: 'fas fa-exclamation-triangle',
                error: 'fas fa-times',
                info: 'fas fa-info'
            };
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-icon">
                        <i class="${icons[type]}"></i>
                    </div>
                    <div class="notification-title">${title}</div>
                    <button class="notification-close" onclick="closeNotification(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-content">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // 显示动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动关闭
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNotification(notification.querySelector('.notification-close'));
                }
            }, 5000);
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }

        // 特殊的登录成功通知
        function showLoginSuccessNotification(message, title = '登录成功') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = 'notification login-success';
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="notification-title">${title}</div>
                    <button class="notification-close" onclick="closeNotification(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-content">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // 显示动画
            setTimeout(() => notification.classList.add('show'), 100);
            
            // 自动关闭（延长时间让用户看到效果）
            setTimeout(() => {
                if (notification.parentNode) {
                    closeNotification(notification.querySelector('.notification-close'));
                }
            }, 6000);
        }

        // 笔记功能
        function initializeNotesPage() {
            try {
                // 确保编辑器是隐藏的，概览是显示的
                const noteEditor = document.getElementById('note-editor');
                const notesOverview = document.getElementById('notes-overview-section');
                
                if (noteEditor) {
                    noteEditor.style.display = 'none';
                } else {
                    console.warn('⚠️ note-editor 元素未找到');
                }
                
                if (notesOverview) {
                    notesOverview.style.display = 'block';
                } else {
                    console.warn('⚠️ notes-overview-section 元素未找到');
                }
                
                // 默认激活"全部笔记"标签页
                const overviewTabs = document.querySelectorAll('.overview-tab');
                if (overviewTabs.length > 0) {
                    overviewTabs.forEach(tab => {
                        tab.classList.remove('active');
                    });
                } else {
                    console.warn('⚠️ overview-tab 元素未找到');
                }
                
                const allNotesTab = document.querySelector('[onclick="switchNotesOverviewTab(\'all-notes\')"]');
                if (allNotesTab) {
                    allNotesTab.classList.add('active');
                } else {
                    console.warn('⚠️ all-notes 标签页元素未找到');
                }
                
                // 显示全部笔记面板，隐藏其他面板
                const overviewPanels = document.querySelectorAll('.overview-panel');
                if (overviewPanels.length > 0) {
                    overviewPanels.forEach(panel => {
                        panel.style.display = 'none';
                    });
                } else {
                    console.warn('⚠️ overview-panel 元素未找到');
                }
                
                const allNotesPanel = document.getElementById('all-notes');
                if (allNotesPanel) {
                    allNotesPanel.style.display = 'block';
                } else {
                    console.warn('⚠️ all-notes 元素未找到');
                }
                
                // 更新内容和数字
                if (typeof updateNotesOverviewContent === 'function') {
                    updateNotesOverviewContent('all-notes');
                } else {
                    console.warn('⚠️ updateNotesOverviewContent 函数未定义');
                }
                
                // 绑定搜索功能
                const searchInput = document.querySelector('#notes .search-input');
                if (searchInput) {
                    // 移除之前的事件监听器（如果有）
                    searchInput.removeEventListener('input', searchNotesHandler);
                    // 添加新的事件监听器
                    searchInput.addEventListener('input', searchNotesHandler);
                } else {
                    console.warn('⚠️ 笔记搜索输入框未找到');
                }
                
                console.log('✅ 笔记页面初始化完成');
                
            } catch (error) {
                console.error('❌ 初始化笔记页面失败:', error);
            }
        }
        
        // 搜索处理函数
        function searchNotesHandler(e) {
            if (typeof searchNotesInOverview === 'function') {
                searchNotesInOverview(e.target.value);
            } else {
                console.warn('⚠️ searchNotesInOverview 函数未定义');
            }
        }

        // 显示笔记统计信息
        function showNotesStats() {
            const totalNotes = AppState.notes.length;
            const favoriteNotes = AppState.notes.filter(n => n.isFavorite).length;
            const todayNotes = AppState.notes.filter(n => {
                const today = new Date();
                const noteDate = new Date(n.createdAt);
                return noteDate.toDateString() === today.toDateString();
            }).length;
            
            showNotification(`笔记统计：总计 ${totalNotes} 篇，收藏 ${favoriteNotes} 篇，今日创建 ${todayNotes} 篇`, 'info');
        }

        // 搜索笔记功能
        function showNotesSearch() {
            const searchInput = document.querySelector('#notes .search-input');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
                showNotification('搜索功能已激活', 'info');
            } else {
                showNotification('搜索功能已激活，请在搜索框中输入关键词', 'info');
            }
        }

        async function createNewNote() {
            console.log('🔵 createNewNote 函数开始执行...');
            
            const note = {
                id: `note-temp-${Date.now()}`, // 临时ID，保存到数据库后会被替换为UUID
                title: '新建笔记',
                content: '',
                tags: [],
                createdAt: new Date(),
                updatedAt: new Date(),
                isFavorite: false
            };
            
            let user = null;
            try {
                // 尝试检查用户是否已登录，但不让认证检查阻塞笔记创建
                console.log('🔵 尝试获取当前用户...');
                user = await Promise.race([
                    getCurrentUserOptimized(),
                    new Promise((resolve) => setTimeout(() => resolve(null), 3000)) // 3秒超时
                ]);
                console.log('🔵 用户检查完成:', user ? '已登录' : '未登录');
            } catch (error) {
                console.warn('⚠️ 用户认证检查失败，继续创建本地笔记:', error);
                user = null;
            }
            
            try {
                if (user) {
                    // 用户已登录，保存到数据库
                    console.log('🔵 用户已登录，保存到数据库...');
                    await saveNoteToDatabase(note);
                } else {
                    // 用户未登录，仅保存到本地
                    console.log('🔵 用户未登录，笔记将保存到本地存储');
                }
                
                AppState.notes.unshift(note);
                AppState.currentNote = note;
                
                // 保存到本地存储
                await saveAppState();
                
                // 立即刷新所有相关的笔记列表和视图
                if (typeof loadNotes === 'function') {
                    loadNotes();
                }
                
                // 刷新笔记概览页面（如果存在）
                const notesOverview = document.querySelector('.notes-overview');
                if (notesOverview) {
                    updateNotesTabCounts();
                    const activeTab = document.querySelector('.overview-tab.active');
                    const tabName = activeTab ? activeTab.getAttribute('onclick').match(/'([^']+)'/)[1] : 'all-notes';
                    updateNotesOverviewContent(tabName);
                }
                
                // 刷新仪表板中的最近笔记
                if (typeof updateDashboardRecentNotes === 'function') {
                    updateDashboardRecentNotes();
                }
                
                // 如果在笔记页面，直接打开编辑器
                if (AppState.currentPage === 'notes') {
                    openNoteEditor(note.id);
                } else {
                    // 如果不在笔记页面，先切换到笔记页面再打开编辑器
                    navigateTo('notes');
                    setTimeout(() => {
                        openNoteEditor(note.id);
                    }, 100);
                }
                
                showNotification('新笔记已创建', 'success');
                updateDashboard();
            } catch (error) {
                console.error('创建笔记失败:', error);
                showNotification('创建笔记失败', 'error');
            }
        }

        function loadNotes() {
            // 检查是否在新的笔记概览页面
            const notesOverview = document.querySelector('.notes-overview');
            if (notesOverview) {
                // 使用新的概览页面逻辑
                updateNotesTabCounts();
                // 获取当前激活的标签页
                const activeTab = document.querySelector('.overview-tab.active');
                const tabName = activeTab ? activeTab.getAttribute('onclick').match(/'([^']+)'/)[1] : 'all-notes';
                updateNotesOverviewContent(tabName);
                return;
            }
            
            // 保持原有的侧边栏笔记列表逻辑
            const notesList = document.getElementById('notes-list');
            if (!notesList) return;
            
            notesList.innerHTML = '';
            
            if (AppState.notes.length === 0) {
                notesList.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: var(--space-lg);">
                        暂无笔记<br>
                        <span style="color: var(--primary-color); cursor: pointer;" onclick="createNewNote().catch(console.error)">创建第一个笔记</span>
                    </div>
                `;
                return;
            }
            
            AppState.notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                if (AppState.currentNote && AppState.currentNote.id === note.id) {
                    noteElement.classList.add('active');
                }
                
                noteElement.innerHTML = `
                    <div class="note-item-title">${note.title || '无标题'}</div>
                    <div class="note-item-preview">${note.content.substring(0, 100) || '暂无内容'}</div>
                    <div class="note-item-meta">
                        <span>${formatDate(note.updatedAt)}</span>
                        <span>${note.content.length} 字</span>
                    </div>
                `;
                
                noteElement.onclick = () => selectNote(note.id);
                notesList.appendChild(noteElement);
            });
            
            // 更新计数
            const allNotesCount = document.getElementById('all-notes-count');
            const favoritesCount = document.getElementById('favorites-count');
            const recentCount = document.getElementById('recent-count');
            
            if (allNotesCount) allNotesCount.textContent = AppState.notes.length;
            if (favoritesCount) favoritesCount.textContent = AppState.notes.filter(n => n.isFavorite).length;
            if (recentCount) recentCount.textContent = Math.min(AppState.notes.length, 10);
        }

        function selectNote(noteId) {
            const note = AppState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            AppState.currentNote = note;
            
            // 创建笔记快照，用于变化检测
            window.lastNoteSnapshot = JSON.parse(JSON.stringify(note));
            
            // 更新编辑器
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-content').value = note.content;
            
            // 更新标签
            const tagsContainer = document.getElementById('note-tags');
            tagsContainer.innerHTML = '';
            note.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag tag-primary';
                tagElement.innerHTML = `${tag} <i class="fas fa-times" onclick="removeTag('${tag}')" style="margin-left: 4px; cursor: pointer;"></i>`;
                tagsContainer.appendChild(tagElement);
            });
            
            // 更新列表状态
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.note-item')?.classList.add('active');
            
            updateWordCount();
        }

        // 防抖函数
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 防抖保存函数
        const debouncedSave = debounce(async () => {
            if (!AppState.currentNote) return;
            
            // 检查是否有实际变化
            if (window.lastNoteSnapshot && 
                JSON.stringify(AppState.currentNote) === JSON.stringify(window.lastNoteSnapshot)) {
                console.log('笔记无变化，跳过保存');
                return;
            }
            
            // 重试机制
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    await saveNoteToDatabase(AppState.currentNote);
                    
                    // 更新快照
                    window.lastNoteSnapshot = JSON.parse(JSON.stringify(AppState.currentNote));
                    
                    const saveStatus = document.getElementById('save-status');
                    if (saveStatus) {
                        saveStatus.textContent = '已自动保存';
                        setTimeout(() => {
                            if (saveStatus.textContent === '已自动保存') {
                                saveStatus.textContent = '';
                            }
                        }, 2000);
                    }
                    
                    // 清除之前的错误状态
                    window.lastSaveError = null;
                    return; // 成功保存，退出重试循环
                    
                } catch (error) {
                    retryCount++;
                    window.lastSaveError = error;
                    
                    if (retryCount < maxRetries) {
                        console.warn(`笔记自动保存失败，正在重试 (${retryCount}/${maxRetries}):`, error);
                        // 等待一段时间后重试
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    } else {
                        console.error('笔记自动保存失败，已达到最大重试次数:', error);
                        const saveStatus = document.getElementById('save-status');
                        if (saveStatus) {
                            saveStatus.textContent = '自动保存失败';
                            saveStatus.style.color = '#dc3545';
                            setTimeout(() => {
                                saveStatus.textContent = '';
                                saveStatus.style.color = '';
                            }, 5000);
                        }
                    }
                }
            }
        }, 1000); // 1秒防抖延迟

        // 防抖保存函数 - 用于自动保存项目
        const debouncedProjectSave = debounce(async () => {
            if (!window.editingProjectId || !AppState.user) return;
            
            const projectIndex = AppState.projects.findIndex(p => p.id === window.editingProjectId);
            if (projectIndex === -1) return;
            
            const project = AppState.projects[projectIndex];
            
            // 检查是否有实际变化
            if (window.lastProjectSnapshot && 
                JSON.stringify(project) === JSON.stringify(window.lastProjectSnapshot)) {
                console.log('项目无变化，跳过保存');
                return;
            }
            
            // 重试机制
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
                try {
                    await saveProjectToDatabase(project);
                    
                    // 更新快照
                    window.lastProjectSnapshot = JSON.parse(JSON.stringify(project));
                    console.log('项目已自动保存');
                    
                    // 清除之前的错误状态
                    window.lastProjectSaveError = null;
                    return; // 成功保存，退出重试循环
                    
                } catch (error) {
                    retryCount++;
                    window.lastProjectSaveError = error;
                    
                    if (retryCount < maxRetries) {
                        console.warn(`项目自动保存失败，正在重试 (${retryCount}/${maxRetries}):`, error);
                        // 等待一段时间后重试
                        await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                    } else {
                        console.error('项目自动保存失败，已达到最大重试次数:', error);
                        // 可以在这里添加用户界面提示
                        if (typeof showToast === 'function') {
                            showToast('项目自动保存失败，请检查网络连接', 'error');
                        }
                    }
                }
            }
        }, 1000); // 1秒防抖延迟

        async function saveNote() {
            if (!AppState.currentNote) return;
            
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value;
            
            AppState.currentNote.title = title || '无标题';
            AppState.currentNote.content = content;
            AppState.currentNote.updatedAt = new Date();
            
            // 显示保存状态
            const saveStatus = document.getElementById('save-status');
            if (saveStatus) saveStatus.textContent = '保存中...';
            
            try {
                // 保存到数据库
                await saveNoteToDatabase(AppState.currentNote);
                
                // 更新列表显示
                loadNotes();
                
                if (saveStatus) saveStatus.textContent = '已保存';
                updateDashboard();
            } catch (error) {
                console.error('保存笔记失败:', error);
                if (saveStatus) saveStatus.textContent = '保存失败';
                showNotification('保存笔记失败', 'error');
            }
        }

        async function deleteNote(noteId) {
            if (confirm('确定要删除这个笔记吗？')) {
                try {
                    // 从数据库删除
                    await deleteNoteFromDatabase(noteId);
                    
                    // 从本地状态删除
                    AppState.notes = AppState.notes.filter(n => n.id !== noteId);
                    if (AppState.currentNote && AppState.currentNote.id === noteId) {
                        AppState.currentNote = null;
                        document.getElementById('note-title').value = '';
                        document.getElementById('note-content').value = '';
                        document.getElementById('note-tags').innerHTML = '';
                    }
                    
                    loadNotes();
                    showNotification('笔记已删除', 'success');
                    updateDashboard();
                } catch (error) {
                    console.error('删除笔记失败:', error);
                    showNotification('删除笔记失败', 'error');
                }
            }
        }

        async function addTag() {
            const tag = await showCustomModal('添加标签', '请输入标签名称');
            if (tag && AppState.currentNote) {
                if (!AppState.currentNote.tags.includes(tag)) {
                    AppState.currentNote.tags.push(tag);
                    selectNote(AppState.currentNote.id);
                    await saveNote();
                }
            }
        }

        async function removeTag(tag) {
            if (AppState.currentNote) {
                AppState.currentNote.tags = AppState.currentNote.tags.filter(t => t !== tag);
                selectNote(AppState.currentNote.id);
                await saveNote();
            }
        }

        function searchNotes(query) {
            const notesList = document.getElementById('notes-list');
            const filteredNotes = AppState.notes.filter(note => 
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.content.toLowerCase().includes(query.toLowerCase()) ||
                note.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            );
            
            notesList.innerHTML = '';
            filteredNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                if (AppState.currentNote && AppState.currentNote.id === note.id) {
                    noteElement.classList.add('active');
                }
                
                noteElement.innerHTML = `
                    <div class="note-item-title">${note.title || '无标题'}</div>
                    <div class="note-item-preview">${note.content.substring(0, 100) || '暂无内容'}</div>
                    <div class="note-item-meta">
                        <span>${formatDate(note.updatedAt)}</span>
                        <span>${note.content.length} 字</span>
                    </div>
                `;
                
                noteElement.onclick = () => selectNote(note.id);
                notesList.appendChild(noteElement);
            });
        }

        function filterNotes(type) {
            // 更新侧边栏状态
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            let filteredNotes = [];
            switch(type) {
                case 'all':
                    filteredNotes = AppState.notes;
                    break;
                case 'favorites':
                    filteredNotes = AppState.notes.filter(n => n.isFavorite);
                    break;
                case 'recent':
                    filteredNotes = AppState.notes.slice(0, 10);
                    break;
            }
            
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            filteredNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item';
                if (AppState.currentNote && AppState.currentNote.id === note.id) {
                    noteElement.classList.add('active');
                }
                
                noteElement.innerHTML = `
                    <div class="note-item-title">${note.title || '无标题'}</div>
                    <div class="note-item-preview">${note.content.substring(0, 100) || '暂无内容'}</div>
                    <div class="note-item-meta">
                        <span>${formatDate(note.updatedAt)}</span>
                        <span>${note.content.length} 字</span>
                    </div>
                `;
                
                noteElement.onclick = () => selectNote(note.id);
                notesList.appendChild(noteElement);
            });
        }

        function updateWordCount() {
            const content = document.getElementById('note-content').value;
            const wordCount = content.length;
            document.getElementById('word-count').textContent = `${wordCount} 字`;
        }

        // 笔记卡片组件和网格布局
        function createNoteCard(note) {
            const card = document.createElement('div');
            const isDemo = note.id.startsWith('demo-');
            const user = getCurrentUserOptimized();
            
            card.className = `note-card ${isDemo ? 'demo-note' : ''}`;
            card.setAttribute('data-note-id', note.id);
            
            const previewText = note.content.replace(/\n/g, ' ').substring(0, 120);
            const tagsHtml = note.tags.slice(0, 3).map(tag => 
                `<span class="tag tag-small">${tag}</span>`
            ).join('');
            
            const moreTagsCount = note.tags.length > 3 ? note.tags.length - 3 : 0;
            const moreTagsHtml = moreTagsCount > 0 ? `<span class="tag tag-small tag-more">+${moreTagsCount}</span>` : '';
            
            // 为演示数据显示不同的操作按钮
            const actionsHtml = isDemo && !user ? `
                <div class="note-card-actions">
                    <span class="demo-badge">演示</span>
                </div>
            ` : `
                <div class="note-card-actions">
                    <button class="btn-icon" onclick="toggleNoteFavorite('${note.id}')" title="${note.isFavorite ? '取消收藏' : '收藏'}">
                        <i class="fas fa-star ${note.isFavorite ? 'favorite' : ''}"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteNoteFromCard('${note.id}')" title="删除笔记">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            card.innerHTML = `
                <div class="note-card-header">
                    <h3 class="note-card-title">${note.title || '无标题'}</h3>
                    ${actionsHtml}
                </div>
                <div class="note-card-content">
                    <p class="note-preview">${previewText || '暂无内容...'}</p>
                </div>
                <div class="note-card-footer">
                    <div class="note-tags">
                        ${tagsHtml}
                        ${moreTagsHtml}
                    </div>
                    <div class="note-meta">
                        <span class="note-date">${formatDate(note.updatedAt)}</span>
                        <span class="note-word-count">${note.content.length} 字</span>
                    </div>
                </div>
            `;
            
            // 点击卡片的处理逻辑
            card.addEventListener('click', (e) => {
                if (!e.target.closest('.note-card-actions')) {
                    if (isDemo && !user) {
                        // 演示数据且未登录，显示登录提示
                        showNotification('请先登录以创建和编辑笔记', 'info');
                        showLoginModal();
                    } else {
                        // 正常打开笔记编辑器
                        openNoteEditor(note.id);
                    }
                }
            });
            
            return card;
        }

        function renderNotesGrid(notes, containerId) {
            // 根据containerId构建对应的网格ID
            const gridId = containerId + '-grid';
            let grid = document.getElementById(gridId);
            
            // 防御性检查：如果网格不存在，尝试创建
            if (!grid) {
                console.warn(`Grid container not found: ${gridId}, attempting to create...`);
                
                // 尝试找到父容器
                const parentContainer = document.getElementById(containerId);
                if (parentContainer) {
                    grid = document.createElement('div');
                    grid.id = gridId;
                    grid.className = 'notes-grid';
                    parentContainer.appendChild(grid);
                    console.log(`✅ Created missing grid container: ${gridId}`);
                } else {
                    console.error(`❌ Parent container not found: ${containerId}`);
                    return;
                }
            }
            
            if (notes.length === 0) {
                grid.innerHTML = `
                    <div class="notes-empty">
                        <i class="fas fa-file-alt"></i>
                        <p>暂无笔记</p>
                        <button class="btn btn-primary" onclick="createNewNote().catch(console.error)">创建第一个笔记</button>
                    </div>
                `;
            } else {
                grid.innerHTML = '';
                notes.forEach(note => {
                    const noteCard = createNoteCard(note);
                    grid.appendChild(noteCard);
                });
            }
        }

        function switchNotesOverviewTab(tabName) {
            // 更新标签页状态
            document.querySelectorAll('.overview-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 找到对应的标签页并激活
            const targetTab = Array.from(document.querySelectorAll('.overview-tab')).find(tab => {
                const onclick = tab.getAttribute('onclick');
                return onclick && onclick.includes(`'${tabName}'`);
            });
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 隐藏所有面板
            document.querySelectorAll('.overview-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // 显示对应面板
            const targetPanel = document.getElementById(tabName);
            if (targetPanel) {
                targetPanel.classList.add('active');
            }
            
            // 更新内容
            updateNotesOverviewContent(tabName);
        }

        function updateNotesOverviewContent(tabName) {
            let filteredNotes = [];
            let emptyMessage = '';
            
            switch(tabName) {
                case 'all-notes':
                    filteredNotes = AppState.notes;
                    emptyMessage = '暂无笔记，<span onclick="createNewNote().catch(console.error)" style="color: var(--primary-color); cursor: pointer;">创建第一个笔记</span>';
                    break;
                case 'favorites':
                    filteredNotes = AppState.notes.filter(note => note.isFavorite);
                    emptyMessage = '暂无收藏的笔记';
                    break;
                case 'recent':
                    filteredNotes = AppState.notes
                        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                        .slice(0, 10);
                    emptyMessage = '暂无最近编辑的笔记';
                    break;
                case 'today-notes':
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    filteredNotes = AppState.notes.filter(note => {
                        const noteDate = new Date(note.updatedAt);
                        noteDate.setHours(0, 0, 0, 0);
                        return noteDate.getTime() === today.getTime();
                    });
                    emptyMessage = '今日暂无编辑的笔记';
                    break;
            }
            
            // 更新空状态消息
            const emptyElement = document.querySelector(`#${tabName}-panel .overview-empty`);
            if (emptyElement) {
                emptyElement.innerHTML = emptyMessage;
            }
            
            // 渲染笔记网格
            renderNotesGrid(filteredNotes, tabName);
            
            // 更新标签页数字
            updateNotesTabCounts();
        }

        function updateNotesTabCounts() {
            const totalNotes = AppState.notes.length;
            const favoriteNotes = AppState.notes.filter(note => note.isFavorite).length;
            const recentNotes = Math.min(AppState.notes.length, 10);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayNotes = AppState.notes.filter(note => {
                const noteDate = new Date(note.updatedAt);
                noteDate.setHours(0, 0, 0, 0);
                return noteDate.getTime() === today.getTime();
            }).length;
            
            // 更新按钮数字
            document.getElementById('all-notes-count').textContent = totalNotes;
            document.getElementById('favorites-count').textContent = favoriteNotes;
            document.getElementById('recent-count').textContent = recentNotes;
            document.getElementById('today-notes-count').textContent = todayNotes;
        }

        function openNoteEditor(noteId) {
            const note = AppState.notes.find(n => n.id === noteId);
            if (!note) return;
            
            AppState.currentNote = note;
            
            // 隐藏概览区域
            document.getElementById('notes-overview-section').style.display = 'none';
            
            // 显示编辑器并添加动画
            const editor = document.getElementById('note-editor');
            editor.style.display = 'block';
            
            // 填充编辑器内容
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-content').value = note.content;
            
            // 更新UI状态
            updateWordCount();
            updateFavoriteButton();
            
            // 触发动画
            setTimeout(() => {
                editor.classList.add('show');
            }, 10);
            
            // 聚焦到内容区域
            setTimeout(() => {
                document.getElementById('note-content').focus();
            }, 350);
        }

        async function closeNoteEditor() {
            // 保存当前笔记
            if (AppState.currentNote) {
                await saveNote();
            }
            
            // 开始关闭动画
            const editor = document.getElementById('note-editor');
            editor.classList.remove('show');
            
            // 动画完成后隐藏编辑器并显示概览
            setTimeout(() => {
                editor.style.display = 'none';
                document.getElementById('notes-overview-section').style.display = 'block';
                
                // 清空当前笔记
                AppState.currentNote = null;
                
                // 刷新概览内容
                const activeTab = document.querySelector('.overview-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    updateNotesOverviewContent(tabName);
                }
            }, 300);
        }

        function toggleNoteFavorite(noteId) {
            const note = AppState.notes.find(n => n.id === noteId);
            if (note) {
                note.isFavorite = !note.isFavorite;
                note.updatedAt = new Date();
                saveAppStateImmediate();
                
                // 刷新当前视图
                const activeTab = document.querySelector('.notes-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('data-tab');
                    updateNotesOverviewContent(tabName);
                }
                
                showNotification(note.isFavorite ? '已添加到收藏夹' : '已从收藏夹移除', 'success');
            }
        }

        function deleteNoteFromCard(noteId) {
            if (confirm('确定要删除这个笔记吗？')) {
                AppState.notes = AppState.notes.filter(n => n.id !== noteId);
                
                // 如果删除的是当前编辑的笔记，关闭编辑器
                if (AppState.currentNote && AppState.currentNote.id === noteId) {
                    AppState.currentNote = null;
                    closeNoteEditor();
                }
                
                saveAppStateImmediate();
                
                // 立即刷新所有相关的笔记列表和视图
                if (typeof loadNotes === 'function') {
                    loadNotes();
                }
                
                // 刷新笔记概览页面（如果存在）
                const notesOverview = document.querySelector('.notes-overview');
                if (notesOverview) {
                    updateNotesTabCounts();
                    const activeTab = document.querySelector('.overview-tab.active');
                    const tabName = activeTab ? activeTab.getAttribute('onclick').match(/'([^']+)'/)[1] : 'all-notes';
                    updateNotesOverviewContent(tabName);
                }
                
                // 刷新仪表板中的最近笔记
                if (typeof updateDashboardRecentNotes === 'function') {
                    updateDashboardRecentNotes();
                }
                
                showNotification('笔记已删除', 'success');
                updateDashboard();
            }
        }

        // 编辑器工具函数
        function deleteNoteFromEditor() {
            if (AppState.currentNote && confirm('确定要删除这个笔记吗？')) {
                const noteId = AppState.currentNote.id;
                AppState.notes = AppState.notes.filter(n => n.id !== noteId);
                AppState.currentNote = null;
                saveAppStateImmediate();
                closeNoteEditor();
                showNotification('笔记已删除', 'success');
                updateDashboard();
            }
        }

        function formatText(format) {
            const textarea = document.getElementById('note-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (selectedText) {
                let formattedText = '';
                switch (format) {
                    case 'bold':
                        formattedText = `**${selectedText}**`;
                        break;
                    case 'italic':
                        formattedText = `*${selectedText}*`;
                        break;
                    default:
                        formattedText = selectedText;
                }
                
                textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
                textarea.focus();
                textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
                updateWordCount();
            } else {
                showNotification('请先选择要格式化的文本', 'warning');
            }
        }

        function insertTimestamp() {
            const textarea = document.getElementById('note-content');
            const timestamp = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const timestampText = `\n\n---\n📅 ${timestamp}\n`;
            const cursorPos = textarea.selectionStart;
            
            textarea.value = textarea.value.substring(0, cursorPos) + timestampText + textarea.value.substring(cursorPos);
            textarea.focus();
            textarea.setSelectionRange(cursorPos + timestampText.length, cursorPos + timestampText.length);
            updateWordCount();
        }

        function updateWordCount() {
            const content = document.getElementById('note-content').value;
            const wordCount = content.length;
            document.getElementById('word-count').innerHTML = `<i class="fas fa-font"></i> ${wordCount} 字`;
        }

        // 更新收藏按钮状态
        function updateFavoriteButton() {
            const favoriteBtn = document.getElementById('favorite-btn');
            if (AppState.currentNote && AppState.currentNote.isFavorite) {
                favoriteBtn.classList.add('active');
                favoriteBtn.innerHTML = '<i class="fas fa-star"></i>';
            } else {
                favoriteBtn.classList.remove('active');
                favoriteBtn.innerHTML = '<i class="far fa-star"></i>';
            }
        }

        // 重写toggleNoteFavorite函数以支持编辑器中的使用
        function toggleNoteFavorite(noteId) {
            // 如果在编辑器中且没有传入noteId，使用当前笔记
            if (!noteId && AppState.currentNote) {
                noteId = AppState.currentNote.id;
            }
            
            const note = AppState.notes.find(n => n.id === noteId);
            if (note) {
                note.isFavorite = !note.isFavorite;
                note.updatedAt = new Date();
                
                // 如果是当前编辑的笔记，更新currentNote
                if (AppState.currentNote && AppState.currentNote.id === noteId) {
                    AppState.currentNote.isFavorite = note.isFavorite;
                    updateFavoriteButton();
                }
                
                saveAppStateImmediate();
                
                // 刷新当前视图
                const activeTab = document.querySelector('.overview-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    updateNotesOverviewContent(tabName);
                }
                
                showNotification(note.isFavorite ? '已添加到收藏夹' : '已从收藏夹移除', 'success');
            }
        }

        function searchNotesInOverview(query) {
            if (!query.trim()) {
                // 如果搜索为空，恢复当前标签页的内容
                const activeTab = document.querySelector('.overview-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                    updateNotesOverviewContent(tabName);
                }
                return;
            }
            
            const filteredNotes = AppState.notes.filter(note => 
                note.title.toLowerCase().includes(query.toLowerCase()) ||
                note.content.toLowerCase().includes(query.toLowerCase()) ||
                note.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
            );
            
            // 显示搜索结果在当前活动的面板中
            const activeTab = document.querySelector('.overview-tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                const emptyElement = document.querySelector(`#${tabName}-panel .overview-empty`);
                if (emptyElement) {
                    emptyElement.innerHTML = `未找到包含 "${query}" 的笔记`;
                }
                renderNotesGrid(filteredNotes, `${tabName}-panel`);
            }
        }

        // 项目功能
        async function createNewProject() {
            console.log('🔵 createNewProject 函数开始执行...');
            
            const name = await showCustomModal('创建新项目', '请输入项目名称');
            if (name) {
                const project = {
                    id: `project-temp-${Date.now()}`, // 临时ID，保存到数据库后会被替换为UUID
                    name: name,
                    description: '',
                    status: 'planning',
                    progress: 0,
                    priority: 'medium',
                    teamSize: 5,
                    deadline: null,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    tasks: []
                };
                
                let user = null;
                try {
                    // 尝试检查用户是否已登录，但不让认证检查阻塞项目创建
                    console.log('🔵 尝试获取当前用户...');
                    user = await Promise.race([
                        getCurrentUserOptimized(),
                        new Promise((resolve) => setTimeout(() => resolve(null), 3000)) // 3秒超时
                    ]);
                    console.log('🔵 用户检查完成:', user ? '已登录' : '未登录');
                } catch (error) {
                    console.warn('⚠️ 用户认证检查失败，继续创建本地项目:', error);
                    user = null;
                }
                
                try {
                    if (user) {
                        // 用户已登录，保存到数据库
                        console.log('🔵 用户已登录，保存到数据库...');
                        const result = await saveProjectToDatabase(project);
                        if (result && result.success !== false) {
                            // 如果数据库返回了新的ID，更新项目ID
                            if (result.id) {
                                project.id = result.id;
                            }
                        }
                    } else {
                        // 用户未登录，仅保存到本地
                        console.log('用户未登录，项目将保存到本地存储');
                    }
                    
                    AppState.projects.push(project);
                    
                    // 保存到本地存储
                    await saveAppState();
                    
                    // 立即刷新所有相关的项目列表和视图
                    if (typeof loadProjects === 'function') {
                        loadProjects();
                    }
                    
                    // 刷新项目概览页面（如果存在）
                    if (typeof updateProjectOverview === 'function') {
                        updateProjectOverview();
                    }
                    
                    // 刷新仪表板中的项目概览
                    if (typeof updateDashboardProjectOverview === 'function') {
                        updateDashboardProjectOverview();
                    }
                    
                    // 如果在项目页面，刷新当前视图
                    if (AppState.currentPage === 'projects') {
                        const currentView = document.querySelector('.project-view.active');
                        if (currentView) {
                            const viewName = currentView.id.replace('-projects', '');
                            if (typeof loadProjectsByStatus === 'function') {
                                loadProjectsByStatus(viewName);
                            }
                        }
                    }
                    
                    updateDashboard();
                    
                    // 直接打开项目编辑器
                    openProject(project.id);
                    showNotification('项目创建成功，请完善项目信息', 'success');
                } catch (error) {
                    console.error('创建项目失败:', error);
                    showNotification('创建项目失败: ' + (error.message || error), 'error');
                }
            }
        }

        function loadProjects() {
            // 初始化项目管理页面
            updateProjectCounts();
            updateProjectOverview();
            
            // 检查是否有当前项目需要显示详情
            if (AppState.currentProject) {
                showProjectDetails(AppState.currentProject);
            } else {
                // 默认显示待办项目视图
                switchProjectView('planning');
            }
            
            // 绑定搜索事件
            const searchInputs = document.querySelectorAll('.project-search');
            searchInputs.forEach(input => {
                input.addEventListener('input', (e) => {
                    const status = e.target.closest('.project-view').id.replace('-projects', '');
                    searchProjectsByStatus(status, e.target.value);
                });
            });
            
            // 绑定标签点击事件
            const tabs = document.querySelectorAll('.dashboard-tab[data-view]');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const viewName = tab.getAttribute('data-view');
                    switchProjectView(viewName);
                });
            });
        }

        function loadKanbanView() {
            const todoTasks = document.getElementById('todo-tasks');
            const progressTasks = document.getElementById('progress-tasks');
            const doneTasks = document.getElementById('done-tasks');
            
            todoTasks.innerHTML = '';
            progressTasks.innerHTML = '';
            doneTasks.innerHTML = '';
            
            AppState.tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                
                switch(task.status) {
                    case 'todo':
                        todoTasks.appendChild(taskElement);
                        break;
                    case 'progress':
                        progressTasks.appendChild(taskElement);
                        break;
                    case 'done':
                        doneTasks.appendChild(taskElement);
                        break;
                }
            });
            
            // 更新计数
            document.getElementById('todo-count').textContent = AppState.tasks.filter(t => t.status === 'todo').length;
            document.getElementById('progress-count').textContent = AppState.tasks.filter(t => t.status === 'progress').length;
            document.getElementById('done-count').textContent = AppState.tasks.filter(t => t.status === 'done').length;
        }

        function loadProjectsGrid() {
            const projectsGrid = document.getElementById('projects-grid');
            projectsGrid.innerHTML = '';
            
            if (AppState.projects.length === 0) {
                projectsGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); padding: var(--space-xl);">
                        暂无项目<br>
                        <span style="color: var(--primary-color); cursor: pointer;" onclick="createNewProject().catch(console.error)">创建第一个项目</span>
                    </div>
                `;
                return;
            }
            
            // 使用统一的项目卡片创建函数
            AppState.projects.forEach(project => {
                projectsGrid.innerHTML += createUnifiedProjectCard(project);
            });
        }

        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = 'task-card';
            taskElement.draggable = true;
            
            taskElement.innerHTML = `
                <div class="task-title">${task.title}</div>
                <div class="task-description">${task.description || ''}</div>
                <div class="task-meta">
                    <span>${formatDate(task.createdAt)}</span>
                    <div style="display: flex; gap: var(--space-xs);">
                        <button onclick="editTask('${task.id}')" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTask('${task.id}')" style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // 拖拽功能
            taskElement.ondragstart = (e) => {
                e.dataTransfer.setData('text/plain', task.id);
            };
            
            return taskElement;
        }

        async function addTask(status) {
            const title = await showCustomModal('添加任务', '请输入任务标题');
            if (title) {
                const task = {
                    id: Date.now().toString(),
                    title: title,
                    description: '',
                    status: status,
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                AppState.tasks.push(task);
                loadKanbanView();
                showNotification('任务创建成功', 'success');
                saveAppState();
                updateDashboard();
            }
        }

        async function editTask(taskId) {
            const task = AppState.tasks.find(t => t.id === taskId);
            if (task) {
                const newTitle = await showCustomModal('编辑任务', '请输入新的任务标题', task.title);
                if (newTitle !== null) {
                    task.title = newTitle;
                    task.updatedAt = new Date();
                    loadKanbanView();
                    saveAppState();
                    updateDashboard();
                }
            }
        }

        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？')) {
                AppState.tasks = AppState.tasks.filter(t => t.id !== taskId);
                loadKanbanView();
                showNotification('任务已删除', 'success');
                saveAppState();
                updateDashboard();
            }
        }

        // 项目卡片菜单相关函数
        function toggleProjectMenu(projectId) {
            const menu = document.getElementById(`project-menu-${projectId}`);
            const allMenus = document.querySelectorAll('.project-menu');
            
            // 关闭其他菜单
            allMenus.forEach(m => {
                if (m.id !== `project-menu-${projectId}`) {
                    m.style.display = 'none';
                }
            });
            
            // 切换当前菜单
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        }

        function duplicateProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                const newProject = {
                    ...project,
                    id: generateId(),
                    name: project.name + ' (副本)',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                AppState.projects.push(newProject);
                saveAppState();
                
                // 立即刷新所有相关的项目列表和视图
                if (typeof loadProjects === 'function') {
                    loadProjects();
                }
                
                // 刷新项目概览页面（如果存在）
                if (typeof updateProjectOverview === 'function') {
                    updateProjectOverview();
                }
                
                // 刷新仪表板中的项目概览
                if (typeof updateDashboardProjectOverview === 'function') {
                    updateDashboardProjectOverview();
                }
                
                // 如果在项目页面，刷新当前视图
                const projectsPage = document.querySelector('.projects-page');
                if (projectsPage && typeof loadProjectsByStatus === 'function') {
                    loadProjectsByStatus();
                }
                
                updateDashboard();
                showNotification('项目已复制', 'success');
                
                // 关闭菜单
                const menu = document.getElementById(`project-menu-${projectId}`);
                if (menu) menu.style.display = 'none';
            }
        }

        // 点击外部关闭菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.project-card-actions')) {
                const allMenus = document.querySelectorAll('.project-menu');
                allMenus.forEach(menu => {
                    menu.style.display = 'none';
                });
            }
        });

        async function editProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                const newName = await showCustomModal('编辑项目', '请输入新的项目名称', project.name);
                if (newName !== null) {
                    project.name = newName;
                    project.updatedAt = new Date();
                    loadProjects();
                    saveAppState();
                    updateDashboard();
                }
            }
        }

        async function deleteProject(projectId) {
            if (confirm('确定要删除这个项目吗？')) {
                try {
                    // 从数据库删除
                    await deleteProjectFromDatabase(projectId);
                    
                    // 从本地状态删除
                    AppState.projects = AppState.projects.filter(p => p.id !== projectId);
                    
                    // 立即保存状态
                    saveAppStateImmediate();
                    
                    // 立即刷新所有相关的项目列表和视图
                    if (typeof loadProjects === 'function') {
                        loadProjects();
                    }
                    
                    // 刷新项目概览页面（如果存在）
                    if (typeof updateProjectOverview === 'function') {
                        updateProjectOverview();
                    }
                    
                    // 刷新仪表板中的项目概览
                    if (typeof updateDashboardProjectOverview === 'function') {
                        updateDashboardProjectOverview();
                    }
                    
                    // 如果在项目页面，刷新当前视图
                    const projectsPage = document.querySelector('.projects-page');
                    if (projectsPage && typeof loadProjectsByStatus === 'function') {
                        loadProjectsByStatus();
                    }
                    
                    showNotification('项目已删除', 'success');
                    updateDashboard();
                } catch (error) {
                    console.error('删除项目失败:', error);
                    showNotification('删除项目失败', 'error');
                }
            }
        }

        function toggleView() {
            AppState.isKanbanView = !AppState.isKanbanView;
            
            const kanbanView = document.getElementById('kanban-view');
            const projectsGrid = document.getElementById('projects-grid');
            const viewIcon = document.getElementById('view-icon');
            const viewText = document.getElementById('view-text');
            
            if (AppState.isKanbanView) {
                kanbanView.style.display = 'flex';
                projectsGrid.style.display = 'none';
                viewIcon.className = 'fas fa-th';
                viewText.textContent = '看板视图';
                loadKanbanView();
            } else {
                kanbanView.style.display = 'none';
                projectsGrid.style.display = 'grid';
                viewIcon.className = 'fas fa-columns';
                viewText.textContent = '列表视图';
                loadProjectsGrid();
            }
            
            saveAppState();
        }

        function searchProjects(query) {
            // 项目搜索功能
            if (AppState.isKanbanView) {
                // 在看板视图中搜索任务
                const filteredTasks = AppState.tasks.filter(task => 
                    task.title.toLowerCase().includes(query.toLowerCase()) ||
                    task.description.toLowerCase().includes(query.toLowerCase())
                );
                
                const todoTasks = document.getElementById('todo-tasks');
                const progressTasks = document.getElementById('progress-tasks');
                const doneTasks = document.getElementById('done-tasks');
                
                todoTasks.innerHTML = '';
                progressTasks.innerHTML = '';
                doneTasks.innerHTML = '';
                
                filteredTasks.forEach(task => {
                    const taskElement = createTaskElement(task);
                    
                    switch(task.status) {
                        case 'todo':
                            todoTasks.appendChild(taskElement);
                            break;
                        case 'progress':
                            progressTasks.appendChild(taskElement);
                            break;
                        case 'done':
                            doneTasks.appendChild(taskElement);
                            break;
                    }
                });
            } else {
                // 在列表视图中搜索项目
                const filteredProjects = AppState.projects.filter(project => 
                    project.name.toLowerCase().includes(query.toLowerCase()) ||
                    project.description.toLowerCase().includes(query.toLowerCase())
                );
                
                const projectsGrid = document.getElementById('projects-grid');
                projectsGrid.innerHTML = '';
                
                filteredProjects.forEach(project => {
                    // 重复项目卡片创建逻辑
                    const projectElement = document.createElement('div');
                    projectElement.className = 'project-card';
                    
                    const statusColors = {
                        planning: '#F59E0B',
                        active: '#10B981',
                        completed: '#6366F1'
                    };
                    
                    const statusTexts = {
                        planning: '规划中',
                        active: '进行中',
                        completed: '已完成'
                    };
                    
                    projectElement.innerHTML = `
                        <div class="project-header">
                            <div>
                                <div class="project-title">${project.name}</div>
                                <div class="project-description">${project.description || '暂无描述'}</div>
                            </div>
                            <div style="background: ${statusColors[project.status]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem;">
                                ${statusTexts[project.status]}
                            </div>
                        </div>
                        
                        <div class="project-progress">
                            <div class="progress-label">
                                <span>进度</span>
                                <span>${project.progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress}%"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-lg);">
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                ${formatDate(project.updatedAt)}
                            </div>
                            <div style="display: flex; gap: var(--space-sm);">
                                <button class="btn btn-sm btn-secondary" onclick="editProject('${project.id}').catch(console.error)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="deleteProject('${project.id}').catch(console.error)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    projectsGrid.appendChild(projectElement);
                });
            }
        }

        // 仪表板更新
        function updateDashboard() {
            const user = getCurrentUserOptimized();
            const demoNotice = document.getElementById('demo-notice');
            
            // 显示或隐藏演示数据提示条
            if (!user && AppState.notes.some(note => note.id.startsWith('demo-'))) {
                demoNotice.style.display = 'block';
            } else {
                demoNotice.style.display = 'none';
            }
            
            // 更新统计数据
            document.getElementById('notes-count').textContent = AppState.notes.length;
            document.getElementById('projects-count').textContent = AppState.projects.length;
            
            // 更新今日统计
            const today = new Date().toDateString();
            const todayNotes = AppState.notes.filter(note => 
                new Date(note.createdAt).toDateString() === today
            ).length;
            const todayTasks = AppState.tasks.filter(task => 
                task.status === 'done' && new Date(task.updatedAt).toDateString() === today
            ).length;
            
            document.getElementById('today-notes').textContent = todayNotes;
            document.getElementById('today-tasks').textContent = todayTasks;
            
            // 更新新布局的内容
            updateDashboardRecentNotes();
            updateDashboardProjectOverview();
        }

        // 更新首页最近笔记网格视图
        function updateDashboardRecentNotes() {
            let recentNotesGrid = document.getElementById('recent-notes-grid');
            
            // 防御性检查：如果网格不存在，尝试创建
            if (!recentNotesGrid) {
                console.warn('Recent notes grid not found, attempting to create...');
                const dashboardContainer = document.getElementById('dashboard-page');
                if (dashboardContainer) {
                    recentNotesGrid = document.createElement('div');
                    recentNotesGrid.id = 'recent-notes-grid';
                    recentNotesGrid.className = 'notes-grid';
                    dashboardContainer.appendChild(recentNotesGrid);
                    console.log('✅ Created missing recent notes grid');
                } else {
                    console.error('❌ Dashboard container not found');
                    return;
                }
            }
            
            if (AppState.notes.length > 0) {
                const recentNotes = AppState.notes
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 6);
                
                recentNotesGrid.innerHTML = recentNotes.map(note => `
                    <div class="note-card" onclick="navigateTo('notes'); selectNote('${note.id}')">
                        <div class="note-card-title">${note.title || '无标题'}</div>
                        <div class="note-card-preview">${note.content.substring(0, 120)}${note.content.length > 120 ? '...' : ''}</div>
                        <div class="note-card-meta">
                            <div class="note-card-tags">
                                ${note.tags ? note.tags.map(tag => `<span class="note-tag">${tag}</span>`).join('') : ''}
                            </div>
                            <div>${formatDate(note.updatedAt)}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                recentNotesGrid.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: var(--space-xl); grid-column: 1 / -1;">
                        暂无笔记，<span style="color: var(--primary-color); cursor: pointer;" onclick="navigateTo('notes')">立即创建</span>
                    </div>
                `;
            }
        }

        // 更新首页项目概览网格视图
        function updateDashboardProjectOverview() {
            let projectOverviewGrid = document.getElementById('project-overview-grid');
            
            // 防御性检查：如果网格不存在，尝试创建
            if (!projectOverviewGrid) {
                console.warn('Project overview grid not found, attempting to create...');
                const dashboardContainer = document.getElementById('dashboard-page');
                if (dashboardContainer) {
                    projectOverviewGrid = document.createElement('div');
                    projectOverviewGrid.id = 'project-overview-grid';
                    projectOverviewGrid.className = 'projects-grid';
                    dashboardContainer.appendChild(projectOverviewGrid);
                    console.log('✅ Created missing project overview grid');
                } else {
                    console.error('❌ Dashboard container not found');
                    return;
                }
            }
            
            if (AppState.projects.length > 0) {
                const recentProjects = AppState.projects
                    .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                    .slice(0, 6);
                
                projectOverviewGrid.innerHTML = recentProjects.map(project => {
                    const statusColors = {
                        'planning': '#6366f1',
                        'active': '#10b981', 
                        'completed': '#8b5cf6'
                    };
                    const statusTexts = {
                        'planning': '规划中',
                        'active': '进行中',
                        'completed': '已完成'
                    };
                    
                    // 获取团队人数
                    const teamSize = project.members ? project.members.length : 0;
                    
                    // 获取截止时间
                    const deadline = project.deadline ? new Date(project.deadline) : null;
                    const deadlineText = deadline ? formatDate(deadline) : '未设置';
                    
                    // 获取优先级（从标签中获取，或根据截止时间判断）
                    let priority = '中';
                    let priorityClass = 'medium';
                    if (project.tags && project.tags.length > 0) {
                        const priorityTags = project.tags.filter(tag => 
                            ['高', '中', '低', '紧急', '普通'].includes(tag)
                        );
                        if (priorityTags.length > 0) {
                            const tag = priorityTags[0];
                            if (tag === '高' || tag === '紧急') {
                                priority = '高';
                                priorityClass = 'high';
                            } else if (tag === '低') {
                                priority = '低';
                                priorityClass = 'low';
                            }
                        }
                    } else if (deadline) {
                        // 根据截止时间自动判断优先级
                        const now = new Date();
                        const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                        if (daysLeft <= 3) {
                            priority = '高';
                            priorityClass = 'high';
                        } else if (daysLeft <= 7) {
                            priority = '中';
                            priorityClass = 'medium';
                        } else {
                            priority = '低';
                            priorityClass = 'low';
                        }
                    }
                    
                    return `
                        <div class="note-card" onclick="viewProject('${project.id}')" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                                <div class="note-card-title">${project.name}</div>
                                <div style="background: ${statusColors[project.status]}; color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.75rem;">
                                    ${statusTexts[project.status]}
                                </div>
                            </div>
                            <div class="note-card-preview">${project.description || '暂无描述'}</div>
                            
                            <!-- 项目信息行 -->
                            <div style="display: flex; align-items: center; gap: var(--space-md); margin: var(--space-sm) 0; font-size: 0.8rem; color: var(--text-secondary);">
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-users" style="color: var(--primary-color);"></i>
                                    <span>团队: ${teamSize}人</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-calendar" style="color: var(--primary-color);"></i>
                                    <span>截止: ${deadlineText}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    <i class="fas fa-flag" style="color: var(--primary-color);"></i>
                                    <span class="priority-${priorityClass}">优先级: ${priority}</span>
                                </div>
                            </div>
                            
                            <div style="margin: var(--space-sm) 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                                    <span style="font-size: 0.75rem; color: var(--text-secondary);">进度</span>
                                    <span style="font-size: 0.75rem; color: var(--primary-color); font-weight: 600;">${project.progress}%</span>
                                </div>
                                <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px;">
                                    <div style="width: ${project.progress}%; height: 100%; background: var(--gradient); border-radius: 2px;"></div>
                                </div>
                            </div>
                            
                            <!-- 底部按钮 -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-md);">
                                <div style="display: flex; gap: var(--space-sm);">
                                    <button class="card-action-btn" onclick="event.stopPropagation(); openProjectNotes('${project.id}')" title="笔记">
                                        <i class="fas fa-sticky-note"></i>
                                    </button>
                                    <button class="card-action-btn" onclick="event.stopPropagation(); openProjectTasks('${project.id}')" title="任务">
                                        <i class="fas fa-tasks"></i>
                                    </button>
                                    <button class="card-action-btn" onclick="event.stopPropagation(); openProjectMembers('${project.id}')" title="成员">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button class="card-action-btn" onclick="event.stopPropagation(); viewProject('${project.id}')" title="详情">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                    ${formatDate(project.updatedAt)}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                projectOverviewGrid.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: var(--space-xl); grid-column: 1 / -1;">
                        暂无项目，<span style="color: var(--primary-color); cursor: pointer;" onclick="navigateTo('projects')">立即创建</span>
                    </div>
                `;
            }
        }

        // 首页视图切换功能
        function switchDashboardView(viewName) {
            // 更新标签状态
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const dashboardTab = document.querySelector(`[data-view="${viewName}"]`);
            if (dashboardTab) {
                dashboardTab.classList.add('active');
            }
            
            // 更新视图显示
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (viewName === 'recent-notes') {
                const recentNotesView = document.getElementById('dashboard-recent-notes');
                if (recentNotesView) {
                    recentNotesView.classList.add('active');
                }
                updateDashboardRecentNotes();
            } else if (viewName === 'project-overview') {
                const projectOverviewView = document.getElementById('dashboard-project-overview');
                if (projectOverviewView) {
                    projectOverviewView.classList.add('active');
                }
                updateDashboardProjectOverview();
            }
        }

        // 搜索功能
        function performSearch(query) {
            if (!query.trim()) return;
            
            const results = [];
            
            // 搜索笔记
            AppState.notes.forEach(note => {
                if (note.title.toLowerCase().includes(query.toLowerCase()) ||
                    note.content.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'note',
                        title: note.title || '无标题',
                        content: note.content.substring(0, 100),
                        action: () => {
                            navigateTo('notes');
                            selectNote(note.id);
                        }
                    });
                }
            });
            
            // 搜索项目
            AppState.projects.forEach(project => {
                if (project.name.toLowerCase().includes(query.toLowerCase()) ||
                    project.description.toLowerCase().includes(query.toLowerCase())) {
                    results.push({
                        type: 'project',
                        title: project.name,
                        content: project.description || '暂无描述',
                        action: () => {
                            navigateTo('projects');
                        }
                    });
                }
            });
            
            if (results.length > 0) {
                showNotification(`找到 ${results.length} 个相关结果`, 'success');
            } else {
                showNotification('未找到相关结果', 'info');
            }
        }

        // 编辑器工具
        function formatText(command) {
            const textarea = document.getElementById('note-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let formattedText = '';
            switch(command) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'underline':
                    formattedText = `<u>${selectedText}</u>`;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + formattedText.length, start + formattedText.length);
            
            updateWordCount();
            saveNote().catch(console.error);
        }

        function insertList() {
            const textarea = document.getElementById('note-content');
            const start = textarea.selectionStart;
            const listItem = '\n- ';
            
            textarea.value = textarea.value.substring(0, start) + listItem + textarea.value.substring(start);
            textarea.focus();
            textarea.setSelectionRange(start + listItem.length, start + listItem.length);
            
            updateWordCount();
            saveNote().catch(console.error);
        }

        async function insertLink() {
            const url = await showCustomModal('插入链接', '请输入链接地址');
            if (url) {
                const text = await showCustomModal('链接文本', '请输入链接文本', url);
                
                const textarea = document.getElementById('note-content');
                const start = textarea.selectionStart;
                const link = `[${text || url}](${url})`;
                
                textarea.value = textarea.value.substring(0, start) + link + textarea.value.substring(start);
                textarea.focus();
                textarea.setSelectionRange(start + link.length, start + link.length);
                
                updateWordCount();
                await saveNote();
            }
        }

        // 仪表板功能


        function getTodayNotesCount() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return AppState.notes.filter(note => {
                const noteDate = new Date(note.createdAt);
                noteDate.setHours(0, 0, 0, 0);
                return noteDate.getTime() === today.getTime();
            }).length;
        }

        function getTodayTasksCount() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return AppState.tasks.filter(task => {
                const taskDate = new Date(task.createdAt);
                taskDate.setHours(0, 0, 0, 0);
                return taskDate.getTime() === today.getTime();
            }).length;
        }

        function updateRecentNotes() {
            const recentNotesContainer = document.getElementById('recent-notes');
            if (!recentNotesContainer) return;
            
            const recentNotes = AppState.notes.slice(0, 5);
            recentNotesContainer.innerHTML = '';
            
            if (recentNotes.length === 0) {
                recentNotesContainer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: var(--space-lg);">暂无笔记</div>';
                return;
            }
            
            recentNotes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'recent-note-item';
                noteElement.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 4px;">${note.title || '无标题'}</div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">${formatDate(note.updatedAt)}</div>
                `;
                noteElement.onclick = () => {
                    navigateTo('notes');
                    setTimeout(() => selectNote(note.id), 100);
                };
                recentNotesContainer.appendChild(noteElement);
            });
        }

        function updateProjectOverview() {
            const projectOverviewContainer = document.getElementById('project-overview');
            if (!projectOverviewContainer) return;
            
            const activeProjects = AppState.projects.filter(p => p.status === 'active').slice(0, 3);
            projectOverviewContainer.innerHTML = '';
            
            if (activeProjects.length === 0) {
                projectOverviewContainer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: var(--space-lg);">暂无进行中的项目</div>';
                return;
            }
            
            activeProjects.forEach(project => {
                const projectElement = document.createElement('div');
                projectElement.className = 'project-overview-item';
                projectElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 500;">${project.name}</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">${project.progress}%</div>
                    </div>
                    <div class="progress-bar" style="height: 6px;">
                        <div class="progress-fill" style="width: ${project.progress}%"></div>
                    </div>
                `;
                projectElement.onclick = () => navigateTo('projects');
                projectOverviewContainer.appendChild(projectElement);
            });
        }

        // 工具函数
        function formatDate(date) {
            const now = new Date();
            const target = new Date(date);
            const diff = now - target;
            
            if (diff < 60000) { // 1分钟内
                return '刚刚';
            } else if (diff < 3600000) { // 1小时内
                return `${Math.floor(diff / 60000)}分钟前`;
            } else if (diff < 86400000) { // 1天内
                return `${Math.floor(diff / 3600000)}小时前`;
            } else if (diff < 604800000) { // 1周内
                return `${Math.floor(diff / 86400000)}天前`;
            } else {
                return target.toLocaleDateString('zh-CN');
            }
        }

        // 数据持久化 - 节流机制
        let saveTimeout = null;
        let lastSaveTime = 0;
        let pendingSave = false;
        const SAVE_THROTTLE_DELAY = 1000; // 1秒节流
        const MIN_SAVE_INTERVAL = 500; // 最小保存间隔500ms

// ===== 存储配额防护函数 =====
function estimateLocalStorageUsage() {
    try {
        let total = 0;
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            const v = localStorage.getItem(k);
            total += ((k ? k.length : 0) + (v ? v.length : 0));
        }
        return total;
    } catch (e) {
        console.warn('估算 localStorage 使用量失败:', e);
        return 0;
    }
}

function purgeLargeLocalItems() {
    try {
        const removablePrefixes = [
            'offline_',           // 离线缓存
            'cogninote_backup_',  // 历史迁移备份
            'doc_cache_',         // 文档缓存（如有）
        ];
        const removableKeys = [
            'cogninote-backups',
            'cogninote-latest-backup',
            'cogninote-notes',
            'cogninote-projects',
            'cogninote-tags',
        ];
        // 删除前缀类
        const toRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (!k) continue;
            if (removableKeys.includes(k)) {
                toRemove.push(k);
                continue;
            }
            if (removablePrefixes.some(p => k.startsWith(p))) {
                toRemove.push(k);
                continue;
            }
        }
        toRemove.forEach(k => {
            try {
                localStorage.removeItem(k);
                console.log('🧹 已清理本地存储项:', k);
            } catch (e) {
                console.warn('删除本地项失败', k, e);
            }
        });
        // 压缩备份数组到最多 3 个
        try {
            const raw = localStorage.getItem('cogninote-backups');
            if (raw) {
                const arr = JSON.parse(raw);
                if (Array.isArray(arr) && arr.length > 3) {
                    const slim = arr.slice(-3);
                    localStorage.setItem('cogninote-backups', JSON.stringify(slim));
                    console.log('🧹 已精简备份条目到 3 个');
                }
            }
        } catch (e) {
            console.warn('精简备份失败:', e);
        }
    } catch (e) {
        console.warn('清理本地存储失败:', e);
    }
}

function ensureAuthStorageSpace(minFreeBytes = 256 * 1024) {
    try {
        const used = estimateLocalStorageUsage();
        // localStorage 通常容量约 5MB（不同浏览器略有差异）
        const approxTotal = 5 * 1024 * 1024;
        const free = approxTotal - used;
        console.log(`📦 本地存储占用: ${Math.round(used/1024)}KB, 预计剩余: ${Math.round(free/1024)}KB`);
        if (free < minFreeBytes) {
            console.warn('本地存储剩余空间不足，执行清理以保障登录认证写入');
            purgeLargeLocalItems();
            // 再次评估，如果仍不足则进行更强力清理
            const used2 = estimateLocalStorageUsage();
            const free2 = approxTotal - used2;
            if (free2 < minFreeBytes) {
                aggressiveFreeLocalStorageForAuth();
            }
        }
    } catch (e) {
        console.warn('ensureAuthStorageSpace 执行失败:', e);
    }
}

function aggressiveFreeLocalStorageForAuth() {
    try {
        console.warn('⚠️ 执行强力清理：移除占用过大的 cogninote-app-state 与离线缓存');
        // 精简并替换 cogninote-app-state
        const raw = localStorage.getItem('cogninote-app-state');
        if (raw) {
            try {
                const state = JSON.parse(raw);
                const minimalState = {
                    currentTheme: state.currentTheme,
                    isKanbanView: state.isKanbanView,
                    currentPage: state.currentPage,
                    user: state.user ? { id: state.user.id, email: state.user.email, role: state.user.role } : null,
                    // 仅保留必要元数据字段，去除大文本内容
                    notes: Array.isArray(state.notes) ? state.notes.map(n => ({ id: n.id, title: n.title, updatedAt: n.updatedAt, isFavorite: n.isFavorite, tags: n.tags })) : [],
                    projects: Array.isArray(state.projects) ? state.projects.map(p => ({ id: p.id, name: p.name, status: p.status, updatedAt: p.updatedAt })) : [],
                    tasks: Array.isArray(state.tasks) ? state.tasks.map(t => ({ id: t.id, title: t.title, status: t.status, updatedAt: t.updatedAt })) : []
                };
                localStorage.setItem('cogninote-app-state', JSON.stringify(minimalState));
                console.log('🧹 已将 cogninote-app-state 精简为小体积版本');
            } catch (e) {
                console.warn('精简 cogninote-app-state 失败，直接移除:', e);
                localStorage.removeItem('cogninote-app-state');
            }
        }
        // 删除所有 offline_* 项
        const toRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k && k.startsWith('offline_')) toRemove.push(k);
        }
        toRemove.forEach(k => {
            try { localStorage.removeItem(k); } catch (e) { console.warn('删除离线项失败', k, e); }
        });
        console.log(`🧹 强力清理完成，移除 ${toRemove.length} 个离线项`);
    } catch (e) {
        console.warn('aggressiveFreeLocalStorageForAuth 失败:', e);
    }
}

        
        // 立即保存函数（用于重要操作）
        async function saveAppStateImmediate() {
            if (pendingSave) {
                return; // 如果已有保存操作在进行，直接返回
            }
            
            pendingSave = true;
            try {
                await saveAppStateCore();
                lastSaveTime = Date.now();
            } finally {
                pendingSave = false;
            }
        }
        
        // 节流保存函数（用于频繁操作）
        async function saveAppState() {
            const now = Date.now();
            
            // 如果距离上次保存时间太短，使用节流
            if (now - lastSaveTime < MIN_SAVE_INTERVAL) {
                // 清除之前的定时器
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                // 设置新的定时器
                saveTimeout = setTimeout(async () => {
                    saveTimeout = null;
                    await saveAppStateImmediate();
                }, SAVE_THROTTLE_DELAY);
                
                return;
            }
            
            // 如果间隔足够，立即保存
            await saveAppStateImmediate();
        }
        
        // 核心保存逻辑
        async function saveAppStateCore() {
            try {
                // 检查Supabase是否已正确初始化
                const supabaseClient = getSupabaseClientOptimized();
                if (!supabaseClient) {
                    // Supabase未初始化，只保存到localStorage
                    localStorage.setItem('cogninote-app-state', JSON.stringify(AppState));
                    return;
                }
                
                // 如果用户已登录，同步到数据库
                const user = await getCurrentUserOptimized();
                if (user) {
                    if (navigator.onLine) {
                        // 在线时直接同步到数据库
                        await syncAppStateToDatabase();
                    } else {
                        // 离线时保存到离线缓存
                        if (window.offlineCacheManager) {
                            // 如果本地存储空间不足，跳过离线缓存写入，避免进一步触发配额错误
                            const used = estimateLocalStorageUsage();
                            const approxTotal = 5 * 1024 * 1024;
                            if (approxTotal - used > 256 * 1024) {
                                // 保存所有笔记到离线缓存
                                AppState.notes.forEach(note => {
                                    window.offlineCacheManager.saveToCache('note', note, 'update');
                                });
                                // 保存所有项目到离线缓存
                                AppState.projects.forEach(project => {
                                    window.offlineCacheManager.saveToCache('project', project, 'update');
                                });
                            } else {
                                console.warn('空间不足，临时跳过离线缓存写入');
                            }
                        }
                        
                        // 同时保存到localStorage作为备份
                        localStorage.setItem('cogninote-app-state', JSON.stringify(AppState));
                        showNotification('离线模式：数据已保存到本地缓存', 'info');
                    }
                } else {
                    // 未登录时仍保存到localStorage作为备份
                    localStorage.setItem('cogninote-app-state', JSON.stringify(AppState));
                }
            } catch (error) {
                console.error('保存数据失败:', error);
                showNotification('数据保存失败', 'error');
                
                // 失败时保存到离线缓存和localStorage作为备份
                try {
                    if (window.offlineCacheManager) {
                        AppState.notes.forEach(note => {
                            window.offlineCacheManager.saveToCache('note', note, 'update');
                        });
                        AppState.projects.forEach(project => {
                            window.offlineCacheManager.saveToCache('project', project, 'update');
                        });
                    }
                    // 尝试释放部分本地存储空间后再保存
                    try { purgeLargeLocalItems(); } catch (cleanupErr) { console.warn('存储清理失败:', cleanupErr); }
                    localStorage.setItem('cogninote-app-state', JSON.stringify(AppState));
                } catch (localError) {
                    console.error('本地保存也失败:', localError);
                    // 兜底：保存精简版 AppState，避免完全无法备份
                    try {
                        const minimalState = {
                            currentTheme: AppState.currentTheme,
                            isKanbanView: AppState.isKanbanView,
                            currentPage: AppState.currentPage,
                            user: AppState.user ? { id: AppState.user.id, email: AppState.user.email, role: AppState.user.role } : null,
                            notes: (AppState.notes || []).map(n => ({ id: n.id, title: n.title, updatedAt: n.updatedAt, isFavorite: n.isFavorite, tags: n.tags })),
                            projects: (AppState.projects || []).map(p => ({ id: p.id, name: p.name, status: p.status, updatedAt: p.updatedAt })),
                            tasks: (AppState.tasks || []).map(t => ({ id: t.id, title: t.title, status: t.status, updatedAt: t.updatedAt }))
                        };
                        localStorage.setItem('cogninote-app-state', JSON.stringify(minimalState));
                        showNotification('本地备份已自动精简，以避免存储配额问题', 'warning');
                    } catch (finalErr) {
                        console.error('精简保存仍失败:', finalErr);
                    }
                }
            }
        }

        async function loadAppState() {
            try {
                const user = getCurrentUserOptimized();
                if (user) {
                    if (navigator.onLine) {
                        // 在线时从数据库加载
                        await loadUserData();
                        
                        // 启动实时监听器
                        if (typeof setupRealtimeListeners === 'function') {
                            setupRealtimeListeners();
                        }
                    } else {
                        // 离线时从离线缓存加载
                        if (window.offlineCacheManager) {
                            const cachedNotes = window.offlineCacheManager.loadFromCache('note');
                            const cachedProjects = window.offlineCacheManager.loadFromCache('project');
                            
                            // 合并缓存数据
                            AppState.notes = cachedNotes.map(note => ({
                                id: note.id,
                                title: note.title,
                                content: note.content,
                                tags: note.tags || [],
                                createdAt: note.createdAt,
                                updatedAt: note.updatedAt,
                                projectId: note.projectId
                            }));
                            
                            AppState.projects = cachedProjects.map(project => ({
                                id: project.id,
                                name: project.name,
                                description: project.description,
                                status: project.status,
                                priority: project.priority,
                                tags: project.tags || [],
                                tasks: project.tasks || [],
                                members: project.members || [],
                                createdAt: project.createdAt,
                                updatedAt: project.updatedAt
                            }));
                        }
                        
                        // 同时尝试从localStorage加载作为备份
                        const saved = localStorage.getItem('cogninote-app-state');
                        if (saved) {
                            const state = JSON.parse(saved);
                            
                            // 如果缓存为空，使用localStorage数据
                            if (AppState.notes.length === 0) {
                                AppState.notes = state.notes || [];
                            }
                            if (AppState.projects.length === 0) {
                                AppState.projects = state.projects || [];
                            }
                            
                            AppState.tasks = state.tasks || [];
                            AppState.currentTheme = state.currentTheme || 'light';
                            AppState.isKanbanView = state.isKanbanView !== undefined ? state.isKanbanView : true;
                        }
                        
                        showNotification('离线模式：已加载本地缓存数据', 'info');
                    }
                } else {
                    // 未登录状态：显示演示数据供用户预览
                    AppState.notes = [...DemoData.notes]; // 使用演示数据
                    AppState.projects = [];
                    AppState.tasks = [];
                    
                    // 从localStorage加载主题设置
                    const saved = localStorage.getItem('cogninote-app-state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        AppState.currentTheme = state.currentTheme || 'light';
                        AppState.isKanbanView = state.isKanbanView !== undefined ? state.isKanbanView : true;
                    }
                }
                
                // 恢复主题
                setTheme(AppState.currentTheme || 'light');
                
            } catch (error) {
                console.error('加载数据失败:', error);
                showNotification('数据加载失败', 'error');
                
                // 失败时尝试从离线缓存和localStorage加载
                try {
                    // 先尝试离线缓存
                    if (window.offlineCacheManager) {
                        const cachedNotes = window.offlineCacheManager.loadFromCache('note');
                        const cachedProjects = window.offlineCacheManager.loadFromCache('project');
                        
                        if (cachedNotes.length > 0 || cachedProjects.length > 0) {
                            AppState.notes = cachedNotes.map(note => ({
                                id: note.id,
                                title: note.title,
                                content: note.content,
                                tags: note.tags || [],
                                createdAt: note.createdAt,
                                updatedAt: note.updatedAt,
                                projectId: note.projectId
                            }));
                            
                            AppState.projects = cachedProjects.map(project => ({
                                id: project.id,
                                name: project.name,
                                description: project.description,
                                status: project.status,
                                priority: project.priority,
                                tags: project.tags || [],
                                tasks: project.tasks || [],
                                members: project.members || [],
                                createdAt: project.createdAt,
                                updatedAt: project.updatedAt
                            }));
                        }
                    }
                    
                    // 再尝试localStorage
                    const saved = localStorage.getItem('cogninote-app-state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        
                        if (AppState.notes.length === 0) {
                            AppState.notes = state.notes || [];
                        }
                        if (AppState.projects.length === 0) {
                            AppState.projects = state.projects || [];
                        }
                        
                        AppState.tasks = state.tasks || [];
                        AppState.currentTheme = state.currentTheme || 'light';
                        AppState.isKanbanView = state.isKanbanView !== undefined ? state.isKanbanView : true;
                    }
                    
                    setTheme(AppState.currentTheme || 'light');
                    
                } catch (localError) {
                    console.error('本地数据加载也失败:', localError);
                }
            }
        }

        // 添加页面刷新检测代码
        window.addEventListener('beforeunload', (e) => {
            console.error('🚨 页面即将刷新/关闭！');
            console.trace('刷新触发位置：');
            
            // 开发环境下显示警告（可选）
            if (window.location.hostname === 'localhost') {
                e.preventDefault();
                e.returnValue = '页面正在刷新，确定要离开吗？';
                return e.returnValue;
            }
        });

        // 事件监听
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('页面开始初始化...');
                console.log('Supabase SDK 是否加载:', typeof window.supabase !== 'undefined');
                
                // 调试localStorage状态
                console.log('=== 迁移状态检查 ===');
                console.log('- cogninote-migration-status:', localStorage.getItem('cogninote-migration-status'));
                console.log('- cogninote-app-state 存在:', !!localStorage.getItem('cogninote-app-state'));
                if (localStorage.getItem('cogninote-app-state')) {
                    try {
                        const state = JSON.parse(localStorage.getItem('cogninote-app-state'));
                        console.log('- 本地数据:', {
                            notes: state.notes ? state.notes.length : 0,
                            projects: state.projects ? state.projects.length : 0,
                            tags: state.tags ? state.tags.length : 0
                        });
                    } catch (e) {
                        console.log('- 解析本地数据失败:', e);
                    }
                }
                console.log('=== 迁移状态检查结束 ===');
                
                // 初始化 Supabase - 确保SDK完全加载
                console.log('🔵 开始初始化 Supabase...');
                
                // 等待Supabase SDK完全加载
                let retryCount = 0;
                const maxRetries = 10;
                const retryDelay = 100; // 100ms
                
                const waitForSupabaseSDK = () => {
                    return new Promise((resolve, reject) => {
                        const checkSDK = () => {
                            if (typeof window !== 'undefined' && window.supabase && window.supabase.createClient) {
                                console.log('✅ Supabase SDK 已加载');
                                resolve(true);
                            } else if (retryCount < maxRetries) {
                                retryCount++;
                                console.log(`🔄 等待 Supabase SDK 加载... (${retryCount}/${maxRetries})`);
                                setTimeout(checkSDK, retryDelay);
                            } else {
                                console.error('❌ Supabase SDK 加载超时');
                                reject(new Error('Supabase SDK 加载超时'));
                            }
                        };
                        checkSDK();
                    });
                };
                
                try {
                    await waitForSupabaseSDK();

                    // 在初始化 Supabase 前，预检并清理本地存储空间，避免认证写入失败
                    try { ensureAuthStorageSpace(512 * 1024); } catch (e) { console.warn('存储容量预检失败:', e); }
                    const supabaseInitialized = initSupabaseOptimized(); // 使用优化版本的初始化函数
                    if (supabaseInitialized) {
                        console.log('✅ Supabase 初始化成功');
                        // 验证客户端是否真正可用
                        const client = getSupabaseClientOptimized();
                        if (client) {
                            console.log('✅ Supabase 客户端验证成功');
                            console.log('🔍 Supabase 客户端详情:', {
                                url: client.supabaseUrl,
                                key: client.supabaseKey ? '已设置' : '未设置',
                                auth: client.auth ? '已初始化' : '未初始化'
                            });
                        } else {
                            console.error('❌ Supabase 客户端验证失败');
                            showNotification('数据库连接失败，部分功能可能不可用', 'error');
                        }
                    } else {
                        console.error('❌ Supabase 初始化失败');
                        showNotification('数据库连接失败，部分功能可能不可用', 'error');
                    }
                } catch (error) {
                    console.error('❌ Supabase SDK 加载失败:', error);
                    showNotification('数据库SDK加载失败，部分功能可能不可用', 'error');
                }
                
                // 检查认证状态
                await checkAuthStatus();
                
                // 初始化离线缓存管理器
                if (typeof OfflineCacheManager !== 'undefined') {
                    window.offlineCacheManager = new OfflineCacheManager();
                    console.log('离线缓存管理器已初始化');
                }
                
                // 加载应用状态
                await loadAppState();
                
                // 初始化仪表板
                updateDashboard();
                
                // 初始化笔记概览
                updateNotesTabCounts();
                updateNotesOverviewContent('all-notes');
            } catch (error) {
                console.error('应用初始化失败:', error);
                showNotification('应用初始化失败', 'error');
            }
            
            // 笔记编辑器事件
            const noteTitle = document.getElementById('note-title');
            const noteContent = document.getElementById('note-content');
            
            if (noteTitle) {
                noteTitle.addEventListener('input', function() {
                    if (AppState.currentNote) {
                        AppState.currentNote.title = this.value;
                        AppState.currentNote.updatedAt = new Date();
                        loadNotes();
                        saveAppState();
                        // 防抖自动保存
                        if (AppState.user) {
                            debouncedSave();
                        }
                    }
                });
            }
            
            if (noteContent) {
                noteContent.addEventListener('input', function() {
                    updateWordCount();
                    if (AppState.currentNote) {
                        AppState.currentNote.content = this.value;
                        AppState.currentNote.updatedAt = new Date();
                        saveAppState();
                        // 防抖自动保存
                        if (AppState.user) {
                            debouncedSave();
                        }
                    }
                });
            }
            
            // 键盘快捷键
            document.addEventListener('keydown', function(e) {
                // Ctrl+N 新建笔记
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    if (AppState.currentPage === 'notes') {
                        createNewNote().catch(console.error);
                    }
                }
                
                // Ctrl+S 保存笔记
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (AppState.currentPage === 'notes') {
                        saveNote().catch(console.error);
                    }
                }
                
                // Ctrl+/ 搜索
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    const searchInput = document.querySelector('.search-input');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }
            });
            
            // 拖拽功能
            const kanbanColumns = document.querySelectorAll('.kanban-column');
            kanbanColumns.forEach(column => {
                column.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                column.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const taskId = e.dataTransfer.getData('text/plain');
                    const task = AppState.tasks.find(t => t.id === taskId);
                    
                    if (task) {
                        // 确定新状态
                        let newStatus = 'todo';
                        if (this.querySelector('#progress-tasks')) {
                            newStatus = 'progress';
                        } else if (this.querySelector('#done-tasks')) {
                            newStatus = 'done';
                        }
                        
                        task.status = newStatus;
                        task.updatedAt = new Date();
                        loadKanbanView();
                        saveAppStateImmediate();
                        showNotification('任务状态已更新', 'success');
                    }
                });
            });
            
            // 自动保存
            setInterval(function() {
                if (AppState.currentNote && AppState.currentPage === 'notes') {
                    saveNote().catch(console.error);
                }
            }, 30000); // 每30秒自动保存
            
            // 添加测试项目数据（如果没有项目的话）
            if (AppState.projects.length === 0) {
                const testProjects = [
                    {
                        id: 'project-1',
                        name: '网站重构项目',
                        description: '对公司官网进行全面重构，提升用户体验和性能',
                        status: 'planning',
                        progress: 15,
                        createdAt: new Date('2024-01-15'),
                        updatedAt: new Date(),
                        deadline: new Date('2024-02-15'),
                        members: ['张三', '李四', '王五', '赵六', '钱七'],
                        tags: ['高', '前端', '重构'],
                        tasks: [
                            { id: 'task-1', title: '需求分析', status: 'done' },
                            { id: 'task-2', title: '技术选型', status: 'progress' },
                            { id: 'task-3', title: '原型设计', status: 'todo' }
                        ]
                    },
                    {
                        id: 'project-2',
                        name: '移动应用开发',
                        description: '开发跨平台移动应用，支持iOS和Android',
                        status: 'progress',
                        progress: 65,
                        createdAt: new Date('2024-01-10'),
                        updatedAt: new Date(),
                        deadline: new Date('2024-02-28'),
                        members: ['李四', '王五', '孙八'],
                        tags: ['中', '移动端', 'React Native'],
                        tasks: [
                            { id: 'task-4', title: 'UI设计', status: 'done' },
                            { id: 'task-5', title: '核心功能开发', status: 'progress' },
                            { id: 'task-6', title: '测试优化', status: 'todo' }
                        ]
                    },
                    {
                        id: 'project-3',
                        name: '数据分析平台',
                        description: '构建企业级数据分析和可视化平台',
                        status: 'done',
                        progress: 100,
                        createdAt: new Date('2023-12-01'),
                        updatedAt: new Date('2024-01-05'),
                        deadline: new Date('2024-01-05'),
                        members: ['王五', '赵六', '周九', '吴十'],
                        tags: ['低', '数据分析', '可视化'],
                        tasks: [
                            { id: 'task-7', title: '数据建模', status: 'done' },
                            { id: 'task-8', title: '可视化组件', status: 'done' },
                            { id: 'task-9', title: '部署上线', status: 'done' }
                        ]
                    },
                    {
                        id: 'project-4',
                        name: '客户管理系统',
                        description: '开发CRM系统，提升客户服务效率',
                        status: 'planning',
                        progress: 5,
                        createdAt: new Date('2024-01-20'),
                        updatedAt: new Date(),
                        tasks: [
                            { id: 'task-10', title: '业务调研', status: 'progress' }
                        ]
                    },
                    {
                        id: 'project-5',
                        name: '自动化测试框架',
                        description: '建立完整的自动化测试体系',
                        status: 'progress',
                        progress: 40,
                        createdAt: new Date('2024-01-08'),
                        updatedAt: new Date(),
                        tasks: [
                            { id: 'task-11', title: '框架搭建', status: 'done' },
                            { id: 'task-12', title: '测试用例编写', status: 'progress' }
                        ]
                    }
                ];
                
                AppState.projects = testProjects;
                saveAppState();
            }
            
            // 项目编辑器进度滑块事件监听器
            const progressSlider = document.getElementById('editProjectProgress');
            const progressValue = document.getElementById('progressValue');
            
            if (progressSlider && progressValue) {
                progressSlider.addEventListener('input', function() {
                    progressValue.textContent = this.value + '%';
                });
            }
            
            showNotification('欢迎使用 CogniNote Pro！', 'success', '欢迎');
        });

        // 项目管理页面功能
        function switchProjectView(viewName) {
            // 更新标签状态
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const projectTab = document.querySelector(`[data-view="${viewName}"]`);
            if (projectTab) {
                projectTab.classList.add('active');
            }
            
            // 更新视图显示
            document.querySelectorAll('.project-view').forEach(view => {
                view.classList.remove('active');
            });
            
            if (viewName === 'kanban') {
                const kanbanView = document.getElementById('kanban-view');
                if (kanbanView) {
                    kanbanView.classList.add('active');
                }
                loadKanbanView();
            } else {
                const projectsView = document.getElementById(`${viewName}-projects`);
                if (projectsView) {
                    projectsView.classList.add('active');
                }
                loadProjectsByStatus(viewName);
            }
            
            updateProjectCounts();
        }

        function loadProjectsByStatus(status) {
            const container = document.getElementById(`project-${status}`);
            if (!container) return;
            
            const featuredContainer = document.getElementById(`${status}-featured-projects`);
            const allContainer = document.getElementById(`${status}-all-projects`);
            
            if (!featuredContainer || !allContainer) return;
            
            let filteredProjects = AppState.projects;
            if (status !== 'all') {
                filteredProjects = AppState.projects.filter(project => project.status === status);
            }
            
            // 清空容器
            featuredContainer.innerHTML = '';
            allContainer.innerHTML = '';
            
            // 显示重点项目（前3个）
            const featuredProjects = filteredProjects.slice(0, 3);
            featuredProjects.forEach(project => {
                featuredContainer.innerHTML += createFeaturedProjectCard(project);
            });
            
            // 显示所有项目
            filteredProjects.forEach(project => {
                allContainer.innerHTML += createSmallProjectCard(project);
            });
        }

        // 统一的项目卡片创建函数（完全复制首页的HTML结构）
        function createUnifiedProjectCard(project) {
            // 完全复制首页updateDashboardProjectOverview函数中的逻辑
            const statusColors = {
                'planning': '#6366f1',
                'active': '#10b981', 
                'completed': '#8b5cf6'
            };
            const statusTexts = {
                'planning': '规划中',
                'active': '进行中',
                'completed': '已完成'
            };
            
            // 获取团队人数
            const teamSize = project.members ? project.members.length : 0;
            
            // 获取截止时间
            const deadline = project.deadline ? new Date(project.deadline) : null;
            const deadlineText = deadline ? formatDate(deadline) : '未设置';
            
            // 获取优先级（从标签中获取，或根据截止时间判断）
            let priority = '中';
            let priorityClass = 'medium';
            if (project.tags && project.tags.length > 0) {
                const priorityTags = project.tags.filter(tag => 
                    ['高', '中', '低', '紧急', '普通'].includes(tag)
                );
                if (priorityTags.length > 0) {
                    const tag = priorityTags[0];
                    if (tag === '高' || tag === '紧急') {
                        priority = '高';
                        priorityClass = 'high';
                    } else if (tag === '低') {
                        priority = '低';
                        priorityClass = 'low';
                    }
                }
            } else if (deadline) {
                // 根据截止时间自动判断优先级
                const now = new Date();
                const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 3) {
                    priority = '高';
                    priorityClass = 'high';
                } else if (daysLeft <= 7) {
                    priority = '中';
                    priorityClass = 'medium';
                } else {
                    priority = '低';
                    priorityClass = 'low';
                }
            }
            
            // 返回与首页完全相同的HTML字符串（直接复制）
            return `
                <div class="note-card" onclick="viewProject('${project.id}')" style="cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                        <div class="note-card-title">${project.name}</div>
                        <div style="background: ${statusColors[project.status]}; color: white; padding: 2px 8px; border-radius: var(--radius-sm); font-size: 0.75rem;">
                            ${statusTexts[project.status]}
                        </div>
                    </div>
                    <div class="note-card-preview">${project.description || '暂无描述'}</div>
                    
                    <!-- 项目信息行 -->
                    <div style="display: flex; align-items: center; gap: var(--space-md); margin: var(--space-sm) 0; font-size: 0.8rem; color: var(--text-secondary);">
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <i class="fas fa-users" style="color: var(--primary-color);"></i>
                            <span>团队: ${teamSize}人</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <i class="fas fa-calendar" style="color: var(--primary-color);"></i>
                            <span>截止: ${deadlineText}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <i class="fas fa-flag" style="color: var(--primary-color);"></i>
                            <span class="priority-${priorityClass}">优先级: ${priority}</span>
                        </div>
                    </div>
                    
                    <div style="margin: var(--space-sm) 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">进度</span>
                            <span style="font-size: 0.75rem; color: var(--primary-color); font-weight: 600;">${project.progress}%</span>
                        </div>
                        <div style="width: 100%; height: 4px; background: var(--bg-tertiary); border-radius: 2px;">
                            <div style="width: ${project.progress}%; height: 100%; background: var(--gradient); border-radius: 2px;"></div>
                        </div>
                    </div>
                    
                    <!-- 底部按钮 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-md);">
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="card-action-btn" onclick="event.stopPropagation(); openProjectNotes('${project.id}')" title="笔记">
                                <i class="fas fa-sticky-note"></i>
                            </button>
                            <button class="card-action-btn" onclick="event.stopPropagation(); openProjectTasks('${project.id}')" title="任务">
                                <i class="fas fa-tasks"></i>
                            </button>
                            <button class="card-action-btn" onclick="event.stopPropagation(); openProjectMembers('${project.id}')" title="成员">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="card-action-btn" onclick="event.stopPropagation(); viewProject('${project.id}')" title="详情">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">
                                ${formatDate(project.updatedAt)}
                            </div>
                            <div class="project-card-actions" style="position: relative;">
                                <button class="btn-icon" onclick="event.stopPropagation(); toggleProjectMenu('${project.id}')" title="更多操作">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="project-menu" id="project-menu-${project.id}" style="display: none; position: absolute; right: 0; top: 100%; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 1000; min-width: 120px;">
                                    <button class="menu-item" onclick="event.stopPropagation(); editProject('${project.id}')" style="width: 100%; padding: var(--space-sm); border: none; background: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: var(--space-sm);">
                                        <i class="fas fa-edit"></i>
                                        <span>编辑</span>
                                    </button>
                                    <button class="menu-item" onclick="event.stopPropagation(); duplicateProject('${project.id}')" style="width: 100%; padding: var(--space-sm); border: none; background: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: var(--space-sm);">
                                        <i class="fas fa-copy"></i>
                                        <span>复制</span>
                                    </button>
                                    <hr style="margin: 0; border: none; border-top: 1px solid var(--border-color);">
                                    <button class="menu-item danger" onclick="event.stopPropagation(); deleteProject('${project.id}')" style="width: 100%; padding: var(--space-sm); border: none; background: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: var(--space-sm); color: var(--danger-color);">
                                        <i class="fas fa-trash"></i>
                                        <span>删除</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
         }

        function createFeaturedProjectCard(project) {
            // 使用统一的项目卡片创建函数
            return createUnifiedProjectCard(project);
        }

        function createSmallProjectCard(project) {
            // 使用统一的项目卡片创建函数
            return createUnifiedProjectCard(project);
        }



        function searchProjectsByStatus(status, query) {
            if (!query.trim()) {
                loadProjectsByStatus(status);
                return;
            }
            
            let filteredProjects = AppState.projects;
            if (status !== 'all') {
                filteredProjects = AppState.projects.filter(project => project.status === status);
            }
            
            const searchResults = filteredProjects.filter(project => 
                project.name.toLowerCase().includes(query.toLowerCase()) ||
                (project.description && project.description.toLowerCase().includes(query.toLowerCase()))
            );
            
            const featuredContainer = document.getElementById(`${status}-featured-projects`);
            const allContainer = document.getElementById(`${status}-all-projects`);
            
            if (!featuredContainer || !allContainer) return;
            
            // 清空容器
            featuredContainer.innerHTML = '';
            allContainer.innerHTML = '';
            
            // 显示搜索结果
            searchResults.forEach(project => {
                allContainer.innerHTML += createSmallProjectCard(project);
            });
            
            if (searchResults.length === 0) {
                allContainer.innerHTML = '<div class="no-results">未找到匹配的项目</div>';
            }
        }

        function updateProjectCounts() {
            const todoCount = AppState.projects.filter(p => p.status === 'planning').length;
            const progressCount = AppState.projects.filter(p => p.status === 'active').length;
            const doneCount = AppState.projects.filter(p => p.status === 'completed').length;
            const totalCount = AppState.projects.length;
            
            // 更新项目概览数据
            updateProjectOverview();
            
            const todoTab = document.querySelector('[data-view="planning"] .tab-count');
            const progressTab = document.querySelector('[data-view="progress"] .tab-count');
            const doneTab = document.querySelector('[data-view="done"] .tab-count');
            const totalTab = document.getElementById('total-projects-count');
            
            if (todoTab) todoTab.textContent = todoCount;
            if (progressTab) progressTab.textContent = progressCount;
            if (doneTab) doneTab.textContent = doneCount;
            if (totalTab) totalTab.textContent = totalCount;
        }

        function getStatusText(status) {
            const statusMap = {
                'planning': '待办',
                'progress': '进行中',
                'done': '已完成'
            };
            return statusMap[status] || '未知';
        }

        function toggleProjectView() {
            const kanbanView = document.getElementById('kanban-view');
            const projectsGrid = document.getElementById('projects-grid');
            
            if (kanbanView.style.display === 'none') {
                kanbanView.style.display = 'block';
                projectsGrid.style.display = 'none';
            } else {
                kanbanView.style.display = 'none';
                projectsGrid.style.display = 'block';
            }
        }

        function showProjectStats() {
            const totalProjects = AppState.projects.length;
            const completedProjects = AppState.projects.filter(p => p.status === 'done').length;
            const activeProjects = AppState.projects.filter(p => p.status === 'progress').length;
            
            showNotification(`项目统计：总计 ${totalProjects} 个，进行中 ${activeProjects} 个，已完成 ${completedProjects} 个`, 'info');
        }

        function openProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                AppState.currentProject = project;
                // 直接打开项目编辑器
                openProjectEditor(project);
                showNotification(`已打开项目编辑器：${project.name}`, 'success');
            }
        }

        // 显示项目详情
        function showProjectDetails(project) {
            // 隐藏项目概览和项目列表
            document.getElementById('project-overview-section').style.display = 'none';
            document.querySelector('.dashboard-tabs').style.display = 'none';
            document.querySelector('.project-content').style.display = 'none';
            
            // 显示项目详情
            const detailsSection = document.getElementById('project-details-section');
            detailsSection.style.display = 'block';
            
            // 填充项目详情
            document.getElementById('project-detail-title').textContent = project.name;
            
            // 设置状态
            const statusBadge = document.querySelector('#project-detail-status .status-badge');
            statusBadge.textContent = getStatusText(project.status);
            statusBadge.className = `status-badge ${project.status}`;
            
            // 设置进度
            const progress = project.progress || 0;
            document.getElementById('project-detail-progress').style.width = `${progress}%`;
            document.getElementById('project-detail-progress-text').textContent = `${progress}%`;
            
            // 设置描述
            const descriptionElement = document.querySelector('#project-detail-description p');
            descriptionElement.textContent = project.description || '暂无描述';
            
            // 设置时间信息
            document.getElementById('project-detail-created').textContent = formatDate(project.createdAt);
            document.getElementById('project-detail-updated').textContent = formatDate(project.updatedAt);
            document.getElementById('project-detail-deadline').textContent = project.deadline ? formatDate(project.deadline) : '未设置';
            
            // 设置标签
            const tagsContainer = document.getElementById('project-detail-tags');
            if (project.tags && project.tags.length > 0) {
                tagsContainer.innerHTML = project.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
            } else {
                tagsContainer.innerHTML = '<span class="tag">无标签</span>';
            }
        }

        // 返回项目列表
        function backToProjectList() {
            // 清除当前项目
            AppState.currentProject = null;
            
            // 隐藏项目详情
            document.getElementById('project-details-section').style.display = 'none';
            
            // 显示项目概览和项目列表
            document.getElementById('project-overview-section').style.display = 'block';
            document.querySelector('.dashboard-tabs').style.display = 'flex';
            document.querySelector('.project-content').style.display = 'block';
        }

        // 编辑当前项目
        function editCurrentProject() {
            if (AppState.currentProject) {
                openProjectEditor(AppState.currentProject);
            }
        }

        // 打开项目编辑器
        function openProjectEditor(project) {
            // 填充表单数据
            document.getElementById('editProjectName').value = project.name || '';
            document.getElementById('editProjectDescription').value = project.description || '';
            document.getElementById('editProjectStatus').value = project.status || 'planning';
            document.getElementById('editProjectProgress').value = project.progress || 0;
            document.getElementById('progressValue').textContent = `${project.progress || 0}%`;
            
            // 设置截止时间
            if (project.deadline) {
                const date = new Date(project.deadline);
                document.getElementById('editProjectDeadline').value = date.toISOString().split('T')[0];
            } else {
                document.getElementById('editProjectDeadline').value = '';
            }
            
            // 显示当前标签
            displayCurrentTags(project.tags || []);
            
            // 显示当前成员
            displayCurrentMembers(project.members || []);
            
            // 显示模态框
            const projectEditorModal = document.getElementById('projectEditorModal');
            if (projectEditorModal) {
                projectEditorModal.classList.add('show');
            }
            
            // 存储当前编辑的项目ID
            window.editingProjectId = project.id;
            
            // 创建项目快照，用于变化检测
            window.lastProjectSnapshot = JSON.parse(JSON.stringify(project));
            
            // 添加输入事件监听器，实现自动保存
            setupProjectAutoSave();
        }

        // 设置项目自动保存
        function setupProjectAutoSave() {
            // 移除之前的事件监听器（如果存在）
            const inputs = [
                'editProjectName',
                'editProjectDescription', 
                'editProjectStatus',
                'editProjectProgress',
                'editProjectDeadline'
            ];
            
            inputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    // 移除旧的监听器
                    element.removeEventListener('input', handleProjectInput);
                    element.removeEventListener('change', handleProjectInput);
                    
                    // 添加新的监听器
                    element.addEventListener('input', handleProjectInput);
                    element.addEventListener('change', handleProjectInput);
                }
            });
        }
        
        // 处理项目输入变化
        function handleProjectInput(event) {
            if (!window.editingProjectId || !AppState.user) return;
            
            const projectIndex = AppState.projects.findIndex(p => p.id === window.editingProjectId);
            if (projectIndex === -1) return;
            
            // 更新项目数据
            const projectData = {
                name: document.getElementById('editProjectName').value.trim(),
                description: document.getElementById('editProjectDescription').value.trim(),
                status: document.getElementById('editProjectStatus').value,
                progress: parseInt(document.getElementById('editProjectProgress').value) || 0,
                deadline: document.getElementById('editProjectDeadline').value || null,
                updatedAt: new Date().toISOString()
            };
            
            // 更新AppState中的项目数据
            AppState.projects[projectIndex] = {
                ...AppState.projects[projectIndex],
                ...projectData
            };
            
            // 如果是进度滑块，更新显示
            if (event.target.id === 'editProjectProgress') {
                const progressValue = document.getElementById('progressValue');
                if (progressValue) {
                    progressValue.textContent = `${projectData.progress}%`;
                }
            }
            
            // 触发防抖保存
            debouncedProjectSave();
        }

        // 关闭项目编辑器
        function closeProjectEditor() {
            const projectEditorModal = document.getElementById('projectEditorModal');
            if (projectEditorModal) {
                projectEditorModal.classList.remove('show');
            }
            window.editingProjectId = null;
        }

        // 显示当前标签
        function displayCurrentTags(tags) {
            const container = document.getElementById('currentProjectTags');
            container.innerHTML = '';
            
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag-item';
                tagElement.innerHTML = `
                    <span>${tag}</span>
                    <button type="button" class="tag-remove" onclick="removeProjectTag('${tag}')">&times;</button>
                `;
                container.appendChild(tagElement);
            });
        }

        // 显示当前成员
        function displayCurrentMembers(members) {
            const container = document.getElementById('currentProjectMembers');
            container.innerHTML = '';
            
            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <span>${member}</span>
                    <button type="button" class="member-remove" onclick="removeProjectMember('${member}')">&times;</button>
                `;
                container.appendChild(memberElement);
            });
        }

        // 添加项目标签
        function addProjectTag() {
            const input = document.getElementById('newProjectTag');
            const tag = input.value.trim();
            
            if (tag && !getCurrentProjectTags().includes(tag)) {
                const currentTags = getCurrentProjectTags();
                currentTags.push(tag);
                displayCurrentTags(currentTags);
                input.value = '';
            }
        }

        // 移除项目标签
        function removeProjectTag(tagToRemove) {
            const currentTags = getCurrentProjectTags().filter(tag => tag !== tagToRemove);
            displayCurrentTags(currentTags);
        }

        // 获取当前标签列表
        function getCurrentProjectTags() {
            const container = document.getElementById('currentProjectTags');
            return Array.from(container.querySelectorAll('.tag-item span')).map(span => span.textContent);
        }

        // 添加项目成员
        function addProjectMember() {
            const input = document.getElementById('newProjectMember');
            const member = input.value.trim();
            
            if (member && !getCurrentProjectMembers().includes(member)) {
                const currentMembers = getCurrentProjectMembers();
                currentMembers.push(member);
                displayCurrentMembers(currentMembers);
                input.value = '';
            }
        }

        // 移除项目成员
        function removeProjectMember(memberToRemove) {
            const currentMembers = getCurrentProjectMembers().filter(member => member !== memberToRemove);
            displayCurrentMembers(currentMembers);
        }

        // 获取当前成员列表
        function getCurrentProjectMembers() {
            const container = document.getElementById('currentProjectMembers');
            return Array.from(container.querySelectorAll('.member-item span')).map(span => span.textContent);
        }

        // 保存项目更改
        async function saveProjectChanges() {
            if (!window.editingProjectId) return;
            
            const projectData = {
                name: document.getElementById('editProjectName').value.trim(),
                description: document.getElementById('editProjectDescription').value.trim(),
                status: document.getElementById('editProjectStatus').value,
                progress: parseInt(document.getElementById('editProjectProgress').value),
                deadline: document.getElementById('editProjectDeadline').value || null,
                tags: getCurrentProjectTags(),
                members: getCurrentProjectMembers()
            };
            
            // 验证必填字段
            if (!projectData.name) {
                showNotification('请输入项目名称', 'error');
                return;
            }
            
            try {
                // 更新项目数据
                const projectIndex = AppState.projects.findIndex(p => p.id === window.editingProjectId);
                if (projectIndex !== -1) {
                    // 保留原有的其他属性
                    AppState.projects[projectIndex] = {
                        ...AppState.projects[projectIndex],
                        ...projectData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // 保存到数据库
                    await saveProjectToDatabase(AppState.projects[projectIndex]);
                    
                    // 如果正在编辑当前项目，更新当前项目状态
                    if (AppState.currentProject && AppState.currentProject.id === window.editingProjectId) {
                        AppState.currentProject = AppState.projects[projectIndex];
                    }
                    
                    // 更新项目列表显示
                    updateProjectCounts();
                    if (AppState.currentView && AppState.currentView.startsWith('project-')) {
                        const status = AppState.currentView.replace('project-', '');
                        loadProjectsByStatus(status);
                    }
                    
                    // 更新首页仪表板
                    updateDashboard();
                    
                    // 关闭编辑器
                    closeProjectEditor();
                    
                    showNotification('项目更新成功', 'success');
                }
            } catch (error) {
                console.error('保存项目失败:', error);
                showNotification('保存项目失败', 'error');
            }
        }

        // 删除当前项目
        async function deleteCurrentProject() {
            if (AppState.currentProject && confirm(`确定要删除项目"${AppState.currentProject.name}"吗？`)) {
                await deleteProject(AppState.currentProject.id);
                backToProjectList();
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'planning': '待办',
                'active': '进行中',
                'completed': '已完成'
            };
            return statusMap[status] || '未知';
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // 项目概览功能

        
        function getTodayTasks() {
            const today = new Date().toDateString();
            let todayTaskCount = 0;
            
            AppState.projects.forEach(project => {
                if (project.tasks) {
                    project.tasks.forEach(task => {
                        if (task.dueDate && new Date(task.dueDate).toDateString() === today) {
                            todayTaskCount++;
                        }
                    });
                }
            });
            
            return todayTaskCount;
        }
        
        function updateRecentProjects() {
            const recentProjectsList = document.getElementById('recent-projects-list');
            const recentProjects = AppState.projects
                .sort((a, b) => new Date(b.lastModified || b.createdAt) - new Date(a.lastModified || a.createdAt))
                .slice(0, 5);
            
            if (recentProjects.length === 0) {
                recentProjectsList.innerHTML = `
                    <div class="overview-empty">
                        <i class="fas fa-folder-open"></i>
                        <p>暂无最近项目</p>
                    </div>
                `;
                return;
            }
            
            recentProjectsList.innerHTML = recentProjects.map(project => `
                <div class="overview-item" onclick="openProject('${project.id}')">
                    <div class="overview-item-icon">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div class="overview-item-content">
                        <div class="overview-item-title">${project.name}</div>
                        <div class="overview-item-meta">
                            <span class="project-status-badge ${project.status}">${getStatusText(project.status)}</span>
                            <span class="overview-item-date">${formatDate(project.lastModified || project.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function switchOverviewTab(tabName) {
            // 切换标签页
            document.querySelectorAll('.overview-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const overviewTab = document.querySelector(`[onclick="switchOverviewTab('${tabName}')"]`);
            if (overviewTab) {
                overviewTab.classList.add('active');
            }
            
            // 切换内容面板
            document.querySelectorAll('.overview-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const tabPanel = document.getElementById(tabName);
            if (tabPanel) {
                tabPanel.classList.add('active');
            }
            
            // 根据标签页加载相应内容
            if (tabName === 'project-stats') {
                updateProjectStats();
            }
        }

        function switchProjectOverviewTab(tabName) {
            // 切换标签页
            document.querySelectorAll('.overview-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const projectOverviewTab = document.querySelector(`[onclick="switchProjectOverviewTab('${tabName}')"]`);
            if (projectOverviewTab) {
                projectOverviewTab.classList.add('active');
            }
            
            // 切换内容面板
            document.querySelectorAll('.overview-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            const tabPanel = document.getElementById(tabName);
            if (tabPanel) {
                tabPanel.classList.add('active');
            }
            
            // 根据标签页加载相应内容
            updateProjectOverviewContent(tabName);
        }

        // 项目卡片按钮功能函数
        function openProjectNotes(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                // 切换到笔记页面
                navigateTo('notes');
                showNotification(`已打开项目"${project.name}"的笔记`, 'success');
            } else {
                showNotification('项目不存在', 'error');
            }
        }

        function openProjectTasks(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                // 这里可以实现任务管理功能
                showNotification(`项目"${project.name}"的任务管理功能开发中...`, 'info');
            } else {
                showNotification('项目不存在', 'error');
            }
        }

        function openProjectMembers(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                if (project.members && project.members.length > 0) {
                    const membersList = project.members.join('、');
                    showNotification(`项目"${project.name}"的成员：${membersList}`, 'info');
                } else {
                    showNotification(`项目"${project.name}"暂无成员`, 'info');
                }
            } else {
                showNotification('项目不存在', 'error');
            }
        }

        function viewProject(projectId) {
            const project = AppState.projects.find(p => p.id === projectId);
            if (project) {
                // 打开项目详情
                openProject(projectId);
            } else {
                showNotification('项目不存在', 'error');
            }
        }

        function updateProjectOverviewContent(tabName) {
            const projects = AppState.projects || [];
            let filteredProjects = [];
            let gridId = '';

            // 更新所有按钮的数字
            updateProjectTabCounts(projects);

            switch(tabName) {
                case 'total-projects':
                    filteredProjects = projects;
                    gridId = 'total-projects-grid';
                    break;
                case 'active-projects':
                    filteredProjects = projects.filter(p => p.status === 'active');
                    gridId = 'active-projects-grid';
                    break;
                case 'completed-projects':
                    filteredProjects = projects.filter(p => p.status === 'completed');
                    gridId = 'completed-projects-grid';
                    break;
                case 'today-tasks':
                    const today = new Date().toDateString();
                    filteredProjects = projects.filter(p => {
                        if (p.tasks && p.tasks.length > 0) {
                            return p.tasks.some(task => {
                                if (task.dueDate) {
                                    const taskDate = new Date(task.dueDate).toDateString();
                                    return taskDate === today && !task.completed;
                                }
                                return false;
                            });
                        }
                        return false;
                    });
                    gridId = 'today-tasks-grid';
                    break;
            }

            renderProjectOverviewGrid(filteredProjects, gridId, tabName);
        }

        function updateProjectTabCounts(projects) {
            // 计算各类项目数量
            const totalCount = projects.length;
            const activeCount = projects.filter(p => p.status === 'active').length;
            const completedCount = projects.filter(p => p.status === 'completed').length;
            
            // 计算今日任务数量
            const today = new Date().toDateString();
            let todayTasksCount = 0;
            projects.forEach(project => {
                if (project.tasks && project.tasks.length > 0) {
                    project.tasks.forEach(task => {
                        if (task.dueDate && !task.completed) {
                            const taskDate = new Date(task.dueDate).toDateString();
                            if (taskDate === today) {
                                todayTasksCount++;
                            }
                        }
                    });
                }
            });

            // 更新按钮数字显示
            const totalCountElement = document.getElementById('total-projects-count');
            const activeCountElement = document.getElementById('active-projects-count');
            const completedCountElement = document.getElementById('completed-projects-count');
            const todayTasksCountElement = document.getElementById('today-tasks-count');

            if (totalCountElement) totalCountElement.textContent = totalCount;
            if (activeCountElement) activeCountElement.textContent = activeCount;
            if (completedCountElement) completedCountElement.textContent = completedCount;
            if (todayTasksCountElement) todayTasksCountElement.textContent = todayTasksCount;
        }

        function renderProjectOverviewGrid(projects, gridId, tabName) {
            let grid = document.getElementById(gridId);
            
            // 防御性检查：如果网格不存在，尝试创建
            if (!grid) {
                console.warn(`Project grid container not found: ${gridId}, attempting to create...`);
                
                // 尝试找到项目页面容器
                const projectsPage = document.getElementById('projects-page');
                if (projectsPage) {
                    grid = document.createElement('div');
                    grid.id = gridId;
                    grid.className = 'projects-grid';
                    projectsPage.appendChild(grid);
                    console.log(`✅ Created missing project grid container: ${gridId}`);
                } else {
                    console.error(`❌ Projects page container not found`);
                    return;
                }
            }

            if (projects.length === 0) {
                const emptyMessages = {
                    'total-projects': { icon: 'fas fa-folder-open', text: '暂无项目' },
                    'active-projects': { icon: 'fas fa-play-circle', text: '暂无进行中的项目' },
                    'completed-projects': { icon: 'fas fa-check-circle', text: '暂无已完成的项目' },
                    'today-tasks': { icon: 'fas fa-calendar-day', text: '今日暂无任务' }
                };
                const message = emptyMessages[tabName] || emptyMessages['total-projects'];
                grid.innerHTML = `
                    <div class="overview-empty">
                        <i class="${message.icon}"></i>
                        <p>${message.text}</p>
                    </div>
                `;
                return;
            }

            // 使用统一的项目卡片创建函数
            grid.innerHTML = projects.map(project => createUnifiedProjectCard(project)).join('');
        }
        
        function updateProjectStats() {
            const statsContainer = document.getElementById('project-stats-list');
            const totalProjects = AppState.projects.length;
            const activeProjects = AppState.projects.filter(p => p.status === 'active').length;
            const completedProjects = AppState.projects.filter(p => p.status === 'completed').length;
            const planningProjects = AppState.projects.filter(p => p.status === 'planning').length;
            
            if (totalProjects === 0) {
                statsContainer.innerHTML = `
                    <div class="overview-empty">
                        <i class="fas fa-chart-bar"></i>
                        <p>暂无统计数据</p>
                    </div>
                `;
                return;
            }
            
            const completionRate = totalProjects > 0 ? Math.round((completedProjects / totalProjects) * 100) : 0;
            
            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-label">项目完成率</div>
                        <div class="stat-value">${completionRate}%</div>
                        <div class="stat-bar">
                            <div class="stat-progress" style="width: ${completionRate}%"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">待办项目</div>
                        <div class="stat-value">${planningProjects}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">进行中项目</div>
                        <div class="stat-value">${activeProjects}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">已完成项目</div>
                        <div class="stat-value">${completedProjects}</div>
                    </div>
                </div>
            `;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return '今天';
            } else if (diffDays === 2) {
                return '昨天';
            } else if (diffDays <= 7) {
                return `${diffDays - 1}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 页面卸载前保存
        window.addEventListener('beforeunload', function() {
            saveAppState();
        });

        // 项目编辑器功能
        function initProjectEditor() {
            // 标签页切换功能
            const editorTabs = document.querySelectorAll('.editor-tab');
            const editorContents = document.querySelectorAll('.editor-tab-content');

            editorTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.dataset.tab;
                    
                    // 移除所有活动状态
                    editorTabs.forEach(t => t.classList.remove('active'));
                    editorContents.forEach(c => c.classList.remove('active'));
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    const targetTabElement = document.getElementById(targetTab);
                    if (targetTabElement) {
                        targetTabElement.classList.add('active');
                    }
                });
            });

            // 富文本编辑器工具栏功能
            const toolbarBtns = document.querySelectorAll('.toolbar-btn');
            const editorTextarea = document.getElementById('projectContentEditor');

            toolbarBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    const value = this.dataset.value || null;
                    
                    if (command === 'insertText') {
                        insertTextAtCursor(editorTextarea, value);
                    } else if (command === 'wrapText') {
                        wrapSelectedText(editorTextarea, value);
                    }
                });
            });

            // 初始化任务管理
            initTaskManagement();
            
            // 初始化项目笔记
            initProjectNotes();
        }

        // 在光标位置插入文本
        function insertTextAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = textarea.value;
            
            textarea.value = value.substring(0, start) + text + value.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + text.length;
            textarea.focus();
        }

        // 包装选中的文本
        function wrapSelectedText(textarea, wrapper) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            if (selectedText) {
                const wrappedText = wrapper + selectedText + wrapper;
                textarea.value = textarea.value.substring(0, start) + wrappedText + textarea.value.substring(end);
                textarea.selectionStart = start + wrapper.length;
                textarea.selectionEnd = end + wrapper.length;
            } else {
                insertTextAtCursor(textarea, wrapper + wrapper);
                textarea.selectionStart = textarea.selectionEnd = start + wrapper.length;
            }
            textarea.focus();
        }

        // 任务管理功能
        function initTaskManagement() {
            // 添加任务按钮事件
            const addTaskBtns = document.querySelectorAll('.add-task-btn');
            addTaskBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const column = this.dataset.column;
                    showAddTaskModal(column);
                });
            });

            // 初始化拖拽功能
            initTaskDragAndDrop();
        }

        // 显示添加任务模态框
        function showAddTaskModal(column) {
            const title = prompt('请输入任务标题：');
            if (title) {
                const description = prompt('请输入任务描述（可选）：') || '';
                const priority = prompt('请选择优先级（high/medium/low）：') || 'medium';
                
                const task = {
                    id: Date.now().toString(),
                    title: title,
                    description: description,
                    priority: priority,
                    status: column,
                    createdAt: new Date().toISOString()
                };
                
                addTaskToColumn(task, column);
                saveProjectTasks();
            }
        }

        // 添加任务到列
        function addTaskToColumn(task, column) {
            const taskList = document.querySelector(`[data-column="${column}"] .task-list`);
            const taskElement = createTaskElement(task);
            taskList.appendChild(taskElement);
            updateTaskCount(column);
        }

        // 创建任务元素
        function createTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-item';
            taskDiv.draggable = true;
            taskDiv.dataset.taskId = task.id;
            
            taskDiv.innerHTML = `
                <div class="task-title">${task.title}</div>
                ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                <div class="task-meta">
                    <span class="task-priority ${task.priority}">${task.priority}</span>
                    <span class="task-date">${formatDate(task.createdAt)}</span>
                </div>
            `;
            
            return taskDiv;
        }

        // 初始化拖拽功能
        function initTaskDragAndDrop() {
            let draggedTask = null;
            
            document.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('task-item')) {
                    draggedTask = e.target;
                    e.target.classList.add('dragging');
                }
            });
            
            document.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('task-item')) {
                    e.target.classList.remove('dragging');
                    draggedTask = null;
                }
            });
            
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedTask && e.target.classList.contains('task-list')) {
                    const newColumn = e.target.closest('.task-column').dataset.column;
                    const oldColumn = draggedTask.closest('.task-column').dataset.column;
                    
                    if (newColumn !== oldColumn) {
                        e.target.appendChild(draggedTask);
                        updateTaskCount(oldColumn);
                        updateTaskCount(newColumn);
                        saveProjectTasks();
                    }
                }
            });
        }

        // 更新任务计数
        function updateTaskCount(column) {
            const taskList = document.querySelector(`[data-column="${column}"] .task-list`);
            const taskCount = document.querySelector(`[data-column="${column}"] .task-count`);
            const count = taskList.children.length;
            taskCount.textContent = count;
        }

        // 保存项目任务
        function saveProjectTasks() {
            const currentProject = getCurrentProject();
            if (currentProject) {
                const tasks = [];
                document.querySelectorAll('.task-item').forEach(taskElement => {
                    const column = taskElement.closest('.task-column').dataset.column;
                    const taskId = taskElement.dataset.taskId;
                    const title = taskElement.querySelector('.task-title').textContent;
                    const description = taskElement.querySelector('.task-description')?.textContent || '';
                    const priority = taskElement.querySelector('.task-priority').textContent;
                    
                    tasks.push({
                        id: taskId,
                        title: title,
                        description: description,
                        priority: priority,
                        status: column,
                        createdAt: new Date().toISOString()
                    });
                });
                
                currentProject.tasks = tasks;
                saveAppState();
                updateDashboard();
            }
        }

        // 项目笔记功能
        function initProjectNotes() {
            const addNoteBtn = document.getElementById('addNoteBtn');
            if (addNoteBtn) {
                addNoteBtn.addEventListener('click', showAddNoteModal);
            }
        }

        // 显示添加笔记模态框
        function showAddNoteModal() {
            const title = prompt('请输入笔记标题：');
            if (title) {
                const content = prompt('请输入笔记内容：') || '';
                
                const note = {
                    id: Date.now().toString(),
                    title: title,
                    content: content,
                    createdAt: new Date().toISOString()
                };
                
                addProjectNote(note);
                saveProjectNotes();
            }
        }

        // 添加项目笔记
        function addProjectNote(note) {
            const notesList = document.getElementById('projectNotesList');
            if (!notesList) {
                console.warn('项目笔记列表容器不存在，无法添加笔记');
                showNotification('笔记功能暂不可用，请联系管理员', 'error');
                return;
            }
            const noteElement = createNoteElement(note);
            notesList.appendChild(noteElement);
        }

        // 创建笔记元素
        function createNoteElement(note) {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'note-item';
            noteDiv.dataset.noteId = note.id;
            
            noteDiv.innerHTML = `
                <div class="note-header">
                    <div class="note-title">${note.title}</div>
                    <div class="note-date">${formatDate(note.createdAt)}</div>
                </div>
                <div class="note-content">${note.content}</div>
            `;
            
            return noteDiv;
        }

        // 保存项目笔记
        function saveProjectNotes() {
            const currentProject = getCurrentProject();
            if (currentProject) {
                const notes = [];
                document.querySelectorAll('.note-item').forEach(noteElement => {
                    const noteId = noteElement.dataset.noteId;
                    const title = noteElement.querySelector('.note-title').textContent;
                    const content = noteElement.querySelector('.note-content').textContent;
                    
                    notes.push({
                        id: noteId,
                        title: title,
                        content: content,
                        createdAt: new Date().toISOString()
                    });
                });
                
                currentProject.notes = notes || [];
                saveAppState();
                updateDashboard();
            }
        }

        // 获取当前项目
        function getCurrentProject() {
            // 这里需要根据实际情况获取当前正在编辑的项目
            // 可以通过URL参数、全局变量或其他方式
            return AppState.currentProject || null;
        }

        // 保存项目内容
        function saveProjectContent() {
            const currentProject = getCurrentProject();
            if (currentProject) {
                const content = document.getElementById('projectContentEditor').value;
                currentProject.content = content;
                saveAppState();
                showNotification('项目内容已保存', 'success');
            }
        }

        // 加载项目内容到编辑器
        function loadProjectContent(project) {
            if (project) {
                // 设置当前项目
                AppState.currentProject = project;
                
                // 加载项目内容
                const contentEditor = document.getElementById('projectContentEditor');
                if (contentEditor) {
                    contentEditor.value = project.content || '';
                }
                
                // 加载任务
                loadProjectTasks(project.tasks || []);
                
                // 加载笔记
                loadProjectNotes(project.notes || []);
                
                // 初始化编辑器
                initProjectEditor();
            }
        }

        // 加载项目任务
        function loadProjectTasks(tasks) {
            // 清空现有任务
            document.querySelectorAll('.task-list').forEach(list => {
                list.innerHTML = '';
            });
            
            // 添加任务
            tasks.forEach(task => {
                addTaskToColumn(task, task.status);
            });
            
            // 更新计数
            ['todo', 'inprogress', 'completed'].forEach(column => {
                updateTaskCount(column);
            });
        }

        // 加载项目笔记
        function loadProjectNotes(notes) {
            const notesList = document.getElementById('projectNotesList');
            if (!notesList) {
                console.warn('项目笔记列表容器不存在，无法加载笔记');
                return;
            }
            notesList.innerHTML = '';
            notes.forEach(note => {
                const noteElement = createNoteElement(note);
                notesList.appendChild(noteElement);
            });
        }

        // 修改showProjectDetails函数以支持编辑器
        const originalShowProjectDetails = window.showProjectDetails;
        window.showProjectDetails = function(project) {
            // 调用原始函数
            if (originalShowProjectDetails) {
                originalShowProjectDetails(project);
            }
            
            // 加载项目到编辑器
            if (project) {
                loadProjectContent(project);
            }
        };


    </script>
    
    <!-- 自定义模态对话框 -->
    <div class="custom-modal" id="customModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">输入信息</div>
            </div>
            <input type="text" class="modal-input" id="modalInput" placeholder="请输入...">
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmCustomModal()">确定</button>
            </div>
        </div>
    </div>

    <!-- 项目编辑器模态框 -->
    <div class="custom-modal" id="projectEditorModal">
        <div class="modal-content project-editor-content">
            <div class="modal-header">
                <div class="modal-title">编辑项目</div>
                <button class="modal-close" onclick="closeProjectEditor()">&times;</button>
            </div>
            <div class="project-editor-body">
                <div class="editor-section">
                    <label class="editor-label">项目名称</label>
                    <input type="text" class="editor-input" id="editProjectName" placeholder="请输入项目名称">
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">项目描述</label>
                    <textarea class="editor-textarea" id="editProjectDescription" placeholder="请输入项目描述" rows="3"></textarea>
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">项目状态</label>
                    <select class="editor-select" id="editProjectStatus">
                        <option value="planning">待办</option>
                        <option value="active">进行中</option>
                        <option value="completed">已完成</option>
                    </select>
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">项目进度</label>
                    <div class="progress-input-container">
                        <input type="range" class="progress-slider" id="editProjectProgress" min="0" max="100" value="0">
                        <span class="progress-value" id="progressValue">0%</span>
                    </div>
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">截止时间</label>
                    <input type="date" class="editor-input" id="editProjectDeadline">
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">项目标签</label>
                    <div class="tags-input-container">
                        <div class="current-tags" id="currentProjectTags"></div>
                        <div class="tag-input-row">
                            <input type="text" class="editor-input" id="newProjectTag" placeholder="输入标签名称">
                            <button type="button" class="add-tag-btn" onclick="addProjectTag()">添加</button>
                        </div>
                    </div>
                </div>
                
                <div class="editor-section">
                    <label class="editor-label">参与人员</label>
                    <div class="members-input-container">
                        <div class="current-members" id="currentProjectMembers"></div>
                        <div class="member-input-row">
                            <input type="text" class="editor-input" id="newProjectMember" placeholder="输入成员名称">
                            <button type="button" class="add-member-btn" onclick="addProjectMember()">添加</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeProjectEditor()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="saveProjectChanges()">保存</button>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="custom-modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">用户登录</div>
                <button class="modal-close" onclick="closeLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loginEmail">邮箱地址</label>
                    <input type="email" id="loginEmail" class="modal-input" placeholder="请输入邮箱地址" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" class="modal-input" placeholder="请输入密码" required>
                </div>
                <div class="form-group">
                    <div class="auth-links">
                        <span>还没有账户？</span>
                        <a href="#" onclick="switchToRegister()">立即注册</a>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeLoginModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="handleLogin(event)">登录</button>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div class="custom-modal" id="registerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">用户注册</div>
                <button class="modal-close" onclick="closeRegisterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="registerEmail">邮箱地址</label>
                    <input type="email" id="registerEmail" class="modal-input" placeholder="请输入邮箱地址" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" class="modal-input" placeholder="请输入密码（至少6位）" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" class="modal-input" placeholder="请再次输入密码" required>
                </div>
                <div class="form-group">
                    <div class="auth-links">
                        <span>已有账户？</span>
                        <a href="#" onclick="switchToLogin()">立即登录</a>
                        <br><br>
                        <a id="resendConfirmLink" class="resend-confirm-link" href="#" onclick="resendConfirmation()" style="font-size: 12px; color: #666;">重新发送确认邮件</a>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeRegisterModal()">取消</button>
                <button class="modal-btn modal-btn-confirm" onclick="handleRegister()">注册</button>
            </div>
        </div>
    </div>

    <!-- 用户管理模态框 -->
    <div class="custom-modal" id="adminPanelModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">用户管理</div>
                <button class="modal-close" onclick="closeAdminPanel()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="adminError" style="display:none; color: var(--danger-color); margin-bottom: 8px;"></div>
                <div id="adminSummary" style="display:flex; gap: 12px; align-items:center; color: var(--text-secondary); font-size: 14px; margin-bottom: 10px;">
                    <div>用户总数: <strong id="totalUsersCount">-</strong></div>
                    <div>角色分布: <span id="roleStats">-</span></div>
                </div>
                <div style="overflow:auto; max-height: 50vh; border: 1px solid var(--border-color); border-radius: 8px;">
                    <table style="width:100%; border-collapse: collapse;">
                        <thead style="position: sticky; top:0; background: var(--bg-secondary); z-index:1;">
                            <tr>
                                <th style="text-align:left; padding: 8px; border-bottom: 1px solid var(--border-color);">昵称</th>
                                <th style="text-align:left; padding: 8px; border-bottom: 1px solid var(--border-color);">邮箱</th>
                                <th style="text-align:left; padding: 8px; border-bottom: 1px solid var(--border-color);">角色</th>
                                <th style="text-align:left; padding: 8px; border-bottom: 1px solid var(--border-color);">最后活跃</th>
                                <th style="text-align:left; padding: 8px; border-bottom: 1px solid var(--border-color);">操作</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTbody">
                            <tr><td colspan="5" style="text-align:center; color: #888; padding: 12px;">正在加载用户数据...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeAdminPanel()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 数据库 API -->
    <script src="utils/database.js?v=20241014"></script>
    <script src="utils/migration.js"></script>
<script src="utils/onboarding.js"></script>
<script src="utils/offline-cache.js"></script>
<script src="utils/data-migration.js"></script>
<script src="utils/backup-restore.js"></script>

<!-- Service Worker 注册 -->
<script>
// Service Worker 注册和管理
(function() {
    // 暂时禁用Service Worker注册以避免iframe问题
    console.log('Service Worker注册已暂时禁用');
    return;
    
    // 检查是否在iframe中运行
    if (window !== window.top) {
        console.log('在iframe中运行，跳过Service Worker注册');
        return;
    }
    
    // 检查Service Worker支持
    if (!('serviceWorker' in navigator)) {
        console.log('浏览器不支持Service Worker');
        return;
    }
    
    // 检查是否为安全环境
    const isSecure = window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' ||
                   window.location.hostname === '127.0.0.1';
    
    if (!isSecure) {
        console.warn('Service Worker需要HTTPS环境，跳过注册');
        return;
    }
    
    // 等待文档完全加载并检查状态
    const registerServiceWorker = async () => {
        try {
            // 检查文档状态
            if (document.readyState !== 'complete') {
                console.log('等待文档完全加载...');
                await new Promise(resolve => {
                    if (document.readyState === 'complete') {
                        resolve();
                    } else {
                        window.addEventListener('load', resolve, { once: true });
                    }
                });
            }
            
            // 额外等待确保所有资源加载完成
            await new Promise(resolve => setTimeout(resolve, 100));
            
            console.log('开始注册Service Worker...');
            console.log('文档状态:', document.readyState);
            
            // 注册 Service Worker
            const registration = await navigator.serviceWorker.register('./sw.js', {
                scope: './'
            });
            
            console.log('Service Worker 注册成功:', registration.scope);
            
            // 监听 Service Worker 更新
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                console.log('发现新的 Service Worker');
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        console.log('新的 Service Worker 已安装，等待激活');
                        // 可以在这里提示用户刷新页面
                    }
                });
            });
            
            // 监听 Service Worker 控制器变化
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Service Worker 控制器已更改');
                // 页面现在由新的 Service Worker 控制
            });
            
            // 监听来自 Service Worker 的消息
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('收到来自 Service Worker 的消息:', event.data);
            });
            
        } catch (error) {
            console.error('Service Worker 注册失败:', error);
            // 根据错误类型提供更具体的信息
            if (error.name === 'InvalidStateError') {
                console.error('文档状态无效，可能是页面还在加载中');
            } else if (error.name === 'SecurityError') {
                console.error('安全错误，可能需要HTTPS环境');
            } else if (error.name === 'TypeError') {
                console.error('类型错误，可能是Service Worker文件路径问题');
            }
        }
    };
    
    // 调用Service Worker注册
    if (document.readyState === 'complete') {
        registerServiceWorker();
    } else {
        window.addEventListener('load', registerServiceWorker, { once: true });
    }
    
    // 提供清除缓存的全局函数
    window.clearServiceWorkerCache = async function() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.ready;
                if (registration.active) {
                    const messageChannel = new MessageChannel();
                    
                    return new Promise((resolve, reject) => {
                        messageChannel.port1.onmessage = (event) => {
                            if (event.data.success) {
                                console.log('Service Worker 缓存已清除');
                                resolve();
                            } else {
                                console.error('清除 Service Worker 缓存失败:', event.data.error);
                                reject(new Error(event.data.error));
                            }
                        };
                        
                        registration.active.postMessage(
                            { type: 'CLEAR_CACHE' },
                            [messageChannel.port2]
                        );
                    });
                }
            } catch (error) {
                console.error('清除 Service Worker 缓存失败:', error);
                throw error;
            }
        }
    };
})();

// 全局UI状态重置函数
window.resetUIState = function() {
    console.log('🔄 开始重置全局UI状态');
    
    try {
        // 重置登录状态标志
        window.isLoggingIn = false;
        
        // 关闭所有模态框
        const modals = document.querySelectorAll('.custom-modal');
        modals.forEach(modal => {
            modal.classList.remove('show');
            // 清除内联样式，让CSS类完全控制
            modal.style.display = '';
            modal.style.visibility = '';
            modal.style.transform = '';
            modal.style.opacity = '';
        });
        
        // 重置所有按钮状态
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            button.disabled = false;
            button.style.pointerEvents = 'auto';
            button.style.opacity = '1';
            button.classList.remove('loading', 'success');
        });
        
        // 特别重置登录按钮
        const loginBtn = document.querySelector('#loginModal .modal-btn-confirm');
        if (loginBtn) {
            resetLoginButton(loginBtn);
        }
        
        // 清空所有表单
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.reset();
        });
        
        // 清空登录表单
        const emailInput = document.getElementById('loginEmail');
        const passwordInput = document.getElementById('loginPassword');
        if (emailInput) emailInput.value = '';
        if (passwordInput) passwordInput.value = '';
        
        console.log('✅ 全局UI状态重置完成');
        
        // 显示重置完成通知
        if (typeof showNotification === 'function') {
            showNotification('UI状态已重置', 'success');
        }
        
    } catch (error) {
        console.error('❌ 重置UI状态时出错:', error);
    }
};

// 添加键盘快捷键 Ctrl+Shift+R 来重置UI状态
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'R') {
        e.preventDefault();
        console.log('🔄 检测到快捷键 Ctrl+Shift+R，重置UI状态');
        window.resetUIState();
    }
});

// 在页面加载完成后自动重置一次UI状态
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        window.resetUIState();
        console.log('📱 页面加载完成，已自动重置UI状态');
    }, 1000);
});

// ===== 管理面板功能 =====
function updateAdminMenuVisibility() {
    try {
        const role = (window.currentUserRole || (window.AppState && AppState.userRole) || (window.AppState && AppState.user && AppState.user.role) || 'guest');
        const adminBtn = document.getElementById('adminMenuBtn');
        const adminDivider = document.getElementById('adminDivider');
        if (!adminBtn || !adminDivider) return;
        // 使用 isAdmin() 进行更稳健的判断（支持邮箱白名单与角色），无该函数时回退到角色判断
        const visible = (typeof isAdmin === 'function') ? isAdmin(role) : (role === 'owner' || role === 'admin');
        adminBtn.style.display = visible ? 'block' : 'none';
        adminDivider.style.display = visible ? 'block' : 'none';
        console.log('👮 管理入口可见性：', visible, '角色=', role);
    } catch (e) {
        console.warn('更新管理入口可见性失败:', e);
    }
}

async function openAdminPanel() {
    const modal = document.getElementById('adminPanelModal');
    const tbody = document.getElementById('adminUsersTbody');
    const errEl = document.getElementById('adminError');
    const statsEl = document.getElementById('roleStats');
    const totalEl = document.getElementById('totalUsersCount');
    if (modal) { modal.style.display = 'block'; }
    if (tbody) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #888; padding: 12px;">正在加载用户数据...</td></tr>'; }
    if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }

    const role = (window.currentUserRole || (window.AppState && AppState.userRole) || (window.AppState && AppState.user && AppState.user.role) || 'guest');
    if (!(role === 'owner' || role === 'admin')) {
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger-color); padding:12px;">权限不足：仅 owner/admin 可访问。</td></tr>';
        if (totalEl) totalEl.textContent = '0';
        if (statsEl) statsEl.textContent = '-';
        return;
    }

    let client;
    try { client = getSupabaseClientOptimized(); } catch (e) {}
    if (!client) {
        const msg = '无法获取 Supabase 客户端';
        if (errEl) { errEl.textContent = msg; errEl.style.display = 'block'; }
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger-color); padding:12px;">' + msg + '</td></tr>';
        return;
    }

    try {
        const { data, error } = await client
            .from('user_profiles')
            .select('id,email,display_name,role,updated_at')
            .order('updated_at', { ascending: false });

        if (error) throw error;
        const users = Array.isArray(data) ? data : [];
        if (totalEl) totalEl.textContent = String(users.length);

        const counts = {};
        users.forEach(u => { const r = u.role || 'member'; counts[r] = (counts[r] || 0) + 1; });
        if (statsEl) statsEl.textContent = Object.keys(counts).map(k => k + ': ' + counts[k]).join('，') || '-';

        if (tbody) {
            tbody.innerHTML = users.length ? users.map(u => `
            <tr>
                <td style="padding:8px;">${u.display_name || '-'}</td>
                <td style="padding:8px;">${u.email || '-'}</td>
                <td style="padding:8px;">${getRoleBadge(u.role || 'member')}</td>
                <td style="padding:8px;">${formatDate(u.updated_at)}</td>
                <td style="padding:8px;">
                    <button class="btn btn-secondary" style="padding:4px 8px; font-size:12px;" onclick="viewUserDetail('${u.id}')">详情</button>
                </td>
            </tr>
            `).join('') : '<tr><td colspan="5" style="text-align:center; color:#888; padding: 12px;">暂无数据</td></tr>';
        }
    } catch (err) {
        console.error('加载用户列表失败:', err);
        const tip = '加载失败，可能是RLS策略限制。请在 Supabase 为 user_profiles 添加管理员读取策略或使用服务端接口（服务角色密钥）进行查询。';
        if (errEl) { errEl.textContent = tip; errEl.style.display = 'block'; }
        if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger-color); padding:12px;">' + (err && err.message ? err.message : tip) + '</td></tr>';
        if (totalEl) totalEl.textContent = '-';
        if (statsEl) statsEl.textContent = '-';
    }
}

function closeAdminPanel() {
    const modal = document.getElementById('adminPanelModal');
    if (modal) modal.style.display = 'none';
}

function getRoleBadge(role) {
    const styles = {
        owner: 'background:#ffefef;color:#c62828;border:1px solid #c62828;',
        admin: 'background:#fff5e6;color:#b96500;border:1px solid #b96500;',
        member: 'background:#eef6ff;color:#1565c0;border:1px solid #1565c0;',
        guest: 'background:#f0f0f0;color:#555;border:1px solid #aaa;'
    };
    const style = styles[role] || styles.member;
    return `<span style="padding:2px 6px; border-radius:12px; font-size:12px; ${style}">${role}</span>`;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    try { return new Date(dateStr).toLocaleString(); } catch { return dateStr; }
}

function viewUserDetail(userId) {
    // 简化版：弹出 ID，实际项目可扩展到详细侧边栏或二级模态
    alert('用户ID: ' + userId);
}

// 绑定事件与初始化可见性
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', function() {
        const adminBtn = document.getElementById('adminMenuBtn');
        if (adminBtn) adminBtn.addEventListener('click', openAdminPanel);
        const modal = document.getElementById('adminPanelModal');
        if (modal) modal.addEventListener('click', function(e) { if (e.target === modal) closeAdminPanel(); });
        updateAdminMenuVisibility();
    });
}

console.log('🔧 全局UI重置功能已加载');
</script>

<!-- 生产环境修复脚本 -->
<script src="production-fixes.js?v=1"></script>

</body>
</html>